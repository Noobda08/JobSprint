<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>JobSprint Onboarding</title>

  <!-- Font & Style -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background: linear-gradient(120deg, #FFF6EC, #FFE0C8);
      overflow-x: hidden;
      color: #333;
    }
    .floating {
      position: absolute;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      animation: float 12s infinite ease-in-out;
      pointer-events: none;
      z-index: 0;
    }
    @keyframes float {
      0%,100% { transform: translateY(0) rotate(0); }
      50% { transform: translateY(-30px) rotate(20deg); }
    }
    .container {
      position: relative;
      z-index: 1;
      max-width: 720px;
      margin: 60px auto;
      background: rgba(255,255,255,0.9);
      border-radius: 24px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.08);
      padding: 40px 50px;
      text-align: left;
      transition: all 0.4s ease;
    }
    h1 { margin-top: 0; color: #222; font-size: 28px; }
    p.sub { color: #555; margin-top: 4px; font-size: 15px; }
    label { display: block; margin: 16px 0 6px; font-weight: 600; }
    input, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: inherit;
      font-size: 15px;
    }
    input:focus, textarea:focus {
      outline: none; border-color: #ffb36b;
      box-shadow: 0 0 0 2px rgba(255, 179, 107, 0.3);
    }
    textarea { resize: vertical; min-height: 90px; }
    button {
      background: #ff9a4f;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      margin-top: 24px;
      transition: background 0.3s;
    }
    button:hover { background: #ff7c1f; }
    .hidden { display: none; }
    .step-indicator {
      text-align: right;
      font-size: 13px;
      color: #777;
      margin-bottom: 20px;
    }
    .footer-note {
      text-align: center;
      font-size: 13px;
      color: #666;
      margin-top: 24px;
      opacity: 0.8;
    }
    .animate-fade {
      animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

  <!-- floating doodles -->
  <div class="floating" style="width:100px;height:100px;top:80px;left:60px;animation-delay:0s;"></div>
  <div class="floating" style="width:80px;height:80px;bottom:100px;right:120px;animation-delay:4s;"></div>
  <div class="floating" style="width:60px;height:60px;top:200px;right:50px;animation-delay:2s;"></div>

  <div class="container animate-fade" id="step1">
    <div class="step-indicator">Step 1 of 2</div>
    <h1>Let‚Äôs start with your basics üå±</h1>
    <p class="sub">Upload your resume and I‚Äôll fill what I can. You can edit anything anytime.</p>

    <label>Upload Resume (PDF/DOCX)</label>
    <input type="file" id="resume_file" accept=".pdf,.doc,.docx" />

    <label>Full Name</label>
    <input type="text" id="name" placeholder="Your full name" />

    <label>Email</label>
    <input type="email" id="email" placeholder="you@example.com" />

    <label>Phone</label>
    <input type="text" id="phone" placeholder="+91 9876543210" />

    <label>City</label>
    <input type="text" id="city" placeholder="Your city" />

    <label>Date of Birth</label>
    <input type="date" id="dob" />

    <label>Current Role</label>
    <input type="text" id="role" placeholder="e.g., Product Manager" />

    <label>Total Experience (years)</label>
    <input type="number" id="experience" min="0" placeholder="e.g., 5" />

    <button id="nextBtn">Next: Tell your story ‚Üí</button>
  </div>

  <div class="container hidden animate-fade" id="step2">
    <div class="step-indicator">Step 2 of 2</div>
    <h1>Now, let‚Äôs talk about <em>you</em> üåª</h1>
    <p class="sub">Don‚Äôt overthink ‚Äî just answer from the heart.</p>

    <label>Your career story so far</label>
    <textarea id="journey" placeholder="How did you get where you are today?"></textarea>

    <label>Your top 2‚Äì3 strengths</label>
    <textarea id="strengths" placeholder="e.g., curiosity, discipline, creativity"></textarea>

    <label>Work that energizes you</label>
    <textarea id="flow" placeholder="What kind of problems do you love solving?"></textarea>

    <label>Your next role / dream job</label>
    <textarea id="nextRole" placeholder="What do you want to do next?"></textarea>

    <label>Your long-term career vision</label>
    <textarea id="vision" placeholder="How do you see yourself growing in 5 years?"></textarea>

    <button id="backBtn">‚Üê Back</button>
    <button id="finishBtn">Finish Setup</button>
  </div>

  <p class="footer-note">We believe every job seeker deserves structure, clarity, and calm. üå§Ô∏è</p>

  <script>
    const params = new URLSearchParams(location.search);
    let googleId = params.get('google_id');
    const paymentId = params.get('payment_id');
    const finishBtn = document.getElementById('finishBtn');

    let storedProfileGoogleId = null;
    try {
      const storedProfile = localStorage.getItem('jobsprint_profile');
      if (storedProfile) {
        storedProfileGoogleId = JSON.parse(storedProfile)?.google_id || null;
      }
    } catch (err) {
      console.warn('Could not read stored profile from localStorage', err);
    }

    if (!googleId && storedProfileGoogleId) {
      googleId = storedProfileGoogleId;
    }

    if (!googleId) {
      if (finishBtn) {
        finishBtn.disabled = true;
        finishBtn.innerText = 'Redirecting...';
        finishBtn.style.opacity = '0.6';
        finishBtn.style.cursor = 'not-allowed';
      }
      const notice = document.createElement('div');
      notice.textContent = 'Please sign in with Google to finish onboarding. Redirecting you to sign-up to authenticate.';
      notice.style.position = 'fixed';
      notice.style.top = '20px';
      notice.style.right = '20px';
      notice.style.padding = '16px 20px';
      notice.style.background = '#333';
      notice.style.color = '#fff';
      notice.style.borderRadius = '12px';
      notice.style.boxShadow = '0 8px 24px rgba(0,0,0,0.18)';
      notice.style.zIndex = '1000';
      notice.style.maxWidth = '320px';
      notice.style.fontSize = '14px';
      notice.style.lineHeight = '1.4';
      document.body.appendChild(notice);

      const redirectParams = new URLSearchParams();
      if (paymentId) redirectParams.set('payment_id', paymentId);
      const emailParam = params.get('email');
      if (emailParam) redirectParams.set('email', emailParam);
      const redirectQuery = redirectParams.toString();
      const redirectUrl = `/signup.html${redirectQuery ? `?${redirectQuery}` : ''}`;
      setTimeout(() => {
        window.location.replace(redirectUrl);
      }, 1200);
    }
    let uploadedResume = { path: null, publicUrl: null };

    // Step navigation
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    document.getElementById('nextBtn').onclick = () => {
      step1.classList.add('hidden');
      step2.classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    };
    document.getElementById('backBtn').onclick = () => {
      step2.classList.add('hidden');
      step1.classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    };

    // Simulate resume parsing
    document.getElementById('resume_file').addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const fd = new FormData();
    fd.append('file', file);
    if (googleId) fd.append('google_id', googleId);
    const emailFromParams = params.get('email') || document.getElementById('email').value.trim();
    if (emailFromParams) fd.append('email', emailFromParams);

    try {
      const r = await fetch('/api/parse-resume', { method: 'POST', body: fd });
      const j = await r.json();
      if (!r.ok || !j.success) {
        const reason = j?.detail || j?.error || 'Use PDF/DOCX or fill manually.';
        alert(`Could not parse resume. ${reason}`);
        return;
      }
      const f = j.fields || {};
      const resumeMeta = j.resume || {};
      uploadedResume = {
        path: resumeMeta.path || null,
        publicUrl: resumeMeta.public_url || null
      };
      if (f.name) document.getElementById('name').value = f.name;
      if (f.email) document.getElementById('email').value = f.email;
      if (f.phone) document.getElementById('phone').value = f.phone;
      if (f.city) document.getElementById('city').value = f.city;
      if (f.dob) document.getElementById('dob').value = f.dob;
      if (f.role) document.getElementById('role').value = f.role;
      if (typeof f.experience === 'number') document.getElementById('experience').value = f.experience;

      const confidence = f._confidence || j.parsed?._confidence;
      const profileHints = f.profiles || j.parsed?.profiles;
      console.info('Resume parse confidence', confidence);
      if (profileHints?.linkedin) console.info('LinkedIn detected:', profileHints.linkedin);
      if (profileHints?.github) console.info('GitHub detected:', profileHints.github);

      alert('‚ú® Resume parsed with advanced heuristics! Review and adjust if needed.');
    }
    catch (err)
    {
      console.error(err);
      alert('Parsing failed. Please fill fields manually.');
    }
});
       
    // document.getElementById('resume_file').addEventListener('change', () => {
    //   setTimeout(() => {
    //     document.getElementById('name').value = "Alex Jobseeker";
    //     document.getElementById('email').value = "alex@example.com";
    //     document.getElementById('phone').value = "+91 9876543210";
    //     document.getElementById('city').value = "Bangalore";
    //     document.getElementById('dob').value = "1996-05-12";
    //     document.getElementById('role').value = "Product Manager";
    //     document.getElementById('experience').value = 5;
    //     alert("‚ú® Resume parsed successfully! Dummy data filled.");
    //   }, 800);
    // });

    // Finish onboarding
    document.getElementById('finishBtn').onclick = async () => {
      const google_id = googleId;
      const payment_id = paymentId;
      const emailInput = document.getElementById('email').value.trim();
      const emailParam = params.get('email');
      const email = emailInput || (emailParam ? emailParam.trim() : '');
      const name = document.getElementById('name').value.trim();
      const dobValue = document.getElementById('dob').value.trim();

      if (!google_id) {
        alert('Please sign in with Google to finish onboarding.');
        finishBtn.disabled = false;
        finishBtn.innerText = "Finish Setup";
        return;
      }
      if (!email) {
        alert('Please add your email so we can keep in touch.');
        finishBtn.disabled = false;
        finishBtn.innerText = "Finish Setup";
        return;
      }
      if (!name) {
        alert('Please share your full name so we can personalize your workspace.');
        return;
      }
      if (!dobValue) {
        alert('Please provide your date of birth so we can finalize your profile.');
        return;
      }
      if (Number.isNaN(Date.parse(dobValue))) {
        alert('Your date of birth looks invalid. Please use the format YYYY-MM-DD.');
        return;
      }

      const normalize = (value) => {
        const trimmed = typeof value === 'string' ? value.trim() : value;
        return trimmed === '' || trimmed === undefined ? undefined : trimmed;
      };

      const phone = normalize(document.getElementById('phone').value);
      const city = normalize(document.getElementById('city').value);
      const role = normalize(document.getElementById('role').value);
      const experienceRaw = document.getElementById('experience').value;
      const experience = experienceRaw === '' ? undefined : Number(experienceRaw);
      if (experience !== undefined && Number.isNaN(experience)) {
        alert('Total experience must be a number.');
        return;
      }

      const careerStoryEntries = {
        journey: normalize(document.getElementById('journey').value),
        strengths: normalize(document.getElementById('strengths').value),
        flow_state_work: normalize(document.getElementById('flow').value),
        current_vs_next: normalize(document.getElementById('nextRole').value),
        long_term_vision: normalize(document.getElementById('vision').value)
      };
      const career_story = Object.fromEntries(
        Object.entries(careerStoryEntries).filter(([, value]) => value !== undefined)
      );

      const payload = {
        google_id,
        email,
        name,
        payment_id,
        dob: dobValue,
        plan_start: new Date().toISOString().slice(0,10),
        plan_end: new Date(Date.now() + 90*24*60*60*1000).toISOString().slice(0,10),
        profile_complete: true,
        onboarding_step: 'done'
      };

      if (phone !== undefined) payload.phone = phone;
      if (city !== undefined) payload.city = city;
      if (role !== undefined) payload.role = role;
      if (experience !== undefined) payload.experience = experience;

      const resumeUrl = uploadedResume.publicUrl || uploadedResume.path || undefined;
      if (resumeUrl) payload.resume_url = resumeUrl;

      if (Object.keys(career_story).length > 0) {
        payload.career_story = career_story;
      }

      finishBtn.disabled = true;
      finishBtn.innerText = "Saving...";

      try {
        const resp = await fetch('/api/create-user', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.success) {
          console.error(data);
          const detailMessage = data?.detail || data?.error;
          const message = detailMessage ? `Could not save your onboarding. ${detailMessage}` : 'Could not save your onboarding. Please try again.';
          alert(message);
          finishBtn.disabled = false;
          finishBtn.innerText = "Finish Setup";
          return;
        }
        alert("üéâ Onboarding complete! Redirecting...");
        window.location.href = data.redirect_url || "/workspace.html";
      } catch (err) {
        console.error(err);
        alert("Something went wrong. Please try again.");
        finishBtn.disabled = false;
        finishBtn.innerText = "Finish Setup";
      }
    };
  </script>
</body>
</html>
