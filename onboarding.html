<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>JobSprint Onboarding</title>

  <!-- Font & Style -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles/theme.css" />
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter',system-ui,-apple-system,'Segoe UI',sans-serif;color:var(--ink);background:transparent;overflow-x:hidden}
    .floating{position:absolute;background:rgba(13,110,253,0.12);border-radius:50%;animation:float 14s ease-in-out infinite;pointer-events:none;z-index:0}
    .floating:nth-of-type(1){width:160px;height:160px;top:12vh;left:8vw}
    .floating:nth-of-type(2){width:110px;height:110px;bottom:12vh;right:12vw;animation-delay:-4s}
    .floating:nth-of-type(3){width:90px;height:90px;top:48vh;right:24vw;animation-delay:-8s}
    @keyframes float{0%,100%{transform:translate3d(0,0,0)}50%{transform:translate3d(14px,-18px,0)}}
    .page-shell{position:relative;z-index:1;max-width:880px;margin:0 auto;padding:72px 24px 120px}
    .stage-card{background:rgba(255,255,255,0.9);border-radius:28px;border:1px solid rgba(10,102,194,0.16);box-shadow:var(--shadow-sm);padding:48px 56px;margin-bottom:32px;backdrop-filter:blur(12px)}
    .stage-card header{margin-bottom:24px}
    h1{margin:0;font-size:30px;font-weight:700;color:var(--ink)}
    p.sub{margin:8px 0 0;color:var(--muted);font-size:15px;line-height:1.6}
    label{display:block;margin:18px 0 8px;font-weight:600;color:var(--ink)}
    textarea{resize:vertical;min-height:110px}
    .field-hint{font-size:13px;color:var(--muted);margin-top:6px}
    .field-hint a{color:var(--brand);text-decoration:none}
    .field-hint a:hover{text-decoration:underline}
    .actions{display:flex;gap:12px;margin-top:32px;flex-wrap:wrap}
    .primary-btn{background:linear-gradient(135deg,var(--brand),var(--brand-accent));color:#fff;border:none;border-radius:14px;padding:12px 22px;font-weight:600;font-size:15px;cursor:pointer;box-shadow:var(--shadow-sm);transition:transform .2s ease,box-shadow .2s ease}
    .primary-btn:hover{transform:translateY(-1px);box-shadow:0 18px 32px rgba(10,102,194,0.2)}
    .ghost-btn{background:rgba(255,255,255,0.85);color:var(--brand-strong);border:1px solid rgba(10,102,194,0.16);border-radius:14px;padding:12px 22px;font-weight:600;font-size:15px;cursor:pointer;transition:background .2s ease,box-shadow .2s ease}
    .ghost-btn:hover{background:rgba(10,102,194,0.08);box-shadow:0 10px 22px rgba(10,102,194,0.12)}
    .back-to-workspace{position:fixed;top:24px;right:24px;background:rgba(255,255,255,0.92);color:var(--brand-strong);border:1px solid rgba(10,102,194,0.2);border-radius:999px;padding:10px 18px;font-weight:600;font-size:13px;cursor:pointer;box-shadow:var(--shadow-sm);z-index:10;transition:transform .2s ease,box-shadow .2s ease}
    .back-to-workspace:hover{transform:translateY(-1px);box-shadow:0 16px 30px rgba(10,102,194,0.18)}
    .hidden{display:none}
    .step-indicator{text-align:right;font-size:13px;color:var(--muted);margin-bottom:24px;font-weight:600}
    .footer-note{text-align:center;font-size:13px;color:var(--muted);margin-top:24px}
    .section-title{margin-top:32px;font-size:18px;font-weight:700;color:var(--ink)}
    .dual-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:18px}
    @media(max-width:720px){.stage-card{padding:36px 24px}.dual-grid{grid-template-columns:1fr}.back-to-workspace{right:16px} .page-shell{padding-top:110px}}
  </style>
</head>
<body>

  <button id="backToWorkspace" class="back-to-workspace hidden">‚Üê Back to workspace</button>

  <!-- floating doodles -->
  <div class="floating" style="animation-delay:0s;"></div>
  <div class="floating" style="animation-delay:-4s;"></div>
  <div class="floating" style="animation-delay:-8s;"></div>

  <div class="page-shell">
  <section class="stage-card animate-fade" id="step1">
    <div class="step-indicator">Step 1 of 2</div>
    <h1>Let‚Äôs start with your basics üå±</h1>
    <p class="sub">Upload your resume and I‚Äôll fill what I can. You can edit anything anytime.</p>

    <label>Upload Resume (PDF/DOCX)</label>
    <input type="file" id="resume_file" accept=".pdf,.doc,.docx" />
    <div id="resumeStatus" class="field-hint"></div>

    <label>Full Name</label>
    <input type="text" id="name" placeholder="Your full name" />

    <label>Email</label>
    <input type="email" id="email" placeholder="you@example.com" />

    <label>Phone</label>
    <input type="text" id="phone" placeholder="+91 9876543210" />

    <label>City</label>
    <input type="text" id="city" placeholder="Your city" />

    <label>Date of Birth</label>
    <input type="date" id="dob" />

    <label>Current Role</label>
    <select id="role">
      <option value="">Select your current role</option>
      <optgroup label="Product, Design &amp; Strategy">
        <option value="Product Manager">Product Manager</option>
        <option value="Associate Product Manager">Associate Product Manager</option>
        <option value="Senior Product Manager">Senior Product Manager</option>
        <option value="Product Owner / Scrum Lead">Product Owner / Scrum Lead</option>
        <option value="Product Analyst">Product Analyst</option>
        <option value="Systems Analyst">Systems Analyst</option>
        <option value="UX / UI Designer">UX / UI Designer</option>
        <option value="Product Designer">Product Designer</option>
        <option value="UX Researcher">UX Researcher</option>
        <option value="Design Lead / Creative Director">Design Lead / Creative Director</option>
        <option value="Business Analyst">Business Analyst</option>
        <option value="Strategy / Management Consultant">Strategy / Management Consultant</option>
      </optgroup>
      <optgroup label="Engineering &amp; Technology (Software)">
        <option value="Frontend Developer">Frontend Developer</option>
        <option value="Backend Developer">Backend Developer</option>
        <option value="Full-Stack Developer">Full-Stack Developer</option>
        <option value="Software Engineer">Software Engineer</option>
        <option value="DevOps / Cloud Engineer">DevOps / Cloud Engineer</option>
        <option value="Mobile App Developer">Mobile App Developer</option>
        <option value="QA Engineer / Test Automation Engineer">QA Engineer / Test Automation Engineer</option>
        <option value="Data Engineer">Data Engineer</option>
        <option value="Data Scientist / ML Engineer">Data Scientist / ML Engineer</option>
        <option value="AI / Prompt Engineer">AI / Prompt Engineer</option>
        <option value="Solution Architect">Solution Architect</option>
        <option value="Tech Lead / Engineering Manager">Tech Lead / Engineering Manager</option>
      </optgroup>
      <optgroup label="Core Engineering &amp; Manufacturing">
        <option value="Mechanical Engineer">Mechanical Engineer</option>
        <option value="Electrical Engineer">Electrical Engineer</option>
        <option value="Electronics / Instrumentation Engineer">Electronics / Instrumentation Engineer</option>
        <option value="Civil Engineer">Civil Engineer</option>
        <option value="Structural Engineer">Structural Engineer</option>
        <option value="Chemical Engineer">Chemical Engineer</option>
        <option value="Production / Manufacturing Engineer">Production / Manufacturing Engineer</option>
        <option value="Quality Engineer / QA-QC">Quality Engineer / QA-QC</option>
        <option value="Maintenance Engineer">Maintenance Engineer</option>
        <option value="Plant Operations Manager">Plant Operations Manager</option>
        <option value="R&amp;D Engineer / Design Engineer">R&amp;D Engineer / Design Engineer</option>
        <option value="Industrial Engineer">Industrial Engineer</option>
      </optgroup>
      <optgroup label="Data, Analytics &amp; Finance">
        <option value="Data Analyst">Data Analyst</option>
        <option value="Business Intelligence (BI) Developer">Business Intelligence (BI) Developer</option>
        <option value="Financial Analyst">Financial Analyst</option>
        <option value="FP&amp;A / Finance Manager">FP&amp;A / Finance Manager</option>
        <option value="Investment / Equity Analyst">Investment / Equity Analyst</option>
        <option value="Risk / Credit Analyst">Risk / Credit Analyst</option>
      </optgroup>
      <optgroup label="Customer, Operations &amp; Support">
        <option value="Customer Success Manager">Customer Success Manager</option>
        <option value="Client Relationship Manager">Client Relationship Manager</option>
        <option value="Product Support Specialist">Product Support Specialist</option>
        <option value="Technical Support Engineer">Technical Support Engineer</option>
        <option value="Operations Executive / Operations Manager">Operations Executive / Operations Manager</option>
        <option value="Process / Quality Analyst">Process / Quality Analyst</option>
        <option value="Project Coordinator / Project Manager">Project Coordinator / Project Manager</option>
        <option value="Supply-Chain / Logistics Executive">Supply-Chain / Logistics Executive</option>
        <option value="Procurement / Vendor Manager">Procurement / Vendor Manager</option>
      </optgroup>
      <optgroup label="Marketing, Sales &amp; Growth">
        <option value="Digital Marketing Specialist">Digital Marketing Specialist</option>
        <option value="Performance Marketing Manager">Performance Marketing Manager</option>
        <option value="SEO / Content Strategist">SEO / Content Strategist</option>
        <option value="Growth Marketer / Growth PM">Growth Marketer / Growth PM</option>
        <option value="Brand Manager">Brand Manager</option>
        <option value="Product Marketing Manager">Product Marketing Manager</option>
        <option value="Sales Executive / Account Executive">Sales Executive / Account Executive</option>
        <option value="Business Development Manager">Business Development Manager</option>
        <option value="Inside Sales / Lead Gen Specialist">Inside Sales / Lead Gen Specialist</option>
        <option value="Key Account Manager">Key Account Manager</option>
        <option value="Partnership / Alliances Manager">Partnership / Alliances Manager</option>
      </optgroup>
      <optgroup label="HR, Talent &amp; Admin">
        <option value="HR Executive / HR Manager">HR Executive / HR Manager</option>
        <option value="Talent Acquisition Specialist">Talent Acquisition Specialist</option>
        <option value="L&amp;D / Training Specialist">L&amp;D / Training Specialist</option>
        <option value="People Operations">People Operations</option>
        <option value="Office Admin / EA / Operations Coordinator">Office Admin / EA / Operations Coordinator</option>
      </optgroup>
      <optgroup label="IT, Security &amp; Infra">
        <option value="System Administrator">System Administrator</option>
        <option value="Network Engineer">Network Engineer</option>
        <option value="IT Support Engineer">IT Support Engineer</option>
        <option value="Cybersecurity Analyst">Cybersecurity Analyst</option>
        <option value="Infrastructure Engineer">Infrastructure Engineer</option>
      </optgroup>
      <optgroup label="Education, Content &amp; Training">
        <option value="Instructional Designer">Instructional Designer</option>
        <option value="Content Writer / Editor">Content Writer / Editor</option>
        <option value="Technical Writer">Technical Writer</option>
        <option value="Trainer / Coach">Trainer / Coach</option>
      </optgroup>
      <optgroup label="Others">
        <option value="Legal Associate / Compliance Officer">Legal Associate / Compliance Officer</option>
        <option value="Research Associate">Research Associate</option>
        <option value="Entrepreneur / Founder / Co-founder">Entrepreneur / Founder / Co-founder</option>
      </optgroup>
    </select>

    <label>Total Experience (years)</label>
    <input type="number" id="experience" min="0" placeholder="e.g., 5" />

    <label>Current CTC</label>
    <input type="text" id="currentCTC" placeholder="e.g., ‚Çπ 18 LPA" />

    <div class="actions">
      <button id="nextBtn" class="primary-btn" type="button">Next: Tell your story ‚Üí</button>
    </div>
  </section>

  <section class="stage-card hidden animate-fade" id="step2">
    <div class="step-indicator">Step 2 of 2</div>
    <h1>Now, let‚Äôs talk about <em>you</em> üåª</h1>
    <p class="sub">Don‚Äôt overthink ‚Äî just answer from the heart.</p>

    <label>Your career story so far</label>
    <textarea id="journey" placeholder="How did you get where you are today?"></textarea>

    <label>Your top 2‚Äì3 strengths</label>
    <textarea id="strengths" placeholder="e.g., curiosity, discipline, creativity"></textarea>

    <label>Work that energizes you</label>
    <textarea id="flow" placeholder="What kind of problems do you love solving?"></textarea>

    <label>Your next role / dream job</label>
    <textarea id="nextRole" placeholder="What do you want to do next?"></textarea>

    <label>Your long-term career vision</label>
    <textarea id="vision" placeholder="How do you see yourself growing in 5 years?"></textarea>

    <div class="actions">
      <button id="backBtn" class="ghost-btn" type="button">‚Üê Back</button>
      <button id="finishBtn" class="primary-btn" type="button">Finish Setup</button>
    </div>
  </section>

  <p class="footer-note">We believe every job seeker deserves structure, clarity, and calm. üå§Ô∏è</p>
  </div>

  <script src="scripts/theme.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    let googleId = params.get('google_id');
    const paymentId = params.get('payment_id');
    const finishBtn = document.getElementById('finishBtn');
    const roleSelect = document.getElementById('role');
    const backToWorkspaceBtn = document.getElementById('backToWorkspace');

    const notify = (message, options) => {
      if (window.JobSprintUI && typeof window.JobSprintUI.showToast === 'function') {
        return window.JobSprintUI.showToast(message, options || {});
      }
      return null;
    };

    const notifyLoading = (message, options) => {
      if (window.JobSprintUI && typeof window.JobSprintUI.showLoadingToast === 'function') {
        return window.JobSprintUI.showLoadingToast(message, options || {});
      }
      return null;
    };

    const redirectWithToast = (url, message) => {
      const toast = notifyLoading(message || 'Redirecting‚Ä¶');
      setTimeout(() => {
        toast?.update?.('Almost there‚Ä¶');
        window.location.href = url;
      }, 180);
    };

    const readStoredProfile = () => {
      try {
        const raw = localStorage.getItem('jobsprint_profile');
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : {};
      } catch (err) {
        console.warn('Could not parse stored profile', err);
        return {};
      }
    };

    const writeStoredProfile = (profile) => {
      try {
        localStorage.setItem('jobsprint_profile', JSON.stringify(profile || {}));
      } catch (err) {
        console.warn('Could not sync profile to localStorage', err);
      }
    };

    const getStoredToken = () => {
      const stored = readStoredProfile();
      const token = stored?.token;
      if (typeof token === 'string' && token.trim()) {
        return token.trim();
      }
      return null;
    };

    const redirectToWorkspace = () => {
      try {
        localStorage.setItem('jobsprint_readiness_seen', new Date().toISOString());
      } catch (err) {
        console.warn('Could not mark readiness seen', err);
      }
      const token = getStoredToken();
      const destination = token ? `/workspace.html?u=${encodeURIComponent(token)}` : '/workspace.html';
      redirectWithToast(destination, 'Opening your workspace‚Ä¶');
    };

    backToWorkspaceBtn?.addEventListener('click', redirectToWorkspace);

    const setRoleValue = (value) => {
      if (!roleSelect) return;
      if (typeof value !== 'string') {
        roleSelect.value = '';
        return;
      }
      const trimmed = value.trim();
      if (!trimmed) {
        roleSelect.value = '';
        return;
      }
      const hasOption = Array.from(roleSelect.options || []).some(
        (option) => option.value === trimmed
      );
      if (!hasOption) {
        const customOption = new Option(trimmed, trimmed);
        roleSelect.add(customOption);
      }
      roleSelect.value = trimmed;
    };

    const initialStoredProfile = readStoredProfile();
    let storedProfileGoogleId = initialStoredProfile?.google_id || null;
    if (initialStoredProfile?.token) {
      backToWorkspaceBtn?.classList.remove('hidden');
    }

    if (!googleId && storedProfileGoogleId) {
      googleId = storedProfileGoogleId;
    }

    if (!googleId) {
      if (finishBtn) {
        finishBtn.disabled = true;
        finishBtn.innerText = 'Redirecting...';
        finishBtn.style.opacity = '0.6';
        finishBtn.style.cursor = 'not-allowed';
      }
      notify('Please sign in with Google to finish onboarding. Redirecting you to sign-up.', { variant: 'warning' });
      const redirectParams = new URLSearchParams();
      if (paymentId) redirectParams.set('payment_id', paymentId);
      const emailParam = params.get('email');
      if (emailParam) redirectParams.set('email', emailParam);
      const redirectQuery = redirectParams.toString();
      const redirectUrl = `/signup.html${redirectQuery ? `?${redirectQuery}` : ''}`;
      redirectWithToast(redirectUrl, 'Taking you to sign-in‚Ä¶');
    }
    let uploadedResume = { path: null, publicUrl: null };

    const resumeStatusEl = document.getElementById('resumeStatus');
    const updateResumeStatus = (url) => {
      if (!resumeStatusEl) return;
      if (url) {
        resumeStatusEl.innerHTML = '';
        resumeStatusEl.append('Resume on file: ');
        const link = document.createElement('a');
        link.href = url;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = 'View uploaded resume';
        resumeStatusEl.appendChild(link);
      } else {
        resumeStatusEl.textContent = 'No resume uploaded yet.';
      }
    };

    const populateFromProfile = (profile) => {
      if (!profile || typeof profile !== 'object') {
        updateResumeStatus();
        return;
      }
      const {
        name,
        email,
        phone,
        city,
        dob,
        role,
        experience,
        current_ctc,
        resume_url,
        career_story
      } = profile;

      const deriveCurrentCtc = (direct, story) => {
        if (direct !== undefined && direct !== null && direct !== '') return direct;
        if (!story || typeof story !== 'object') return undefined;
        const directFromStory = story.current_ctc ?? story.currentCTC;
        if (directFromStory !== undefined && directFromStory !== null && directFromStory !== '') {
          return directFromStory;
        }
        const comp = story.compensation;
        if (comp && typeof comp === 'object') {
          const options = [comp.current, comp.current_ctc, comp.currentCTC, comp.current_salary, comp.currentSalary];
          return options.find((value) => value !== undefined && value !== null && value !== '');
        }
        return undefined;
      };
      if (name) document.getElementById('name').value = name;
      if (email) document.getElementById('email').value = email;
      if (phone) document.getElementById('phone').value = phone;
      if (city) document.getElementById('city').value = city;
      if (dob) document.getElementById('dob').value = dob;
      if (role) {
        setRoleValue(role);
      } else if (roleSelect) {
        roleSelect.value = '';
      }
      if (experience !== undefined && experience !== null && experience !== '') {
        document.getElementById('experience').value = experience;
      }
      const resolvedCtc = deriveCurrentCtc(current_ctc, career_story);
      if (resolvedCtc !== undefined) {
        document.getElementById('currentCTC').value = resolvedCtc;
      }
      if (career_story && typeof career_story === 'object') {
        if (career_story.journey) document.getElementById('journey').value = career_story.journey;
        if (career_story.strengths) document.getElementById('strengths').value = career_story.strengths;
        if (career_story.flow_state_work) document.getElementById('flow').value = career_story.flow_state_work;
        if (career_story.current_vs_next) document.getElementById('nextRole').value = career_story.current_vs_next;
        if (career_story.long_term_vision) document.getElementById('vision').value = career_story.long_term_vision;
      }
      if (resume_url) {
        uploadedResume = { path: resume_url, publicUrl: resume_url };
        updateResumeStatus(resume_url);
      } else {
        uploadedResume = { path: null, publicUrl: null };
        updateResumeStatus();
      }
    };

    const loadExistingProfile = async (id) => {
      if (!id) {
        updateResumeStatus();
        return;
      }
      if (resumeStatusEl) {
        resumeStatusEl.textContent = 'Checking saved resume...';
      }
      try {
        const response = await fetch(`/api/get-user?google_id=${encodeURIComponent(id)}`);
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          console.error('Failed to fetch profile', payload);
          updateResumeStatus();
          return;
        }
        if (!payload?.found) {
          updateResumeStatus();
          return;
        }
        populateFromProfile(payload);
        try {
          const { found, ...rest } = payload;
          const existing = readStoredProfile();
          const merged = { ...existing, ...rest, google_id: id };
          writeStoredProfile(merged);
        } catch (storageErr) {
          console.warn('Could not sync profile to localStorage', storageErr);
        }
        backToWorkspaceBtn?.classList.remove('hidden');
      } catch (err) {
        console.error('Failed to load existing profile', err);
        updateResumeStatus();
      }
    };

    if (googleId) {
      loadExistingProfile(googleId);
    } else {
      updateResumeStatus();
    }

    // Step navigation
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    document.getElementById('nextBtn').onclick = () => {
      step1.classList.add('hidden');
      step2.classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    };
    document.getElementById('backBtn').onclick = () => {
      step2.classList.add('hidden');
      step1.classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    };

    // Simulate resume parsing
    document.getElementById('resume_file').addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const fd = new FormData();
    fd.append('file', file);
    if (googleId) fd.append('google_id', googleId);
    const emailFromParams = params.get('email') || document.getElementById('email').value.trim();
    if (emailFromParams) fd.append('email', emailFromParams);

    const parsingToast = notifyLoading('Parsing your resume‚Ä¶');
    try {
      const r = await fetch('/api/parse-resume', { method: 'POST', body: fd });
      const j = await r.json();
      if (!r.ok || !j.success) {
        parsingToast?.dismiss?.();
        const reason = j?.detail || j?.error || 'Use PDF/DOCX or fill manually.';
        notify(`Could not parse resume. ${reason}`, { variant: 'danger' });
        return;
      }
      const f = j.fields || {};
      const resumeMeta = j.resume || {};
      uploadedResume = {
        path: resumeMeta.path || null,
        publicUrl: resumeMeta.public_url || null
      };
      const uploadedUrl = uploadedResume.publicUrl || uploadedResume.path || null;
      updateResumeStatus(uploadedUrl);
      if (f.name) document.getElementById('name').value = f.name;
      if (f.email) document.getElementById('email').value = f.email;
      if (f.phone) document.getElementById('phone').value = f.phone;
      if (f.city) document.getElementById('city').value = f.city;
      if (f.dob) document.getElementById('dob').value = f.dob;
      if (f.role) setRoleValue(f.role);
      if (typeof f.experience === 'number') document.getElementById('experience').value = f.experience;

      const confidence = f._confidence || j.parsed?._confidence;
      const profileHints = f.profiles || j.parsed?.profiles;
      console.info('Resume parse confidence', confidence);
      if (profileHints?.linkedin) console.info('LinkedIn detected:', profileHints.linkedin);
      if (profileHints?.github) console.info('GitHub detected:', profileHints.github);

      parsingToast?.dismiss?.();
      notify('‚ú® Resume parsed with advanced heuristics! Review and adjust if needed.', { variant: 'success' });
    }
    catch (err)
    {
      parsingToast?.dismiss?.();
      console.error(err);
      notify('Parsing failed. Please fill fields manually.', { variant: 'danger' });
    }
});
       
    // document.getElementById('resume_file').addEventListener('change', () => {
    //   setTimeout(() => {
    //     document.getElementById('name').value = "Alex Jobseeker";
    //     document.getElementById('email').value = "alex@example.com";
    //     document.getElementById('phone').value = "+91 9876543210";
    //     document.getElementById('city').value = "Bangalore";
    //     document.getElementById('dob').value = "1996-05-12";
    //     document.getElementById('role').value = "Product Manager";
    //     document.getElementById('experience').value = 5;
    //     alert("‚ú® Resume parsed successfully! Dummy data filled.");
    //   }, 800);
    // });

    // Finish onboarding
    document.getElementById('finishBtn').onclick = async () => {
      const google_id = googleId;
      const payment_id = paymentId;
      const emailInput = document.getElementById('email').value.trim();
      const emailParam = params.get('email');
      const email = emailInput || (emailParam ? emailParam.trim() : '');
      const name = document.getElementById('name').value.trim();
      const dobValue = document.getElementById('dob').value.trim();

      if (!google_id) {
        notify('Please sign in with Google to finish onboarding.', { variant: 'danger' });
        finishBtn.disabled = false;
        finishBtn.innerText = "Finish Setup";
        return;
      }
      if (!email) {
        notify('Please add your email so we can keep in touch.', { variant: 'danger' });
        finishBtn.disabled = false;
        finishBtn.innerText = "Finish Setup";
        return;
      }
      if (!name) {
        notify('Please share your full name so we can personalize your workspace.', { variant: 'danger' });
        return;
      }
      if (!dobValue) {
        notify('Please provide your date of birth so we can finalize your profile.', { variant: 'danger' });
        return;
      }
      if (Number.isNaN(Date.parse(dobValue))) {
        notify('Your date of birth looks invalid. Please use the format YYYY-MM-DD.', { variant: 'danger' });
        return;
      }

      const normalize = (value) => {
        const trimmed = typeof value === 'string' ? value.trim() : value;
        return trimmed === '' || trimmed === undefined ? undefined : trimmed;
      };

      const phone = normalize(document.getElementById('phone').value);
      const city = normalize(document.getElementById('city').value);
      const role = normalize(document.getElementById('role').value);
      const experienceRaw = document.getElementById('experience').value;
      const experience = experienceRaw === '' ? undefined : Number(experienceRaw);
      const currentCTC = normalize(document.getElementById('currentCTC').value);
      if (experience !== undefined && Number.isNaN(experience)) {
        notify('Total experience must be a number.', { variant: 'danger' });
        return;
      }

      const careerStoryEntries = {
        journey: normalize(document.getElementById('journey').value),
        strengths: normalize(document.getElementById('strengths').value),
        flow_state_work: normalize(document.getElementById('flow').value),
        current_vs_next: normalize(document.getElementById('nextRole').value),
        long_term_vision: normalize(document.getElementById('vision').value)
      };
      const career_story = Object.fromEntries(
        Object.entries(careerStoryEntries).filter(([, value]) => value !== undefined)
      );

      const payload = {
        google_id,
        email,
        name,
        payment_id,
        dob: dobValue,
        plan_start: new Date().toISOString().slice(0,10),
        plan_end: new Date(Date.now() + 90*24*60*60*1000).toISOString().slice(0,10),
        profile_complete: true,
        onboarding_step: 'done'
      };

      if (phone !== undefined) payload.phone = phone;
      if (city !== undefined) payload.city = city;
      if (role !== undefined) payload.role = role;
      if (experience !== undefined) payload.experience = experience;
      if (currentCTC !== undefined) payload.current_ctc = currentCTC;

      const resumeUrl = uploadedResume.publicUrl || uploadedResume.path || undefined;
      if (resumeUrl) payload.resume_url = resumeUrl;

      if (Object.keys(career_story).length > 0) {
        payload.career_story = career_story;
      }

      finishBtn.disabled = true;
      finishBtn.innerText = "Saving...";

      let savingToast = null;
      try {
        savingToast = notifyLoading('Saving your onboarding‚Ä¶');
        const resp = await fetch('/api/create-user', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.success) {
          console.error(data);
          const detailMessage = data?.detail || data?.error;
          const message = detailMessage ? `Could not save your onboarding. ${detailMessage}` : 'Could not save your onboarding. Please try again.';
          savingToast?.dismiss?.();
          notify(message, { variant: 'danger' });
          finishBtn.disabled = false;
          finishBtn.innerText = "Finish Setup";
          return;
        }
        savingToast?.dismiss?.();
        try {
          const existing = readStoredProfile();
          const storageUpdate = { google_id };
          Object.entries(payload).forEach(([key, value]) => {
            if (value !== undefined) {
              storageUpdate[key] = value;
            }
          });
          if (data.token) {
            storageUpdate.token = data.token;
          }
          const mergedProfile = { ...existing, ...storageUpdate };
          writeStoredProfile(mergedProfile);
        } catch (storageErr) {
          console.warn('Could not update stored profile after onboarding', storageErr);
        }
        notify('üéâ Onboarding complete! Redirecting...', { variant: 'success' });
        redirectWithToast(data.redirect_url || "/sprint-readiness.html", 'Preparing your sprint readiness‚Ä¶');
      } catch (err) {
        console.error(err);
        savingToast?.dismiss?.();
        notify('Something went wrong. Please try again.', { variant: 'danger' });
        finishBtn.disabled = false;
        finishBtn.innerText = "Finish Setup";
      }
    };
  </script>
</body>
</html>
