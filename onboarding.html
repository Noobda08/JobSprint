<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>JobSprint • Onboarding</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f7f8fb; --card:#fff; --text:#131820; --muted:#6b7280; --primary:#2563eb; --border:#e5e7eb; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--text); }
    .wrap { max-width: 920px; margin: 32px auto; padding: 0 16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px; box-shadow: 0 2px 8px rgba(0,0,0,.04); }
    h1 { font-size: 22px; margin:0 0 8px; }
    p.lead { color:var(--muted); margin:0 0 16px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .row { display:flex; gap:16px; }
    label { display:block; font-size: 13px; color:#374151; margin-bottom:6px; }
    input[type="text"], input[type="email"], input[type="date"], input[type="number"], textarea, select {
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:14px; box-sizing:border-box;
    }
    textarea { min-height: 96px; resize: vertical; }
    .muted { color:var(--muted); font-size:12px; }
    .actions { display:flex; justify-content:flex-end; gap:12px; margin-top:20px; }
    button { appearance:none; border:1px solid transparent; background:var(--primary); color:#fff; padding:10px 16px; border-radius:10px; font-weight:600; cursor:pointer; }
    button.secondary { background:#fff; border-color:var(--border); color:#111827; }
    .small { font-size:12px; padding:8px 12px; }
    .inline { display:inline-flex; align-items:center; gap:8px; }
    .badge { display:inline-block; background:#eef2ff; color:#3730a3; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:600; }
    .divider { height:1px; background:var(--border); margin:20px 0; }
    .hint { font-size:12px; color:var(--muted); margin-top:6px; }
    .success { color:#065f46; }
    .error { color:#991b1b; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Let’s set up your profile</h1>
      <p class="lead">Upload your resume to auto-fill the basics. You can edit anything before you continue.</p>

      <!-- Resume upload -->
      <div class="row">
        <div style="flex:1">
          <label for="resume_file">Resume (PDF / DOCX)</label>
          <input type="file" id="resume_file" accept=".pdf,.doc,.docx" />
          <div id="resume_status" class="hint">We’ll upload and parse this to save you time.</div>
          <input type="hidden" id="resume_url" />
        </div>
        <div style="width:240px">
          <label>Resume status</label>
          <div id="resume_badge" class="badge">Not uploaded</div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Basic details -->
      <div class="grid">
        <div>
          <label for="name">Full name</label>
          <input type="text" id="name" placeholder="Your name" />
        </div>
        <div>
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="you@example.com" />
        </div>

        <div>
          <label for="phone">Phone</label>
          <input type="text" id="phone" placeholder="+91XXXXXXXXXX" />
        </div>
        <div>
          <label for="city">City</label>
          <input type="text" id="city" placeholder="Noida" />
        </div>

        <div>
          <label for="dob">Date of birth</label>
          <input type="date" id="dob" />
        </div>
        <div>
          <label for="experience">Years of experience</label>
          <input type="number" id="experience" min="0" step="0.5" placeholder="e.g., 6.5" />
        </div>

        <div>
          <label for="role">Current / Target role</label>
          <input type="text" id="role" placeholder="Product Manager" />
        </div>
        <div>
          <label for="source">How did you find us? <span class="muted">(optional)</span></label>
          <select id="source">
            <option value="">Select</option>
            <option>LinkedIn</option>
            <option>Friend / Referral</option>
            <option>Reddit</option>
            <option>Search</option>
            <option>Other</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Story bits (optional, from your earlier schema) -->
      <div class="grid">
        <div>
          <label for="journey">Your journey (brief)</label>
          <textarea id="journey" placeholder="Two lines about your journey so far…"></textarea>
        </div>
        <div>
          <label for="strengths">Your strengths</label>
          <textarea id="strengths" placeholder="Top strengths you bring to a team…"></textarea>
        </div>
        <div>
          <label for="flow">When do you feel in ‘flow’?</label>
          <textarea id="flow" placeholder="Describe work that energizes you…"></textarea>
        </div>
        <div>
          <label for="nextRole">Current vs next role</label>
          <textarea id="nextRole" placeholder="What do you do now? What do you want next?"></textarea>
        </div>
        <div>
          <label for="vision">Long-term vision</label>
          <textarea id="vision" placeholder="Where do you want to be in 3–5 years?"></textarea>
        </div>
      </div>

      <div class="actions">
        <button class="secondary small" id="skipBtn" type="button">Skip for now</button>
        <button id="finishBtn" type="button">Create my workspace</button>
      </div>

      <div id="save_status" class="hint" style="margin-top:8px;"></div>
    </div>
  </div>

  <script>
    // =========================
    // Utilities
    // =========================
    const $ = (id) => document.getElementById(id);
    function setBadge(el, text, ok=false) {
      el.textContent = text;
      el.style.background = ok ? '#ecfdf5' : '#eef2ff';
      el.style.color = ok ? '#065f46' : '#3730a3';
    }
    function setStatus(el, text, ok=null) {
      el.textContent = text;
      el.className = 'hint' + (ok === true ? ' success' : ok === false ? ' error' : '');
    }

    // Optionally pull auth/ids from your environment (adjust as per your app)
    const google_id = localStorage.getItem('google_id') || null;
    const payment_id = localStorage.getItem('payment_id') || null;

    // =========================
    // 1) Upload resume → get URL (persist), then parse via your backend parser
    // =========================
    async function uploadResumeToSupabase(file) {
      const fd = new FormData();
      fd.append('file', file);
      const r = await fetch('/api/upload-resume', { method: 'POST', body: fd });
      const j = await r.json().catch(() => ({}));
      if (!r.ok || !j?.success || !j?.url) throw new Error(j?.error || 'Upload failed');
      return j.url;
    }

    // This calls your **server** that wraps `resume_parser_js_robust_node.js`
    async function parseResumeWithMyLogic(file) {
      const fd = new FormData();
      fd.append('file', file);
      const r = await fetch('/api/parse-resume', { method: 'POST', body: fd });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j?.error || 'Parser error');
      // Expected shape from your parser route:
      // { name, email, phone, city, dob, role, experience_years }
      return j || {};
    }

    $('resume_file').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      setStatus($('resume_status'), 'Uploading resume…');
      setBadge($('resume_badge'), 'Uploading…');

      try {
        // 1) Upload & persist
        const url = await uploadResumeToSupabase(file);
        $('resume_url').value = url;
        setBadge($('resume_badge'), 'Uploaded', true);
        setStatus($('resume_status'), 'Resume uploaded. Parsing…');

        // 2) Parse via your backend parser
        const f = await parseResumeWithMyLogic(file);

        // 3) Autofill gently (don’t overwrite if user already typed)
        if (f.name && !$('name').value) $('name').value = f.name;
        if (f.email && !$('email').value) $('email').value = f.email;
        if (f.phone && !$('phone').value) $('phone').value = f.phone;
        if (f.city && !$('city').value) $('city').value = f.city;
        if (f.dob && !$('dob').value) $('dob').value = f.dob;
        if (f.role && !$('role').value) $('role').value = f.role;
        const exp = (typeof f.experience_years === 'number') ? f.experience_years : f.experience;
        if (typeof exp === 'number' && !$('experience').value) $('experience').value = exp;

        setStatus($('resume_status'), '✨ Uploaded & parsed. You can review/edit the fields above.', true);
      } catch (err) {
        console.error(err);
        setBadge($('resume_badge'), 'Upload failed');
        setStatus($('resume_status'), 'Could not upload/parse resume. You can still fill the form manually.', false);
      }
    });

    // =========================
    // 2) Save profile (send resume_url too)
    // =========================
    $('finishBtn').addEventListener('click', async () => {
      const payload = {
        google_id,
        payment_id,
        email: $('email').value.trim(),
        name: $('name').value.trim(),
        phone: $('phone').value.trim(),
        city: $('city').value.trim(),
        dob: $('dob').value || null,
        role: $('role').value.trim(),
        experience: Number($('experience').value || 0),
        source: $('source').value || null,
        resume_url: $('resume_url').value || null,
        career_story: {
          journey: $('journey').value.trim(),
          strengths: $('strengths').value.trim(),
          flow_state_work: $('flow').value.trim(),
          current_vs_next: $('nextRole').value.trim(),
          long_term_vision: $('vision').value.trim()
        },
        plan_start: new Date().toISOString().slice(0,10),
        plan_end: new Date(Date.now() + 90*24*60*60*1000).toISOString().slice(0,10),
        profile_complete: true,
        onboarding_step: 'done'
      };

      setStatus($('save_status'), 'Saving your profile…');

      try {
        const r = await fetch('/api/create-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(j?.error || 'Save failed');

        setStatus($('save_status'), '✅ Profile saved. Redirecting to readiness…', true);
        // redirect to your readiness step (as we planned)
        window.location.href = '/readiness';
      } catch (e) {
        console.error(e);
        setStatus($('save_status'), 'Could not save your profile. Please try again.', false);
      }
    });

    $('skipBtn').addEventListener('click', () => {
      // Allow skipping (stores minimal state if needed)
      window.location.href = '/workspace';
    });
  </script>
</body>
</html>
