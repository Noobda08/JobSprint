<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>JobSprint • Workspace</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
  :root{
    --bg1:#FFF6EC; --bg2:#FFE0C8; --ink:#222; --muted:#6b6b6b;
    --card:#fff; --line:#eee; --brand:#ff9a4f; --brand-d:#ff7c1f;
    --lane:#fff8f2; --shadow:0 10px 30px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(120deg,var(--bg1),var(--bg2));color:var(--ink)}
  .app{min-height:100vh;display:flex;flex-direction:column}

  /* Topbar */
  .top{
    position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(6px);
    background:rgba(255,255,255,.65);border-bottom:1px solid #f1dcc9;
  }
  .topin{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:12px 16px}
  .brand{display:flex;align-items:center;gap:10px}
  .badge{width:36px;height:36px;border-radius:12px;background:#ffe8d6;display:grid;place-items:center;font-weight:700;color:#c25a0b}
  .navspacer{flex:1}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid #f2caa6;border-radius:999px;padding:6px 10px;color:#a2591b}
  .ham{width:36px;height:36px;border-radius:10px;border:1px solid #f2caa6;background:#fff;cursor:pointer}

  .dropdown{position:absolute;right:16px;top:60px;background:#fff;border:1px solid #f2caa6;border-radius:14px;box-shadow:var(--shadow);padding:8px;display:none;min-width:230px}
  .dropdown a{display:block;padding:10px 12px;border-radius:10px;color:#5a3a1a;text-decoration:none}
  .dropdown a:hover{background:#fff5eb}

  /* Header stats */
  .head{max-width:1200px;margin:18px auto 0;padding:0 16px 14px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .stat{background:rgba(255,255,255,.85);border:1px solid #f2caa6;border-radius:12px;padding:10px 14px;display:flex;gap:10px;align-items:center}
  .stat strong{font-weight:600}
  .btn{background:var(--brand);border:0;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn:hover{background:var(--brand-d)}
  .btn.ghost{background:#fff;border:1px solid #f2caa6;color:#a25a1b}

  /* Board */
  .board{max-width:1200px;margin:14px auto;padding:0 16px 40px;display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:14px}
  .lane{background:rgba(255,255,255,.88);border:1px solid #f2caa6;border-radius:16px;min-height:320px;display:flex;flex-direction:column}
  .lanehead{padding:12px 12px 10px;border-bottom:1px solid #f5d6b8}
  .lanehead-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .lanehead h3{margin:0;font-size:16px}
  .lane-desc{margin:6px 0 0;font-size:12px;color:#9f9f9f;line-height:1.4}
  .count{font-size:12px;color:#9a6a3a;background:#fff5eb;border:1px solid #f2caa6;border-radius:999px;padding:2px 8px}
  .cards{flex:1;padding:10px;display:grid;gap:10px}
  .card{background:#fff;border:1px solid #f2caa6;border-radius:12px;padding:10px;box-shadow:var(--shadow);cursor:grab}
  .card small{color:var(--muted)}
  .empty{flex:1;display:grid;place-items:center;color:#b07a45;font-size:13px;padding:18px}

  /* Modal */
  .modalBG{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:30}
  .modal{background:#fff;border:1px solid #f2caa6;border-radius:14px;box-shadow:var(--shadow);width:min(560px,92%);padding:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:13px;font-weight:600}
  input,textarea{width:100%;padding:10px;border:1px solid #f0d3b5;border-radius:10px;font-family:inherit}
  textarea{min-height:80px;resize:vertical}

  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  @media (max-width: 980px){ .board{grid-template-columns:1fr 1fr} }
  @media (max-width: 640px){ .board{grid-template-columns:1fr} .row{grid-template-columns:1fr} .pill{display:none} }
</style>
</head>
<body>
<div class="app">
  <!-- top bar -->
  <div class="top">
    <div class="topin">
      <div class="brand">
        <div class="badge">J</div>
        <div>
          <div style="font-weight:700;">JobSprint</div>
          <div id="userLine" style="font-size:12px;color:#8a6a4b;">Welcome back</div>
        </div>
      </div>
      <div class="navspacer"></div>
      <div class="pill" id="goalPill">Goal: <strong id="goalNum">4</strong> / day</div>
      <button class="ham" id="hamBtn">☰</button>
      <div class="dropdown" id="menu">
        <a href="onboarding.html">Edit onboarding info</a>
        <a href="#" id="exportBtn">Export board (JSON)</a>
        <a href="#" id="signoutBtn">Sign out</a>
      </div>
    </div>
  </div>

  <!-- header stats -->
  <div class="head">
    <div class="stat">Today’s applications: <strong id="todayCount">0</strong></div>
    <div class="stat">This week: <strong id="weekCount">0</strong></div>
    <button class="btn" id="addBtn">+ Add Application</button>
    <button class="btn ghost" id="resetBtn">Reset board</button>
  </div>

  <!-- board -->
  <div class="board" id="board">
    <div class="lane" data-col="applied">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Applied</h3><span class="count" data-count="applied">0</span></div>
        <p class="lane-desc">Applications you&rsquo;ve submitted and are waiting to hear back on.</p>
      </div>
      <div class="cards" data-drop="applied"></div>
      <div class="empty">Drag cards here</div>
    </div>
    <div class="lane" data-col="screening">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Screening / Response Received</h3><span class="count" data-count="screening">0</span></div>
        <p class="lane-desc">Move your application to this stage when a recruiter has replied or requested more information.</p>
      </div>
      <div class="cards" data-drop="screening"></div>
      <div class="empty">Drag cards here</div>
    </div>
    <div class="lane" data-col="interviewing">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Interviewing</h3><span class="count" data-count="interviewing">0</span></div>
        <p class="lane-desc">Move your application to this stage when interviews have been scheduled or are in progress.</p>
      </div>
      <div class="cards" data-drop="interviewing"></div>
      <div class="empty">Drag cards here</div>
    </div>
    <div class="lane" data-col="offer">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Offer</h3><span class="count" data-count="offer">0</span></div>
        <p class="lane-desc">Move your application to this stage when you&rsquo;ve received a verbal or written offer.</p>
      </div>
      <div class="cards" data-drop="offer"></div>
      <div class="empty">Drag cards here</div>
    </div>
    <div class="lane" data-col="rejected">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Rejected</h3><span class="count" data-count="rejected">0</span></div>
        <p class="lane-desc">Move your application to this stage when the process didn&rsquo;t move forward or the company declined your application.</p>
      </div>
      <div class="cards" data-drop="rejected"></div>
      <div class="empty">Drag cards here</div>
    </div>
  </div>
</div>

<!-- modal -->
<div class="modalBG" id="modalBG" aria-hidden="true">
  <div class="modal">
    <h3 style="margin:4px 0 12px" id="modalTitle">New Application</h3>
    <div class="row">
      <div>
        <label>Company</label>
        <input id="m_company" placeholder="Acme Inc."/>
      </div>
      <div>
        <label>Role</label>
        <input id="m_role" placeholder="Product Manager"/>
      </div>
      <div>
        <label>JD link</label>
        <input id="m_link" placeholder="https://..."/>
      </div>
      <div>
        <label>Deadline (optional)</label>
        <input type="date" id="m_deadline"/>
      </div>
    </div>
    <label style="margin-top:10px">Notes</label>
    <textarea id="m_notes" placeholder="Anything important about this application..."></textarea>
    <div class="actions">
      <button class="btn ghost" id="deleteBtn" style="margin-right:auto;display:none">Delete</button>
      <button class="btn ghost" id="cancelBtn">Cancel</button>
      <button class="btn" id="saveBtn">Add</button>
    </div>
  </div>
</div>

<script>
  // --- session & per-user storage keys ---
  const qs = new URLSearchParams(location.search);
  const token = qs.get('u') || (JSON.parse(localStorage.getItem('jobsprint_profile')||'{}').token) || 'guest';

  // ✅ Guard: if no valid session token, send to login
  if (!token || token === 'guest') {
    location.href = '/signup.html?mode=login';
  }

  const KEY_BOARD = `jobsprint_board_${token}`;
  const KEY_TODAY = `jobsprint_today_${token}`;
  const profile = JSON.parse(localStorage.getItem('jobsprint_profile') || '{}');

  // initial board state
  const COLUMNS = ['applied','screening','interviewing','offer','rejected'];

  function emptyBoard(){
    return COLUMNS.reduce((acc,col)=>{ acc[col] = []; return acc; }, {});
  }

  function normalizeBoard(raw){
    if (!raw) return emptyBoard();
    if ('to_apply' in raw){
      return {
        applied: raw.to_apply || [],
        screening: raw.applied || [],
        interviewing: raw.interviewing || [],
        offer: raw.offer || [],
        rejected: raw.rejected || []
      };
    }
    const shaped = emptyBoard();
    COLUMNS.forEach(col=>{
      if (Array.isArray(raw[col])) shaped[col] = raw[col];
    });
    return shaped;
  }

  let board = normalizeBoard(JSON.parse(localStorage.getItem(KEY_BOARD) || 'null'));

  // UI refs
  const userLine = document.getElementById('userLine');
  const goalNum  = document.getElementById('goalNum');
  const todayCountEl = document.getElementById('todayCount');
  const weekCountEl  = document.getElementById('weekCount');

  // ✅ Hydrate header from backend by token; fallback to local
  (async () => {
    try {
      const r = await fetch('/api/get-user-by-token?token=' + encodeURIComponent(token), { headers:{'cache-control':'no-cache'} });
      if (r.ok) {
        const data = await r.json();
        if (data.found) {
          const merged = { ...(profile||{}), name: data.name, email: data.email, applications_goal_per_day: data.goal_per_day, token };
          localStorage.setItem('jobsprint_profile', JSON.stringify(merged));
          userLine.textContent = data.name ? `Hello, ${data.name}` : 'Welcome back';
          goalNum.textContent = data.goal_per_day || 4;
          return;
        }
      }
      userLine.textContent = profile?.name ? `Hello, ${profile.name}` : 'Welcome back';
      goalNum.textContent = profile?.applications_goal_per_day || 4;
    } catch {
      userLine.textContent = profile?.name ? `Hello, ${profile.name}` : 'Welcome back';
      goalNum.textContent = profile?.applications_goal_per_day || 4;
    }
  })();

  // counts & rendering
  function updateCounts(){
    COLUMNS.forEach(col=>{
      const c = board[col].length;
      document.querySelector(`[data-count="${col}"]`).textContent = c;
      const lane = document.querySelector(`.lane[data-col="${col}"]`);
      lane.querySelector('.empty').style.display = c ? 'none' : 'grid';
    });
  }
  function saveBoard(){ localStorage.setItem(KEY_BOARD, JSON.stringify(board)); }
  function cardHTML(item){
    const deadline = item.deadline ? ` • <small>Due: ${item.deadline}</small>` : '';
    return `
      <div class="card" draggable="true" data-id="${item.id}">
        <strong>${item.company}</strong> — ${item.role} ${deadline}<br/>
        <small>${item.link ? `<a href="${item.link}" target="_blank">Job link</a>` : ''}</small>
        ${item.notes ? `<div style="margin-top:4px;color:#7a6a55;font-size:13px">${item.notes}</div>`:''}
      </div>`;
  }
  function renderBoard(){
    COLUMNS.forEach(col=>{
      const wrap = document.querySelector(`[data-drop="${col}"]`);
      wrap.innerHTML = board[col].map(cardHTML).join('');
    });
    updateCounts();
    enableDnD();
  }

  // drag & drop
  function enableDnD(){
    document.querySelectorAll('.card').forEach(el=>{
      el.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', el.getAttribute('data-id'));
        setTimeout(()=> el.style.opacity = .5, 0);
      });
      el.addEventListener('dragend', ()=> el.style.opacity = 1);
    });
    document.querySelectorAll('.cards').forEach(drop=>{
      drop.addEventListener('dragover', e=> e.preventDefault());
      drop.addEventListener('drop', e=>{
        e.preventDefault();
        const id = e.dataTransfer.getData('text/plain');
        const targetCol = drop.getAttribute('data-drop');
        moveCard(id, targetCol);
      });
    });
  }
  function moveCard(id, dest){
    if (!COLUMNS.includes(dest)) return;
    let card=null, fromCol=null;
    for (const col of COLUMNS) {
      const idx = board[col].findIndex(x=>x.id===id);
      if (idx>-1) { card = board[col].splice(idx,1)[0]; fromCol = col; break; }
    }
    if (!card) return;
    board[dest].unshift(card);
    saveBoard(); renderBoard();
  }

  // daily/weekly counters
  function todayKeyDate(){ return new Date().toISOString().slice(0,10); }
  function getWeekNum(d){ d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const dayNum = d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-dayNum); const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); }
  function loadToday(){
    const raw = JSON.parse(localStorage.getItem(KEY_TODAY) || 'null') || { date: todayKeyDate(), count: 0, week: {} };
    if (raw.date !== todayKeyDate()) { raw.date = todayKeyDate(); raw.count = 0; }
    return raw;
  }
  function saveToday(t){ localStorage.setItem(KEY_TODAY, JSON.stringify(t)); }
  function bumpToday(){
    const t = loadToday();
    t.count += 1;
    const d = new Date(); const wk = d.getFullYear()+'-W'+getWeekNum(d);
    t.week[wk] = (t.week[wk]||0) + 1;
    saveToday(t); reflectToday();
  }
  function reflectToday(){
    const t = loadToday();
    todayCountEl.textContent = t.count;
    const d = new Date(); const wk = d.getFullYear()+'-W'+getWeekNum(d);
    weekCountEl.textContent = t.week[wk] || 0;
  }

  // modal controls
  const modalBG = document.getElementById('modalBG');
  const modalTitle = document.getElementById('modalTitle');
  const saveBtn = document.getElementById('saveBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  let editingCardId = null;

  function setModalVisibility(show){
    modalBG.style.display = show ? 'flex' : 'none';
    modalBG.setAttribute('aria-hidden', show ? 'false' : 'true');
  }

  function clearModal(){
    ['m_company','m_role','m_link','m_deadline','m_notes'].forEach(id=>document.getElementById(id).value='');
  }

  function openModalForNew(){
    editingCardId = null;
    modalTitle.textContent = 'New Application';
    saveBtn.textContent = 'Add';
    deleteBtn.style.display = 'none';
    clearModal();
    setModalVisibility(true);
    document.getElementById('m_company').focus();
  }

  function locateCard(id){
    for (const col of COLUMNS){
      const idx = board[col].findIndex(x=>x.id===id);
      if (idx>-1){
        return { col, idx, card: board[col][idx] };
      }
    }
    return null;
  }

  function openModalForEdit(id){
    const located = locateCard(id);
    if (!located) return;
    editingCardId = id;
    const { card } = located;
    modalTitle.textContent = 'Edit Application';
    saveBtn.textContent = 'Save changes';
    deleteBtn.style.display = 'inline-flex';
    document.getElementById('m_company').value = card.company || '';
    document.getElementById('m_role').value = card.role || '';
    document.getElementById('m_link').value = card.link || '';
    document.getElementById('m_deadline').value = card.deadline || '';
    document.getElementById('m_notes').value = card.notes || '';
    setModalVisibility(true);
    document.getElementById('m_company').focus();
  }

  function closeModal(){
    setModalVisibility(false);
    editingCardId = null;
    clearModal();
  }

  function upsertCard(){
    const company  = document.getElementById('m_company').value.trim();
    const role     = document.getElementById('m_role').value.trim();
    if (!company || !role){ alert('Please enter Company and Role'); return; }
    const link     = document.getElementById('m_link').value.trim();
    const deadline = document.getElementById('m_deadline').value;
    const notes    = document.getElementById('m_notes').value.trim();
    if (editingCardId){
      const located = locateCard(editingCardId);
      if (!located) { closeModal(); return; }
      board[located.col][located.idx] = { ...board[located.col][located.idx], company, role, link, deadline, notes };
    } else {
      const id = 'c_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
      board.applied.unshift({ id, company, role, link, deadline, notes, created_at: Date.now() });
      bumpToday();
    }
    saveBoard(); renderBoard(); closeModal();
  }

  function deleteCard(){
    if (!editingCardId) { closeModal(); return; }
    const located = locateCard(editingCardId);
    if (!located) { closeModal(); return; }
    if (!confirm('Delete this application?')) return;
    board[located.col].splice(located.idx, 1);
    saveBoard(); renderBoard(); closeModal();
  }

  // top menu + actions
  const menu = document.getElementById('menu');
  document.getElementById('hamBtn').onclick = ()=> menu.style.display = (menu.style.display==='block'?'none':'block');
  document.getElementById('exportBtn').onclick = (e)=>{ e.preventDefault(); exportBoard(); menu.style.display='none'; };
  document.getElementById('signoutBtn').onclick = (e)=>{ e.preventDefault(); localStorage.removeItem('jobsprint_profile'); location.href='/signup.html?mode=login'; };

  function exportBoard(){
    const blob = new Blob([JSON.stringify(board,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'jobsprint_board.json'; a.click();
    URL.revokeObjectURL(url);
  }

  // buttons
  document.getElementById('addBtn').onclick = openModalForNew;
  document.getElementById('cancelBtn').onclick = closeModal;
  document.getElementById('saveBtn').onclick = upsertCard;
  document.getElementById('deleteBtn').onclick = deleteCard;
  document.getElementById('resetBtn').onclick = ()=>{
    if (!confirm('Reset board for this user?')) return;
    board = emptyBoard();
    saveBoard(); renderBoard();
  };

  // init
  function attachCardActions(){
    document.querySelectorAll('.card').forEach(el=>{
      el.addEventListener('click', e=>{
        if (e.target.closest('a')) return;
        const id = el.getAttribute('data-id');
        openModalForEdit(id);
      });
    });
  }

  const originalEnableDnD = enableDnD;
  enableDnD = function(){
    originalEnableDnD();
    attachCardActions();
  };

  renderBoard();
  reflectToday();
</script>
</body>
</html>
