<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>JobSprint ‚Ä¢ Workspace</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="styles/theme.css"/>
<style>
  :root{
    --topbar-height:60px;
    --bg1:#f0f6ff; --bg2:#e1edff; --ink:#0b1a33; --muted:#4b6078;
    --card:#fff; --line:#d5e3f7; --brand:#0a66c2; --brand-d:#084a91;
    --lane:#eef5ff; --shadow:0 12px 34px rgba(10,102,194,.12);
    --coach-summary-width:28px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(120deg,var(--bg1),var(--bg2));color:var(--ink)}
  .app{min-height:100vh;display:flex;flex-direction:column;padding-left:var(--coach-summary-width);transition:margin-left .32s ease,padding-left .32s ease}

  /* Topbar */
  .top{
    position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(6px);
    background:rgba(255,255,255,.72);border-bottom:1px solid #d2e4ff;
  }
  .topin{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:12px 16px}
  .brand{display:flex;align-items:center;gap:10px}
  .badge{width:36px;height:36px;border-radius:12px;overflow:hidden;display:grid;place-items:center;background:#fff;padding:4px}
  .badge img{width:100%;height:100%;object-fit:contain;display:block}
  .navspacer{flex:1}
  .pill-button{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid #c8d9f4;border-radius:999px;padding:6px 10px;color:#0f3e7c;cursor:pointer;font:inherit}
  .pill-button strong{font-weight:600}
  .pill-button:focus-visible{outline:2px solid #0d7ae0;outline-offset:2px}
  .ham{width:36px;height:36px;border-radius:10px;border:1px solid #c8d9f4;background:#fff;cursor:pointer}

  .coach-nav-btn{background:#fff;border:1px solid #c8d9f4;border-radius:999px;padding:8px 14px;font-weight:600;color:#0f3e7c;cursor:pointer;transition:background .2s ease,box-shadow .2s ease}
  .coach-nav-btn:hover{background:#edf4ff;box-shadow:0 4px 12px rgba(10,102,194,.18)}

  .dropdown{position:absolute;right:16px;top:60px;background:#fff;border:1px solid #c8d9f4;border-radius:14px;box-shadow:var(--shadow);padding:8px;display:none;min-width:230px}
  .dropdown a{display:block;padding:10px 12px;border-radius:10px;color:#1e3f73;text-decoration:none}
  .dropdown a:hover{background:#edf4ff}

  /* Header stats */
  .head{max-width:1200px;margin:18px auto 0;padding:0 16px 14px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .stat{background:rgba(255,255,255,.85);border:1px solid #c8d9f4;border-radius:12px;padding:10px 14px;display:flex;gap:10px;align-items:center}
  .stat strong{font-weight:600}
  .btn{background:var(--brand);border:0;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn:hover{background:var(--brand-d)}
  .btn.ghost{background:#fff;border:1px solid #c8d9f4;color:#0f3e7c}

  /* Board */
  .board{
    --lane-gap:18px;
    --lanes-visible:3;
    --lane-peek:.5;
    --lane-width:calc((100% - (var(--lanes-visible) * var(--lane-gap))) / (var(--lanes-visible) + var(--lane-peek)));
    max-width:1200px;
    margin:14px auto;
    padding:0 16px 40px;
    display:flex;
    gap:var(--lane-gap);
    align-items:stretch;
    overflow-x:auto;
    scroll-snap-type:x proximity;
    scroll-padding:0 16px;
    scrollbar-width:thin;
    scrollbar-color:rgba(15,62,124,.28) rgba(15,62,124,.08);
  }
  .board::-webkit-scrollbar{height:8px}
  .board::-webkit-scrollbar-thumb{background:rgba(15,62,124,.28);border-radius:999px}
  .board::-webkit-scrollbar-track{background:rgba(15,62,124,.08);border-radius:999px}
  .lane{
    background:rgba(255,255,255,.92);
    border:1px solid #c8d9f4;
    border-radius:18px;
    min-height:360px;
    display:flex;
    flex-direction:column;
    flex:0 0 var(--lane-width);
    min-width:var(--lane-width);
    scroll-snap-align:start;
    box-shadow:0 18px 36px rgba(10,102,194,.12);
  }
  .lanehead{padding:16px 16px 12px;border-bottom:1px solid #d7e6ff;display:flex;flex-direction:column;gap:8px;min-height:152px}
  .lanehead-top{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .lanehead h3{margin:0;font-size:17px}
  .lane-desc{margin:4px 0 0;font-size:12px;color:#627ba3;line-height:1.5}
  .lane-actions{padding:12px 16px 0;display:flex;flex-direction:column;gap:10px}
  .lane-add{width:100%;justify-content:center;font-size:15px;padding:12px 16px;box-shadow:0 12px 24px rgba(10,102,194,.16)}
  .lane-add:hover{box-shadow:0 16px 32px rgba(10,102,194,.2)}
  .count{font-size:12px;color:#2f4f86;background:#edf4ff;border:1px solid #c8d9f4;border-radius:999px;padding:2px 8px}
  .cards{flex:1;padding:14px;display:grid;gap:12px}
  .card{
    position:relative;
    background:var(--card);
    border:1px solid #d5e3f7;
    border-radius:12px;
    padding:14px;
    box-shadow:var(--shadow);
    cursor:grab;
    display:flex;
    flex-direction:column;
    gap:8px;
    transition:transform .2s ease,box-shadow .2s ease;
  }
  .card:hover{transform:translateY(-2px);box-shadow:0 20px 36px rgba(10,102,194,.16)}
  .card strong{font-weight:600;color:var(--ink)}
  .card small{color:var(--muted)}
  .card-header{font-size:14px;line-height:1.4;color:var(--ink)}
  .card-role{color:#0f3e7c;font-size:13px;font-weight:600}
  .card-badges{display:flex;flex-wrap:wrap;gap:6px}
  .card-badge{background:var(--brand-soft);border:1px solid #c8d9f4;border-radius:999px;padding:2px 8px;font-size:11px;color:#0f3e7c;white-space:nowrap}
  .card-badge.more{background:#0f3e7c;color:#fff;font-weight:700;border-color:#0f3e7c}
  .empty{flex:1;display:grid;place-items:center;color:#385b8a;font-size:13px;padding:18px}

  /* Modal */
  .modalBG{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:30;padding:20px;overflow:auto}
  .modal{background:#fff;border:1px solid #c8d9f4;border-radius:14px;box-shadow:var(--shadow);width:min(560px,92%);max-height:calc(100vh - 40px);padding:16px;overflow:auto}
  .modal-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px}
  .modal-title-block{display:flex;flex-direction:column;gap:6px;flex:1}
  .modal-title-block h3{margin:4px 0 0}
  .modal-close{background:transparent;border:0;color:#275291;font-size:20px;line-height:1;font-weight:600;border-radius:8px;padding:6px 8px;cursor:pointer}
  .modal-close:hover{background:#edf4ff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:13px;font-weight:600}
  input,textarea{width:100%;padding:10px;border:1px solid #c9dfff;border-radius:10px;font-family:inherit}
  textarea{min-height:80px;resize:vertical}

  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .section{margin-top:16px;padding:14px;border:1px solid #d7e6ff;border-radius:12px;background:#eef5ff}
  .section h4{margin:0 0 8px;font-size:15px}
  .job-fit{display:flex;flex-direction:column;gap:10px}
  .job-fit-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .job-fit-copy{margin:4px 0 0;font-size:12px;color:#2c4f80}
  .fit-results{margin-top:10px;border-top:1px solid #d6e5ff;padding-top:10px;font-size:13px;color:#2c4f80}
  .fit-band{display:inline-flex;align-items:center;gap:6px;margin-left:6px;font-size:12px;padding:2px 8px;border-radius:999px;background:#dceaff;color:#0f3e7c}
  .fit-list{margin:6px 0 0;padding-left:18px}
  .badge-pill{display:inline-flex;align-items:center;gap:6px;background:#fff;border:1px solid #c8d9f4;border-radius:999px;padding:4px 10px;font-size:12px;color:#0f3e7c}
  .questions-add{display:flex;gap:8px;margin-bottom:10px}
  .questions-add input{flex:1}
  .question-item{border:1px solid #cddffa;border-radius:12px;margin-bottom:10px;background:#fff}
  .question-head{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid #dbe7ff}
  .question-head input{flex:1;border:none;padding:0;font-weight:600;color:#2c4f80}
  .question-head button{background:none;border:0;font-size:16px;cursor:pointer;color:#275291}
  .question-body{padding:12px;display:none;flex-direction:column;gap:10px}
  .question-body textarea{min-height:90px}
  .stage-meta{display:flex;flex-direction:column;gap:8px}
  .stage-meta-note{font-size:12px;color:#4b6b94}
  .stage-meta-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
  .stage-meta-item{background:#f4f7ff;border:1px solid #dbe7ff;border-radius:10px;padding:8px 10px;display:flex;flex-direction:column;gap:4px;font-size:12px;color:#2c4f80}
  .stage-meta-item.full{grid-column:1 / -1}
  .stage-meta-item.muted .stage-meta-value{color:#4b6b94;font-weight:500}
  .stage-meta-label{text-transform:uppercase;letter-spacing:.4px;font-weight:600;font-size:11px;color:#5271a6}
  .stage-meta-value{font-weight:600;font-size:13px;color:#153971;white-space:pre-line;word-break:break-word}
  .stage-meta-empty{font-size:12px;color:#4b6b94}
  .stage-meta-stack{display:flex;flex-direction:column;gap:8px}
  .stage-note{font-size:12px;color:#4b6b94;margin-top:4px}
  .drawerBG{position:fixed;inset:0;display:none;align-items:stretch;justify-content:flex-end;background:rgba(0,0,0,.25);z-index:40}
  .drawer{width:min(360px,90vw);background:#fff;height:100%;border-left:1px solid #c9dfff;box-shadow:var(--shadow);display:flex;flex-direction:column}
  .drawer-head{padding:14px 16px;border-bottom:1px solid #dbe7ff;display:flex;align-items:center;justify-content:space-between}
  .drawer-head h4{margin:0;font-size:16px}
  .drawer-body{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
  .drawer-body .msg{padding:10px 12px;border-radius:10px;max-width:90%;font-size:13px;line-height:1.4}
  .drawer-body .msg.user{background:#dceaff;align-self:flex-end}
  .drawer-body .msg.ai{background:#f6f6f6;border:1px solid #ececec;align-self:flex-start}
  .drawer-input{padding:12px 16px;border-top:1px solid #dbe7ff;display:flex;flex-direction:column;gap:8px}
  .drawer-input textarea{min-height:70px}
  .toggle-switch{display:flex;align-items:center;gap:8px;font-size:13px;color:#2c4f80}
  .sprint-coach{position:fixed;left:0;top:0;bottom:0;width:300px;background:rgba(255,255,255,.95);border-right:1px solid #c8d9f4;box-shadow:var(--shadow);transform:translateX(-110%);transition:transform .32s ease;z-index:35;display:flex;flex-direction:column}
  .sprint-coach.open{transform:translateX(0)}
  .coach-inner{flex:1;display:flex;flex-direction:column;gap:18px;padding:24px 20px;overflow-y:auto;background:linear-gradient(160deg,#eef5ff,#e4f0ff)}
  .coach-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .coach-header h2{margin:0;font-size:22px}
  .coach-subtitle{margin:4px 0 0;font-size:12px;color:#2f568f}
  .coach-profile{margin:8px 0 0;font-size:12px;color:#0f3e7c;font-weight:600}
  .coach-close{background:#fff;border:1px solid #c8d9f4;border-radius:10px;width:32px;height:32px;cursor:pointer;color:#0f3e7c}
  .coach-close:hover{background:#edf4ff}
  .coach-section{background:rgba(255,255,255,.86);border:1px solid #cfe0fb;border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:10px;box-shadow:0 10px 20px rgba(10,102,194,.1)}
  .coach-section-title{font-weight:600;text-transform:uppercase;font-size:12px;letter-spacing:.6px;color:#1f4f94}
  .coach-quote{font-size:14px;color:#2c4f80;line-height:1.5}
  .coach-mini-btn{align-self:flex-start;background:var(--brand);color:#fff;border:0;border-radius:999px;padding:8px 14px;font-weight:600;cursor:pointer;font-size:12px}
  .coach-mini-btn:hover{background:var(--brand-d)}
  .coach-goal-edit{display:flex;flex-direction:column;gap:8px;padding:10px;border:1px solid #d3e2ff;border-radius:12px;background:#f3f7ff}
  .coach-goal-label{font-size:12px;font-weight:600;color:#1f4f94;text-transform:uppercase;letter-spacing:.4px}
  .coach-goal-display{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    font-size:13px;
    color:#1f3f7a;
    background:transparent;
    border:0;
    padding:0;
    width:100%;
    text-align:left;
    cursor:pointer;
  }
  .coach-goal-display:focus-visible{outline:2px solid #0d7ae0;outline-offset:2px}
  .coach-goal-display strong{font-size:16px;color:#0f3e7c}
  .coach-goal-text{display:flex;align-items:baseline;gap:4px}
  .coach-goal-edit-icon{display:inline-flex;align-items:center;justify-content:center;font-size:16px;color:#0f3e7c;opacity:.7}
  .coach-goal-display:hover .coach-goal-edit-icon{opacity:1}
  .coach-goal-actions{display:flex;gap:8px;flex-wrap:wrap}
  .coach-goal-form{display:flex;flex-direction:column;gap:8px}
  .coach-goal-form[hidden]{display:none !important}
  .coach-goal-input{width:100%;padding:8px 10px;border:1px solid #c9dfff;border-radius:10px;font:inherit}
  .coach-goal-status{font-size:12px;color:#2f568f}
  .coach-goal-status.error{color:#b32500}
  .coach-mini-btn.outline{background:#fff;color:#0f3e7c;border:1px solid #c8d9f4}
  .coach-mini-btn.outline:hover{background:#edf4ff}
  .coach-progress{display:flex;flex-direction:column;gap:8px}
  .coach-progress-bar{background:#e6f0ff;border-radius:999px;overflow:hidden;height:10px}
  .coach-progress-fill{height:100%;background:linear-gradient(90deg,#4ba0ff,#1da1f2);width:0;transition:width .4s ease;border-radius:999px}
  .coach-progress-text{font-size:13px;font-weight:600;color:#2c4f80}
  .coach-note{font-size:12px;color:#3260a3}
  .coach-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .coach-stat{background:#eef5ff;border:1px solid #cfe0fb;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:4px;font-size:12px;color:#2c4f80}
  .coach-stat strong{font-size:16px;color:#0f3e7c}
  .coach-metric{display:flex;justify-content:space-between;font-size:13px;color:#2c4f80}
  .coach-metric strong{color:#0f3e7c}
  .coach-suggestion{font-size:12px;color:#3260a3;line-height:1.4}
  .coach-section-headline{display:flex;align-items:center;justify-content:space-between;font-size:13px;color:#1f4f94;font-weight:600;gap:8px}
  .coach-icon-btn{background:#fff;border:1px solid #c8d9f4;border-radius:50%;width:32px;height:32px;display:grid;place-items:center;cursor:pointer;color:#1f4f94}
  .coach-icon-btn:hover{background:#edf4ff}
  .coach-tips{margin:0;padding-left:18px;display:flex;flex-direction:column;gap:6px;color:#2c4f80;font-size:13px}
  .coach-footer{text-align:center;font-size:11px;color:#4a6ba3;padding-bottom:10px;display:flex;flex-direction:column;gap:4px}
  .coach-summary{position:fixed;left:0;top:var(--topbar-height);width:var(--coach-summary-width);height:calc(100vh - var(--topbar-height));z-index:34;display:flex;align-items:center;justify-content:center;padding:0;background:rgba(255,255,255,.95);border:1px solid #c8d9f4;border-left:0;border-radius:0 14px 14px 0;box-shadow:var(--shadow);overflow:hidden;transition:box-shadow .2s ease,opacity .2s ease,background .2s ease}
  .coach-summary:focus-within{box-shadow:0 12px 28px rgba(10,102,194,.2)}
  .coach-summary.coach-open{opacity:0;pointer-events:none;box-shadow:none;background:transparent}
  .coach-summary-toggle{width:100%;height:100%;background:linear-gradient(180deg,#0a66c2,#084a91);color:#fff;border:0;border-radius:0;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:inset -1px 0 0 rgba(255,255,255,.25),0 6px 16px rgba(10,102,194,.25);transition:background .2s ease,box-shadow .2s ease}
  .coach-summary-toggle:hover,.coach-summary-toggle:focus-visible{background:linear-gradient(180deg,#0d7ae0,#0a5ab3);box-shadow:inset -1px 0 0 rgba(255,255,255,.3),0 8px 18px rgba(10,102,194,.28)}
  .coach-summary-toggle:focus-visible{outline:2px solid #0d7ae0;outline-offset:0}
  .coach-summary.coach-open .coach-summary-toggle{display:none}
  .coach-summary-chevron{font-size:20px;font-weight:700;line-height:1;text-shadow:0 1px 0 rgba(0,0,0,.25)}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  @media (max-width: 960px){:root{--coach-summary-width:28px}.coach-summary{padding:0}}
  .app.coach-open{margin-left:300px;padding-left:0}
  .coach-inner::-webkit-scrollbar{width:6px}
  .coach-inner::-webkit-scrollbar-thumb{background:rgba(10,102,194,.35);border-radius:999px}
  @media (max-width: 960px){.app.coach-open{margin-left:0}.sprint-coach{width:min(320px,85vw)}.coach-grid{grid-template-columns:1fr}}
  @media (max-width: 1100px){.board{max-width:100%;}}
  @media (max-width: 1024px){.board{--lanes-visible:2;--lane-gap:16px;scroll-padding:0 14px}}
  @media (max-width: 768px){.board{--lane-gap:14px}}
  @media (max-width: 640px){.board{--lanes-visible:1;--lane-gap:12px;padding-left:12px;padding-right:12px;scroll-padding:0 12px}.row{grid-template-columns:1fr}.pill{display:none}.lane{min-height:320px}.lane-add{font-size:14px;padding:11px 14px}}
</style>
</head>
<body>
<div class="app">
  <aside class="coach-summary" id="coachSummary" role="complementary" aria-label="Sprint coach summary">
    <button class="coach-summary-toggle" id="coachSummaryToggle" type="button" aria-controls="sprintCoachPanel" aria-expanded="false" aria-label="Open Sprint Coach">
      <span class="sr-only">Open Sprint Coach</span>
      <span class="coach-summary-chevron" aria-hidden="true">¬ª</span>
    </button>
  </aside>
  <aside class="sprint-coach" id="sprintCoachPanel" aria-hidden="true">
    <div class="coach-inner">
      <div class="coach-header">
        <div>
          <h2>üèÅ Sprint Coach</h2>
          <p class="coach-subtitle">Your daily guide to consistency and progress.</p>
          <p class="coach-profile" id="coachProfileLine">Hey there! You&rsquo;re 80% ready to sprint.</p>
        </div>
        <button class="coach-close" id="coachCloseBtn" type="button" aria-label="Close Sprint Coach">‚úï</button>
      </div>

      <section class="coach-section" aria-labelledby="coachGoalsTitle" id="coachGoalsSection">
        <div class="coach-section-title" id="coachGoalsTitle">Your Sprint Goals</div>
        <p class="coach-quote" id="coachQuoteText">Consistency beats intensity. One application today can change everything.</p>
        <button class="coach-mini-btn" id="newQuoteBtn" type="button">New quote</button>
        <div class="coach-goal-edit" id="coachGoalEditor">
          <div class="coach-goal-label">Daily goal</div>
          <button class="coach-goal-display" id="coachGoalDisplay" type="button" aria-controls="coachGoalForm" aria-expanded="false">
            <span class="coach-goal-text"><strong id="coachGoalValue">4</strong> applications / day</span>
            <span class="coach-goal-edit-icon" aria-hidden="true">‚úé</span>
            <span class="sr-only">Edit daily goal</span>
          </button>
          <form class="coach-goal-form" id="coachGoalForm" hidden>
            <label class="sr-only" for="coachGoalInput">Applications per day goal</label>
            <input class="coach-goal-input" id="coachGoalInput" name="goal" type="number" min="1" inputmode="numeric" />
            <div class="coach-goal-actions">
              <button class="coach-mini-btn outline" id="cancelGoalBtn" type="button">Cancel</button>
              <button class="coach-mini-btn" id="saveGoalBtn" type="submit">Save goal</button>
            </div>
          </form>
          <div class="coach-goal-status" id="coachGoalStatus">Set a target that feels achievable today.</div>
        </div>
        <div class="coach-progress">
          <div class="coach-progress-bar"><div class="coach-progress-fill" id="goalProgressFill"></div></div>
          <div class="coach-progress-text" id="goalProgressText">0 of 0 applications today</div>
        </div>
        <div class="coach-note" id="goalStreakText">Keep it going!</div>
      </section>

      <section class="coach-section" aria-labelledby="coachInsightsTitle">
        <div class="coach-section-title" id="coachInsightsTitle">Quick Insights</div>
        <div class="coach-grid" id="coachInsightsGrid"></div>
      </section>

      <section class="coach-section" aria-labelledby="coachHealthTitle">
        <div class="coach-section-title" id="coachHealthTitle">Career Health</div>
        <div class="coach-metric"><span>Resume Score</span><strong id="coachResumeScore">85</strong></div>
        <div class="coach-metric"><span>JD Fit Avg</span><strong id="coachJDFit">72</strong></div>
        <div class="coach-suggestion" id="coachSuggestion">Top suggestion: Add measurable outcomes in your Experience section.</div>
        <button class="coach-mini-btn outline" id="recheckResumeBtn" type="button">Recheck Resume</button>
      </section>

      <section class="coach-section" aria-labelledby="coachTipsTitle">
        <div class="coach-section-headline" id="coachTipsTitle"><span>Coach Tips</span>
          <button class="coach-icon-btn" id="refreshTipsBtn" type="button" aria-label="Refresh tips">‚ü≥</button>
        </div>
        <ul class="coach-tips" id="coachTipsList"></ul>
      </section>

      <footer class="coach-footer">
        <div>Powered by JobSprint</div>
        <div>AI insights coming soon ‚ú®</div>
      </footer>
    </div>
  </aside>
  <!-- top bar -->
  <div class="top">
    <div class="topin">
      <div class="brand">
        <div class="badge"><img src="logo_illustration.png" alt="JobSprint logo" loading="lazy"></div>
        <div>
          <div style="font-weight:700;">JobSprint</div>
          <div id="userLine" style="font-size:12px;color:#2c4f80;">Welcome back</div>
        </div>
      </div>
      <div class="navspacer"></div>
      <button class="pill-button" id="goalPill" type="button">Goal: <strong id="goalNum">4</strong> / day</button>
      <button class="ham" id="hamBtn">‚ò∞</button>
      <div class="dropdown" id="menu">
        <a href="onboarding.html">Edit profile</a>
        <a href="persona.html">Edit Persona</a>
        <a href="#" id="deleteAccountBtn">Delete account</a>
        <a href="#" id="signoutBtn">Sign out</a>
      </div>
    </div>
  </div>

  <!-- header stats -->
  <div class="head">
    <div class="stat">Today‚Äôs applications: <strong id="todayCount">0</strong></div>
    <div class="stat">This week: <strong id="weekCount">0</strong></div>
    <button class="btn ghost" id="resetBtn">Reset board</button>
  </div>

  <!-- board -->
  <div class="board" id="board">
    <div class="lane" data-col="research">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Research / To Apply</h3><span class="count" data-count="research">0</span></div>
        <p class="lane-desc">Track roles you&rsquo;re exploring, prepping, or yet to apply for.</p>
      </div>
      <div class="lane-actions">
        <button class="btn lane-add" id="addBtn" type="button">+ Add Application</button>
      </div>
      <div class="cards" data-drop="research"></div>
      <div class="empty">Drag Applications here</div>
    </div>
    <div class="lane" data-col="applied">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Applied</h3><span class="count" data-count="applied">0</span></div>
        <p class="lane-desc">Applications you&rsquo;ve submitted and are waiting to hear back on.</p>
      </div>
      <div class="cards" data-drop="applied"></div>
      <div class="empty">Drag Applications here</div>
    </div>
    <div class="lane" data-col="screening">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Screening</h3><span class="count" data-count="screening">0</span></div>
        <p class="lane-desc">Move your application to this stage when a recruiter has replied or requested more information.</p>
      </div>
      <div class="cards" data-drop="screening"></div>
      <div class="empty">Drag Applications here</div>
    </div>
    <div class="lane" data-col="interviewing">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Interviewing</h3><span class="count" data-count="interviewing">0</span></div>
        <p class="lane-desc">Move your application to this stage when interviews have been scheduled or are in progress.</p>
      </div>
      <div class="cards" data-drop="interviewing"></div>
      <div class="empty">Drag Applications here</div>
    </div>
    <div class="lane" data-col="offer">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Offer Received</h3><span class="count" data-count="offer">0</span></div>
        <p class="lane-desc">Move your application to this stage when you&rsquo;ve received a verbal or written offer.</p>
      </div>
      <div class="cards" data-drop="offer"></div>
      <div class="empty">Drag Applications here</div>
    </div>
    <div class="lane" data-col="rejected">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Rejected</h3><span class="count" data-count="rejected">0</span></div>
        <p class="lane-desc">Move your application to this stage when the process didn&rsquo;t move forward or the company declined your application.</p>
      </div>
      <div class="cards" data-drop="rejected"></div>
      <div class="empty">Drag Applications here</div>
    </div>
  </div>
</div>

<!-- modal -->
<div class="modalBG" id="modalBG" aria-hidden="true">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title-block">
        <h3 id="modalTitle">New Application</h3>
        <div class="stage-meta" id="stageDetailsContent"></div>
      </div>
        <button class="modal-close" id="modalCloseBtn" type="button" aria-label="Close">‚úï</button>
    </div>
    <div class="row">
      <div>
        <label>Company</label>
        <input id="m_company" placeholder="Acme Inc."/>
      </div>
      <div>
        <label>Role</label>
        <input id="m_role" placeholder="Product Manager"/>
      </div>
      <div>
        <label>JD link</label>
        <input id="m_link" placeholder="https://..."/>
      </div>
      <div>
        <label>Deadline (optional)</label>
        <input type="date" id="m_deadline"/>
      </div>
    </div>
    <label style="margin-top:10px">Notes</label>
    <textarea id="m_notes" placeholder="Anything important about this application..."></textarea>

    <div class="section job-fit" id="jobFitSection">
      <div class="job-fit-head">
        <div>
          <h4>Job Description &amp; Fit</h4>
          <p class="job-fit-copy">Paste the JD and analyze how well you match before saving.</p>
        </div>
        <button class="btn ghost" id="analyzeFitBtn" type="button" style="align-self:flex-start">Analyze Fit</button>
      </div>
      <textarea id="m_jobdesc" placeholder="Paste JD here"></textarea>
      <div class="fit-results" id="fitResults" style="display:none"></div>
    </div>

    <div class="section" id="questionsSection">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px">
        <h4 style="margin:0">Application Questions</h4>
        <button class="btn ghost" type="button" id="openChatBtn" style="white-space:nowrap">Open AI Chat</button>
      </div>
      <div class="questions-add">
        <input id="questionInput" placeholder="Add question"/>
        <button class="btn" type="button" id="addQuestionBtn">Add</button>
      </div>
      <div id="questionsList"></div>
    </div>

    <div class="actions">
      <button class="btn ghost" id="deleteBtn" style="margin-right:auto;display:none">Delete</button>
      <button class="btn ghost" id="markAppliedBtn" style="display:none">Mark as Applied</button>
      <button class="btn" id="saveBtn">Add</button>
    </div>
  </div>
</div>

<div class="drawerBG" id="chatDrawer" aria-hidden="true">
  <div class="drawer">
    <div class="drawer-head">
      <h4>AI Chat Assistant</h4>
      <button class="btn ghost" id="closeChatBtn" style="padding:6px 10px;font-size:12px">Close</button>
    </div>
    <div class="drawer-body" id="chatBody"></div>
    <div class="drawer-input">
      <textarea id="chatInput" placeholder="Ask the assistant anything about this application..."></textarea>
      <button class="btn" id="chatSendBtn">Send</button>
    </div>
  </div>
</div>


<script src="scripts/theme.js"></script>
<script src="scripts/ats-scorer.js"></script>
<script>
  const qs = new URLSearchParams(location.search);
  const token = qs.get('u') || (JSON.parse(localStorage.getItem('jobsprint_profile')||'{}').token) || 'guest';

  if (!token || token === 'guest') {
    location.href = '/signup.html?mode=login';
  }

  const KEY_BOARD = `jobsprint_board_${token}`;
  const KEY_TODAY = `jobsprint_today_${token}`;
  let profile = JSON.parse(localStorage.getItem('jobsprint_profile') || '{}');

  const motivationalQuotes = [
    'Consistency beats intensity. One application today can change everything.',
    'Small sprints build big wins üí™',
    'Stack tiny moments of focus and the offers will follow.',
    'Your future self is thanking you for showing up right now.',
    'Keep the momentum‚Äîprogress loves persistence.'
  ];

  const coachTipsPool = [
    'Follow up on applications you sent 3 days ago.',
    'Try customizing your resume for top-fit JDs.',
    'Review your job sprint board once before bed.',
    'Reach out to a new connection in your target industry today.',
    'Share a quick win with an accountability buddy.',
    'Block 20 minutes tonight to prep for tomorrow‚Äôs sprint.'
  ];

  const GOAL_STATUS_DEFAULT = 'Set a target that feels achievable today.';

  function getDailyGoalTarget() {
    const raw = profile?.applications_goal_per_day ?? profile?.goal_per_day;
    const parsed = Number.parseInt(raw, 10);
    if (Number.isFinite(parsed) && parsed > 0) {
      return parsed;
    }
    return 4;
  }

  function syncGoalUI() {
    const goalValue = getDailyGoalTarget();
    if (goalNum) goalNum.textContent = goalValue;
    if (coachGoalValue) coachGoalValue.textContent = goalValue;
    if (coachGoalInput && document.activeElement !== coachGoalInput) {
      coachGoalInput.value = goalValue;
    }
  }

  function shortenSummaryText(text, max = 24) {
    if (!text) return '';
    return text.length > max ? `${text.slice(0, max - 1)}‚Ä¶` : text;
  }

  function formatInsightBadge(item) {
    if (!item) return 'Pending';
    const { label, value } = item;
    switch (label) {
      case 'Applications Added':
        return `Added ${value}`;
      case 'Responses Received':
        return `Replies ${value}`;
      case 'Interviews Scheduled':
        return `Interviews ${value}`;
      case 'Average Fit Score':
        return `Fit ${value}`;
      default:
        return shortenSummaryText(`${label}: ${value}`);
    }
  }

  function getMotivationalQuote(prevIndex = -1) {
    if (!motivationalQuotes.length) {
      return { text: 'You have everything you need to take the next step.', index: -1 };
    }
    let idx = Math.floor(Math.random() * motivationalQuotes.length);
    if (motivationalQuotes.length > 1) {
      while (idx === prevIndex) {
        idx = Math.floor(Math.random() * motivationalQuotes.length);
      }
    }
    return { text: motivationalQuotes[idx], index: idx };
  }

  function getCoachTips() {
    if (!coachTipsPool.length) return ['Celebrate a recent win to stay energized.'];
    const tips = [];
    const used = new Set();
    while (tips.length < 3 && used.size < coachTipsPool.length) {
      const choice = Math.floor(Math.random() * coachTipsPool.length);
      if (used.has(choice)) continue;
      used.add(choice);
      tips.push(coachTipsPool[choice]);
    }
    return tips;
  }

  function getGoalProgress() {
    const today = loadToday();
    const completed = Math.max(Number.parseInt(today?.count, 10) || 0, 0);
    const streakRaw = today?.streakDays ?? today?.streak ?? 0;
    const streakDays = Math.max(Number.parseInt(streakRaw, 10) || 0, 0);
    return {
      dailyTarget: Math.max(getDailyGoalTarget(), 0),
      completed,
      streakDays
    };
  }

  function getUserSprintStats() {
    return {
      applicationsAdded: 12,
      responsesReceived: 3,
      interviewsScheduled: 1,
      averageFitScore: 76
    };
  }

  const WORKSPACE_ATS_FALLBACK = {
    score: 78,
    level: 'good',
    fixes: [
      "Add clear 'Work Experience' and 'Education' headers.",
      'Reduce resume length to 1‚Äì2 pages.',
      'Avoid using tables or columns that confuse ATS scanners.'
    ],
    topSuggestion: "Add clear 'Work Experience' and 'Education' headers.",
    coachNote: 'Good structure ‚Äî a quick tune-up will make it shine.',
    fingerprint: null
  };

  const computeResumeFingerprint = (text) => {
    if (!text) return null;
    const clean = String(text).replace(/\s+/g, ' ').trim();
    return clean ? `${clean.length}:${clean.slice(0, 120).toLowerCase()}` : null;
  };

  const cloneDiagnostic = (diagnostic) => {
    if (!diagnostic || typeof diagnostic !== 'object') return null;
    try {
      return JSON.parse(JSON.stringify(diagnostic));
    } catch (err) {
      console.warn('Could not clone ATS diagnostic', err);
      return { ...diagnostic };
    }
  };

  const runATSAnalysis = (profile, fingerprint) => {
    const resumeText = typeof profile?.resume_text === 'string' ? profile.resume_text : '';
    const role = profile?.role || profile?.target_role;
    let diagnostic = null;
    if (window.JobSprintATS && typeof window.JobSprintATS.analyzeResume === 'function') {
      try {
        diagnostic = window.JobSprintATS.analyzeResume({
          text: resumeText,
          role,
          experience: profile?.experience,
          location: profile?.city
        });
      } catch (err) {
        console.warn('ATS analysis failed', err);
      }
    }
    if (!diagnostic) {
      diagnostic = { ...WORKSPACE_ATS_FALLBACK };
    } else {
      diagnostic = cloneDiagnostic(diagnostic) || diagnostic;
    }
    if (fingerprint && !diagnostic.fingerprint) {
      diagnostic.fingerprint = fingerprint;
    }
    return diagnostic;
  };

  const persistATSDiagnostic = (profile, diagnostic) => {
    const safeProfile = profile && typeof profile === 'object' ? { ...profile } : {};
    if (!diagnostic || typeof diagnostic !== 'object') return safeProfile;
    const storedDiagnostic = cloneDiagnostic(diagnostic) || diagnostic;
    const nextProfile = {
      ...safeProfile,
      ats_readiness: storedDiagnostic.score,
      top_suggestion: storedDiagnostic.topSuggestion || safeProfile.top_suggestion || WORKSPACE_ATS_FALLBACK.topSuggestion,
      ats_diagnostic: storedDiagnostic
    };
    try {
      localStorage.setItem('jobsprint_profile', JSON.stringify(nextProfile));
    } catch (err) {
      console.warn('Unable to persist ATS diagnostic', err);
    }
    return nextProfile;
  };

  function getATSScore() {
    let storedProfile = {};
    try {
      storedProfile = JSON.parse(localStorage.getItem('jobsprint_profile') || '{}');
    } catch (_) {
      storedProfile = {};
    }
    const userName = storedProfile?.name || 'Sprinter';
    const resumeText = typeof storedProfile?.resume_text === 'string' ? storedProfile.resume_text : '';
    const fingerprint = computeResumeFingerprint(resumeText);
    let diagnostic = storedProfile?.ats_diagnostic;
    const needsRecompute =
      !!resumeText && (
        !diagnostic ||
        typeof diagnostic.score !== 'number' ||
        (fingerprint && diagnostic.fingerprint !== fingerprint)
      );

    if (needsRecompute) {
      diagnostic = runATSAnalysis(storedProfile, fingerprint);
      storedProfile = persistATSDiagnostic(storedProfile, diagnostic);
    } else if (!diagnostic || typeof diagnostic.score !== 'number') {
      diagnostic = {
        ...WORKSPACE_ATS_FALLBACK,
        score: typeof storedProfile?.ats_readiness === 'number' ? storedProfile.ats_readiness : WORKSPACE_ATS_FALLBACK.score,
        topSuggestion: storedProfile?.top_suggestion || WORKSPACE_ATS_FALLBACK.topSuggestion,
        fingerprint: diagnostic?.fingerprint || fingerprint || WORKSPACE_ATS_FALLBACK.fingerprint
      };
    }

    const atsScore = typeof diagnostic.score === 'number' ? Math.round(diagnostic.score) : Math.round(WORKSPACE_ATS_FALLBACK.score);
    const resumeScore = typeof storedProfile?.resume_score === 'number' ? Math.round(storedProfile.resume_score) : atsScore;
    const jdFitAvg = typeof storedProfile?.jd_fit_avg === 'number' ? Math.round(storedProfile.jd_fit_avg) : 72;
    const topSuggestion = diagnostic.topSuggestion || storedProfile?.top_suggestion || WORKSPACE_ATS_FALLBACK.topSuggestion;
    return { userName, atsScore, resumeScore, jdFitAvg, topSuggestion };
  }

  const COLUMNS = ['research','applied','screening','interviewing','offer','rejected'];
  const LANE_TITLES = {
    research: 'Research / To Apply',
    applied: 'Applied',
    screening: 'Screening',
    interviewing: 'Interviewing',
    offer: 'Offer Received',
    rejected: 'Rejected'
  };
  const STOP_WORDS = new Set(['about','above','after','again','against','all','also','am','an','and','any','are','as','at','be','because','been','before','being','below','between','both','but','by','can','could','did','do','does','doing','down','during','each','few','for','from','further','had','has','have','having','he','her','here','hers','herself','him','himself','his','how','if','in','into','is','it','its','itself','just','more','most','my','myself','no','nor','not','now','of','off','on','once','only','or','other','our','ours','ourselves','out','over','own','same','she','should','so','some','such','than','that','the','their','theirs','them','themselves','then','there','these','they','this','those','through','to','too','under','until','up','very','was','we','were','what','when','where','which','while','who','whom','why','will','with','you','your','yours','yourself','yourselves']);

  const notify = (message, options) => {
    if (window.JobSprintUI && typeof window.JobSprintUI.showToast === 'function') {
      return window.JobSprintUI.showToast(message, options || {});
    }
    return null;
  };

  const notifyLoading = (message, options) => {
    if (window.JobSprintUI && typeof window.JobSprintUI.showLoadingToast === 'function') {
      return window.JobSprintUI.showLoadingToast(message, options || {});
    }
    return null;
  };

  const redirectWithToast = (url, message) => {
    const toast = notifyLoading(message || 'Redirecting‚Ä¶');
    setTimeout(() => {
      toast?.update?.('Almost there‚Ä¶');
      window.location.href = url;
    }, 180);
  };

  function generateId(prefix='c') {
    return `${prefix}_${Math.random().toString(16).slice(2)}${Date.now().toString(16)}`;
  }

  function getFitBand(score) {
    if (score >= 80) return 'High';
    if (score >= 60) return 'Medium';
    return 'Low';
  }

  function createBlankCard() {
    return {
      company: '',
      role: '',
      link: '',
      deadline: '',
      notes: '',
      jobDescription: '',
      resumeVersion: 'Resume v1',
      savedAt: Date.now(),
      fit: { score: null, band: '', matches: [], missing: [] },
      appliedInfo: { date: '', source: '' },
      screeningInfo: { replied: false, assessmentDue: '', infoShared: '' },
      interviewingRounds: [],
      offerInfo: { ctc: '', joiningDate: '', status: '' },
      rejectedInfo: { reason: '', date: '' },
      questions: [],
      created_at: Date.now()
    };
  }

  function upgradeCard(card) {
    if (!card) return { ...createBlankCard(), id: generateId('c') };
    const upgraded = { ...createBlankCard() };
    upgraded.id = card.id || generateId('c');
    upgraded.company = card.company || '';
    upgraded.role = card.role || '';
    upgraded.link = card.link || '';
    upgraded.deadline = card.deadline || '';
    upgraded.notes = card.notes || '';
    upgraded.jobDescription = card.jobDescription || card.job_description || '';
    upgraded.resumeVersion = card.resumeVersion || card.resume_version || upgraded.resumeVersion;
    upgraded.savedAt = card.savedAt || card.saved_at || card.created_at || upgraded.savedAt;
    upgraded.created_at = card.created_at || upgraded.created_at;
    if (card.fit || typeof card.fit_score === 'number') {
      const fitScore = card.fit?.score ?? card.fit_score;
      upgraded.fit.score = typeof fitScore === 'number' ? Math.max(0, Math.min(100, Math.round(fitScore))) : null;
      upgraded.fit.matches = Array.isArray(card.fit?.matches) ? card.fit.matches : (Array.isArray(card.fit_matches) ? card.fit_matches : []);
      upgraded.fit.missing = Array.isArray(card.fit?.missing) ? card.fit.missing : (Array.isArray(card.fit_missing) ? card.fit_missing : []);
      upgraded.fit.band = card.fit?.band || (upgraded.fit.score != null ? getFitBand(upgraded.fit.score) : '');
    }
    upgraded.appliedInfo = {
      date: card.appliedInfo?.date || card.applied_date || '',
      source: card.appliedInfo?.source || card.source || ''
    };
    upgraded.screeningInfo = {
      replied: card.screeningInfo?.replied ?? false,
      assessmentDue: card.screeningInfo?.assessmentDue || card.assessment_due || '',
      infoShared: card.screeningInfo?.infoShared || card.info_shared || ''
    };
    upgraded.interviewingRounds = Array.isArray(card.interviewingRounds)
      ? card.interviewingRounds.map(r => ({ id: r.id || generateId('r'), name: r.name || '', datetime: r.datetime || '' }))
      : [];
    upgraded.offerInfo = {
      ctc: card.offerInfo?.ctc || card.ctc || '',
      joiningDate: card.offerInfo?.joiningDate || card.joiningDate || '',
      status: card.offerInfo?.status || card.offer_status || ''
    };
    upgraded.rejectedInfo = {
      reason: card.rejectedInfo?.reason || card.rejectionReason || '',
      date: card.rejectedInfo?.date || card.rejectionDate || ''
    };
    upgraded.questions = Array.isArray(card.questions)
      ? card.questions.map(q => ({ id: q.id || generateId('q'), prompt: q.prompt || '', answer: q.answer || '' }))
      : [];
    return upgraded;
  }

  function emptyBoard() {
    return COLUMNS.reduce((acc, col) => { acc[col] = []; return acc; }, {});
  }

  function normalizeBoard(raw) {
    const shaped = emptyBoard();
    if (!raw || typeof raw !== 'object') return shaped;
    if ('to_apply' in raw) {
      shaped.research = (raw.to_apply || []).map(upgradeCard);
      shaped.applied = (raw.applied || []).map(upgradeCard);
      shaped.screening = (raw.screening || []).map(upgradeCard);
      shaped.interviewing = (raw.interviewing || []).map(upgradeCard);
      shaped.offer = (raw.offer || []).map(upgradeCard);
      shaped.rejected = (raw.rejected || []).map(upgradeCard);
      return shaped;
    }
    COLUMNS.forEach(col => {
      if (Array.isArray(raw[col])) {
        shaped[col] = raw[col].map(upgradeCard);
      }
    });
    return shaped;
  }

  let board = normalizeBoard(JSON.parse(localStorage.getItem(KEY_BOARD) || 'null'));

  const userLine = document.getElementById('userLine');
  const goalNum = document.getElementById('goalNum');
  const goalPill = document.getElementById('goalPill');
  const todayCountEl = document.getElementById('todayCount');
  const weekCountEl = document.getElementById('weekCount');
  const sprintCoachPanel = document.getElementById('sprintCoachPanel');
  const coachCloseBtn = document.getElementById('coachCloseBtn');
  const coachSummary = document.getElementById('coachSummary');
  const coachSummaryToggle = document.getElementById('coachSummaryToggle');
  const coachSummaryProgressValue = document.getElementById('coachSummaryProgressValue');
  const coachSummaryProgressNote = document.getElementById('coachSummaryProgressNote');
  const coachSummaryInsight = document.getElementById('coachSummaryInsight');
  const coachSummaryResume = document.getElementById('coachSummaryResume');
  const coachSummaryJDFit = document.getElementById('coachSummaryJDFit');
  const coachSummaryTip = document.getElementById('coachSummaryTip');
  const coachProfileLine = document.getElementById('coachProfileLine');
  const coachQuoteText = document.getElementById('coachQuoteText');
  const newQuoteBtn = document.getElementById('newQuoteBtn');
  const coachGoalsSection = document.getElementById('coachGoalsSection');
  const coachGoalValue = document.getElementById('coachGoalValue');
  const coachGoalDisplay = document.getElementById('coachGoalDisplay');
  const coachGoalForm = document.getElementById('coachGoalForm');
  const coachGoalInput = document.getElementById('coachGoalInput');
  const cancelGoalBtn = document.getElementById('cancelGoalBtn');
  const saveGoalBtn = document.getElementById('saveGoalBtn');
  const coachGoalStatus = document.getElementById('coachGoalStatus');
  const goalProgressFill = document.getElementById('goalProgressFill');
  const goalProgressText = document.getElementById('goalProgressText');
  const goalStreakText = document.getElementById('goalStreakText');
  const coachInsightsGrid = document.getElementById('coachInsightsGrid');
  const coachResumeScore = document.getElementById('coachResumeScore');
  const coachJDFit = document.getElementById('coachJDFit');
  const coachSuggestion = document.getElementById('coachSuggestion');
  const recheckResumeBtn = document.getElementById('recheckResumeBtn');
  const coachTipsList = document.getElementById('coachTipsList');
  const refreshTipsBtn = document.getElementById('refreshTipsBtn');
  const appShell = document.querySelector('.app');

  let currentQuoteIndex = -1;
  let lastCoachTips = [];

  function setCoachOpen(open) {
    if (!sprintCoachPanel) return;
    sprintCoachPanel.classList.toggle('open', open);
    sprintCoachPanel.setAttribute('aria-hidden', open ? 'false' : 'true');
    if (appShell) appShell.classList.toggle('coach-open', open);
    if (coachSummaryToggle) {
      coachSummaryToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
      coachSummaryToggle.setAttribute('aria-label', open ? 'Sprint Coach is open' : 'Open Sprint Coach');
      coachSummaryToggle.disabled = open;
    }
    if (coachSummary) {
      coachSummary.classList.toggle('coach-open', open);
    }
  }

  function setGoalStatus(message, isError = false) {
    if (!coachGoalStatus) return;
    coachGoalStatus.textContent = message;
    coachGoalStatus.classList.toggle('error', !!isError);
  }

  function toggleGoalEditor(show) {
    if (!coachGoalForm || !coachGoalDisplay) return;
    coachGoalForm.hidden = !show;
    coachGoalDisplay.hidden = show;
    coachGoalDisplay.setAttribute('aria-expanded', show ? 'true' : 'false');
    if (show && coachGoalInput) {
      coachGoalInput.value = getDailyGoalTarget();
      requestAnimationFrame(() => {
        coachGoalInput.focus();
        coachGoalInput.select?.();
      });
    }
  }

  let goalSaveInFlight = false;

  function setGoalSaving(saving) {
    goalSaveInFlight = saving;
    if (saveGoalBtn) {
      saveGoalBtn.disabled = saving;
      saveGoalBtn.textContent = saving ? 'Saving‚Ä¶' : 'Save goal';
    }
    if (cancelGoalBtn) {
      cancelGoalBtn.disabled = saving;
    }
    if (coachGoalDisplay) {
      coachGoalDisplay.disabled = saving;
    }
  }

  async function persistDailyGoal(newGoal) {
    const numericGoal = Math.max(Number.parseInt(newGoal, 10) || 0, 0);
    if (!numericGoal) {
      throw new Error('Enter a number greater than 0.');
    }

    const payload = {
      google_id: profile?.google_id,
      email: profile?.email,
      applications_goal_per_day: numericGoal,
      allow_payment_pending: true
    };

    if (!payload.google_id || !payload.email) {
      profile = { ...(profile || {}), applications_goal_per_day: numericGoal, goal_per_day: numericGoal };
      try { localStorage.setItem('jobsprint_profile', JSON.stringify(profile)); } catch (_) {}
      syncGoalUI();
      renderGoalProgress();
      return;
    }

    const res = await fetch('/api/create-user', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      let detail = 'Unable to update goal right now.';
      try {
        const data = await res.json();
        detail = data?.message || data?.error || detail;
      } catch (_) {
        detail = 'Unable to update goal right now.';
      }
      throw new Error(detail);
    }

    profile = { ...(profile || {}), applications_goal_per_day: numericGoal, goal_per_day: numericGoal };
    try { localStorage.setItem('jobsprint_profile', JSON.stringify(profile)); } catch (_) {}
    syncGoalUI();
    renderGoalProgress();
  }

  function showNewQuote() {
    const { text, index } = getMotivationalQuote(currentQuoteIndex);
    currentQuoteIndex = index;
    if (coachQuoteText) coachQuoteText.textContent = text;
  }

  function renderGoalProgress() {
    syncGoalUI();
    const goal = getGoalProgress();
    const target = Math.max(goal.dailyTarget || 0, 0);
    const completed = Math.max(goal.completed || 0, 0);
    const percent = target > 0 ? Math.min(100, Math.round((completed / target) * 100)) : 0;
    const summaryProgress = `${completed} / ${target}`;
    const streak = Math.max(goal.streakDays || 0, 0);
    const streakMessage = streak
      ? `You‚Äôre on a ${streak}-day streak üî• Keep it going!`
      : 'Start a new streak today‚Äîyou got this!';
    const streakSummary = streak ? `${streak} day${streak === 1 ? '' : 's'}` : '0 days';
    if (goalProgressFill) goalProgressFill.style.width = `${percent}%`;
    if (goalProgressText) goalProgressText.textContent = `${completed} of ${target} applications today`;
    if (goalStreakText) goalStreakText.textContent = streakMessage;
    if (coachSummaryProgressValue) coachSummaryProgressValue.textContent = summaryProgress;
    if (coachSummaryProgressNote) coachSummaryProgressNote.textContent = streakSummary;
  }

  function renderInsights() {
    if (!coachInsightsGrid) return;
    coachInsightsGrid.innerHTML = '';
    const stats = getUserSprintStats();
    const items = [
      { label: 'Applications Added', value: stats.applicationsAdded },
      { label: 'Responses Received', value: stats.responsesReceived },
      { label: 'Interviews Scheduled', value: stats.interviewsScheduled },
      { label: 'Average Fit Score', value: `${stats.averageFitScore}%` }
    ];
    items.forEach(({ label, value }) => {
      const card = document.createElement('div');
      card.className = 'coach-stat';
      const title = document.createElement('span');
      title.textContent = label;
      const strong = document.createElement('strong');
      strong.textContent = value;
      card.append(strong, title);
      coachInsightsGrid.appendChild(card);
    });
    if (coachSummaryInsight) coachSummaryInsight.textContent = formatInsightBadge(items[0]);
  }

  function renderCareerHealth() {
    const { userName, atsScore, resumeScore, jdFitAvg, topSuggestion } = getATSScore();
    if (coachProfileLine) coachProfileLine.textContent = `Hey, ${userName}! You‚Äôre ${atsScore}% ready to sprint.`;
    if (coachResumeScore) coachResumeScore.textContent = resumeScore;
    if (coachJDFit) coachJDFit.textContent = jdFitAvg;
    if (coachSuggestion) coachSuggestion.textContent = `Top suggestion: ${topSuggestion}`;
    if (coachSummaryResume) coachSummaryResume.textContent = String(resumeScore);
    if (coachSummaryJDFit) coachSummaryJDFit.textContent = String(jdFitAvg);
  }

  function renderCoachTips(forceNew = false) {
    if (!coachTipsList) return;
    if (!lastCoachTips.length || forceNew) {
      lastCoachTips = getCoachTips();
    }
    coachTipsList.innerHTML = '';
    lastCoachTips.forEach(tip => {
      const item = document.createElement('li');
      item.textContent = tip;
      coachTipsList.appendChild(item);
    });
    if (coachSummaryTip) {
      const primaryTip = lastCoachTips[0];
      coachSummaryTip.textContent = primaryTip ? shortenSummaryText(primaryTip, 26) : 'Loading';
    }
  }

  function hydrateSprintCoach() {
    if (!sprintCoachPanel) return;
    if (currentQuoteIndex === -1) showNewQuote();
    else if (coachQuoteText && motivationalQuotes[currentQuoteIndex]) {
      coachQuoteText.textContent = motivationalQuotes[currentQuoteIndex];
    }
    renderGoalProgress();
    renderInsights();
    renderCareerHealth();
    renderCoachTips();
  }

  function initSprintCoach() {
    if (!sprintCoachPanel) return;
    setCoachOpen(false);
    hydrateSprintCoach();
    coachCloseBtn?.addEventListener('click', () => setCoachOpen(false));
    coachSummaryToggle?.addEventListener('click', () => setCoachOpen(true));
    newQuoteBtn?.addEventListener('click', () => {
      showNewQuote();
    });
    refreshTipsBtn?.addEventListener('click', () => {
      renderCoachTips(true);
    });
    recheckResumeBtn?.addEventListener('click', () => {
      location.href = `/sprint-readiness.html?u=${encodeURIComponent(token)}`;
    });
  }

  syncGoalUI();
  setGoalStatus(GOAL_STATUS_DEFAULT);
  initSprintCoach();

  coachGoalDisplay?.addEventListener('click', () => {
    setGoalStatus('Update your daily target to stay on track.');
    toggleGoalEditor(true);
  });

  cancelGoalBtn?.addEventListener('click', () => {
    toggleGoalEditor(false);
    syncGoalUI();
    setGoalStatus(GOAL_STATUS_DEFAULT);
    if (coachGoalDisplay) {
      requestAnimationFrame(() => coachGoalDisplay.focus({ preventScroll: true }));
    }
  });

  coachGoalForm?.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (goalSaveInFlight) return;
    const desiredGoal = coachGoalInput?.value ?? getDailyGoalTarget();
    const numericDesired = Number.parseInt(desiredGoal, 10);
    if (Number.isFinite(numericDesired) && numericDesired === getDailyGoalTarget()) {
      toggleGoalEditor(false);
      setGoalStatus('Goal unchanged‚Äîstay consistent!');
      if (coachGoalDisplay) {
        requestAnimationFrame(() => coachGoalDisplay.focus({ preventScroll: true }));
      }
      return;
    }
    setGoalSaving(true);
    setGoalStatus('Saving your goal‚Ä¶');
    try {
      await persistDailyGoal(desiredGoal);
      toggleGoalEditor(false);
      setGoalStatus('Daily goal updated üéØ');
      if (coachGoalDisplay) {
        requestAnimationFrame(() => coachGoalDisplay.focus({ preventScroll: true }));
      }
    } catch (err) {
      const msg = err instanceof Error ? err.message : 'Unable to update goal right now.';
      setGoalStatus(msg, true);
      coachGoalInput?.focus();
    } finally {
      setGoalSaving(false);
    }
  });

  goalPill?.addEventListener('click', () => {
    setCoachOpen(true);
    if (coachGoalsSection) {
      coachGoalsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    setTimeout(() => {
      if (coachGoalDisplay && coachGoalForm?.hidden) {
        coachGoalDisplay.focus({ preventScroll: true });
      } else if (coachGoalInput && !coachGoalForm?.hidden) {
        coachGoalInput.focus({ preventScroll: true });
      }
    }, 250);
  });

  (async () => {
    try {
      const r = await fetch('/api/get-user-by-token?token=' + encodeURIComponent(token), { headers: { 'cache-control': 'no-cache' } });
      if (r.ok) {
        const data = await r.json();
        if (data.found) {
          const merged = { ...(profile || {}), name: data.name, email: data.email, applications_goal_per_day: data.goal_per_day, google_id: data.google_id, token };
          profile = merged;
          localStorage.setItem('jobsprint_profile', JSON.stringify(merged));
          userLine.textContent = data.name ? `Hello, ${data.name}` : 'Welcome back';
          syncGoalUI();
          hydrateSprintCoach();
          return;
        }
      }
      userLine.textContent = profile?.name ? `Hello, ${profile.name}` : 'Welcome back';
      syncGoalUI();
      hydrateSprintCoach();
    } catch {
      userLine.textContent = profile?.name ? `Hello, ${profile.name}` : 'Welcome back';
      syncGoalUI();
      hydrateSprintCoach();
    }
  })();

  function saveBoard() {
    localStorage.setItem(KEY_BOARD, JSON.stringify(board));
  }

  function clearLocalUserData() {
    try { localStorage.removeItem(KEY_BOARD); } catch (_) {}
    try { localStorage.removeItem(KEY_TODAY); } catch (_) {}
    try { localStorage.removeItem('jobsprint_profile'); } catch (_) {}
  }

  function formatShortDate(input) {
    if (!input) return '';
    const date = typeof input === 'number' ? new Date(input) : new Date(input);
    if (Number.isNaN(date.getTime())) return '';
    return date.toLocaleDateString(undefined, { day: '2-digit', month: 'short' });
  }

  function formatDateTimeDisplay(value) {
    if (!value) return '';
    const dt = new Date(value);
    if (Number.isNaN(dt.getTime())) return value;
    const day = dt.toLocaleDateString(undefined, { weekday: 'short' });
    const time = dt.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
    return `${day} ${time}`;
  }

  function escapeHtml(str) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' };
    return (str || '').replace(/[&<>"']/g, ch => map[ch] || ch);
  }

  function getCardBadges(card, stage) {
    const badges = [];
    if (stage === 'research') {
      if (card.fit?.score != null) badges.push(`Fit Score ${card.fit.score}%`);
      if (card.resumeVersion) badges.push(card.resumeVersion);
      const saved = formatShortDate(card.savedAt);
      if (saved) badges.push(`Saved ${saved}`);
    } else if (stage === 'applied') {
      const appliedDate = card.appliedInfo?.date || '';
      const formatted = formatShortDate(appliedDate);
      if (formatted) badges.push(`Applied ${formatted}`);
      if (card.appliedInfo?.source) badges.push(`Source: ${card.appliedInfo.source}`);
    } else if (stage === 'screening') {
      if (card.screeningInfo?.replied) badges.push('Replied');
      const due = formatShortDate(card.screeningInfo?.assessmentDue);
      if (due) badges.push(`Assessment due ${due}`);
      if (card.screeningInfo?.infoShared) badges.push('Info shared');
    } else if (stage === 'interviewing') {
      (card.interviewingRounds || []).forEach(round => {
        if (!round) return;
        const name = round.name || 'Round';
        const schedule = formatDateTimeDisplay(round.datetime);
        badges.push(`${name}${schedule ? ` ${schedule}` : ''}`.trim());
      });
    } else if (stage === 'offer') {
      if (card.offerInfo?.ctc) badges.push(`CTC: ${card.offerInfo.ctc}`);
      const joining = formatShortDate(card.offerInfo?.joiningDate);
      if (joining) badges.push(`Joining ${joining}`);
      if (card.offerInfo?.status) badges.push(`Status: ${card.offerInfo.status}`);
    } else if (stage === 'rejected') {
      if (card.rejectedInfo?.reason) badges.push(`Reason: ${card.rejectedInfo.reason}`);
      const rejectDate = formatShortDate(card.rejectedInfo?.date);
      if (rejectDate) badges.push(`Date ${rejectDate}`);
    }
    return badges.filter(Boolean);
  }

  function cardHTML(card, stage) {
    const header = `<div class="card-header"><strong>${escapeHtml(card.company || 'Company')}</strong> ‚Äî <span class="card-role">${escapeHtml(card.role || 'Role TBD')}</span></div>`;
    const badges = getCardBadges(card, stage);
    const visible = badges.slice(0, 5).map(text => `<span class="card-badge">${escapeHtml(text)}</span>`).join('');
    const overflow = badges.length > 5 ? `<span class="card-badge more">+${badges.length - 5}</span>` : '';
    const linkUrl = card.link ? escapeHtml(card.link) : '';
    const link = card.link ? `<div><small><a href="${linkUrl}" target="_blank" rel="noopener">Job link</a></small></div>` : '';
    const notes = card.notes ? `<div style="color:#3b5a85;font-size:13px">${escapeHtml(card.notes).replace(/\n/g,'<br/>')}</div>` : '';
    return `
      <div class="card" draggable="true" data-id="${card.id}">
        ${header}
        ${badges.length ? `<div class="card-badges">${visible}${overflow}</div>` : ''}
        ${link}
        ${notes}
      </div>
    `;
  }

  function updateCounts() {
    COLUMNS.forEach(col => {
      const count = board[col].length;
      const badge = document.querySelector(`[data-count="${col}"]`);
      if (badge) badge.textContent = count;
      const lane = document.querySelector(`.lane[data-col="${col}"]`);
      if (lane) lane.querySelector('.empty').style.display = count ? 'none' : 'grid';
    });
  }

  function renderBoard() {
    COLUMNS.forEach(col => {
      const wrap = document.querySelector(`[data-drop="${col}"]`);
      if (!wrap) return;
      wrap.innerHTML = board[col].map(card => cardHTML(card, col)).join('');
    });
    updateCounts();
    enableDnD();
    attachCardActions();
  }

  function enableDnD() {
    document.querySelectorAll('.card').forEach(el => {
      el.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', el.getAttribute('data-id'));
        setTimeout(() => el.style.opacity = 0.5, 0);
      });
      el.addEventListener('dragend', () => el.style.opacity = 1);
    });
    document.querySelectorAll('.cards').forEach(drop => {
      drop.addEventListener('dragover', e => e.preventDefault());
      drop.addEventListener('drop', e => {
        e.preventDefault();
        const id = e.dataTransfer.getData('text/plain');
        const targetCol = drop.getAttribute('data-drop');
        moveCard(id, targetCol);
      });
    });
  }

  function handleStageChange(card, from, dest) {
    if (dest === 'research' && !card.savedAt) {
      card.savedAt = Date.now();
    }
    if (dest === 'applied' && from !== 'applied') {
      if (!card.appliedInfo) card.appliedInfo = { date: '', source: '' };
      if (!card.appliedInfo.date) card.appliedInfo.date = todayKeyDate();
      if (!card.appliedInfo.source) card.appliedInfo.source = 'Manual';
      bumpToday();
    }
    if (dest === 'screening') {
      if (!card.screeningInfo) card.screeningInfo = { replied: false, assessmentDue: '', infoShared: '' };
      card.screeningInfo.replied = true;
      if (!card.screeningInfo.infoShared) card.screeningInfo.infoShared = 'Pending';
    }
    if (dest === 'rejected' && !card.rejectedInfo?.date) {
      if (!card.rejectedInfo) card.rejectedInfo = { reason: '', date: '' };
      card.rejectedInfo.date = todayKeyDate();
    }
  }

  function moveCard(id, dest) {
    if (!COLUMNS.includes(dest)) return;
    let card = null;
    let fromCol = null;
    let index = -1;
    for (const col of COLUMNS) {
      index = board[col].findIndex(x => x.id === id);
      if (index > -1) {
        card = board[col][index];
        fromCol = col;
        board[col].splice(index, 1);
        break;
      }
    }
    if (!card) return;
    card = upgradeCard(card);
    handleStageChange(card, fromCol, dest);
    board[dest].unshift(card);
    saveBoard();
    renderBoard();
  }

  function locateCard(id) {
    for (const col of COLUMNS) {
      const idx = board[col].findIndex(x => x.id === id);
      if (idx > -1) {
        return { col, idx, card: board[col][idx] };
      }
    }
    return null;
  }

  function todayKeyDate() {
    return new Date().toISOString().slice(0, 10);
  }

  function getWeekNum(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  function loadToday() {
    const raw = JSON.parse(localStorage.getItem(KEY_TODAY) || 'null') || { date: todayKeyDate(), count: 0, week: {} };
    if (raw.date !== todayKeyDate()) {
      raw.date = todayKeyDate();
      raw.count = 0;
    }
    return raw;
  }

  function saveToday(t) {
    localStorage.setItem(KEY_TODAY, JSON.stringify(t));
  }

  function bumpToday() {
    const t = loadToday();
    t.count += 1;
    const d = new Date();
    const wk = d.getFullYear() + '-W' + getWeekNum(d);
    t.week[wk] = (t.week[wk] || 0) + 1;
    saveToday(t);
    reflectToday();
  }

  function reflectToday() {
    const t = loadToday();
    todayCountEl.textContent = t.count;
    const d = new Date();
    const wk = d.getFullYear() + '-W' + getWeekNum(d);
    weekCountEl.textContent = t.week[wk] || 0;
  }

  const modalBG = document.getElementById('modalBG');
  const modalTitle = document.getElementById('modalTitle');
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  const saveBtn = document.getElementById('saveBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const markAppliedBtn = document.getElementById('markAppliedBtn');
  const companyInput = document.getElementById('m_company');
  const roleInput = document.getElementById('m_role');
  const linkInput = document.getElementById('m_link');
  const deadlineInput = document.getElementById('m_deadline');
  const notesInput = document.getElementById('m_notes');
  const jobDescEl = document.getElementById('m_jobdesc');
  const fitResultsEl = document.getElementById('fitResults');
  const analyzeFitBtn = document.getElementById('analyzeFitBtn');
  const questionInput = document.getElementById('questionInput');
  const questionsListEl = document.getElementById('questionsList');
  const addQuestionBtn = document.getElementById('addQuestionBtn');
  const openChatBtn = document.getElementById('openChatBtn');
  const stageDetailsContent = document.getElementById('stageDetailsContent');
  const chatDrawer = document.getElementById('chatDrawer');
  const chatBody = document.getElementById('chatBody');
  const chatInput = document.getElementById('chatInput');
  const chatSendBtn = document.getElementById('chatSendBtn');
  const closeChatBtn = document.getElementById('closeChatBtn');
  const menu = document.getElementById('menu');

  let editingCardId = null;
  let workingCol = 'research';
  let workingIndex = -1;
  let modalStage = 'research';
  let workingCard = null;
  let questionExpansion = {};
  let chatHistory = [];

  function setModalVisibility(show) {
    modalBG.style.display = show ? 'flex' : 'none';
    modalBG.setAttribute('aria-hidden', show ? 'false' : 'true');
  }

  function attachCardActions() {
    document.querySelectorAll('.card').forEach(el => {
      el.addEventListener('click', evt => {
        if (evt.target.closest('a')) return;
        const id = el.getAttribute('data-id');
        openModalForEdit(id);
      });
    });
  }

  function populateModal() {
    if (!workingCard) return;
    companyInput.value = workingCard.company || '';
    roleInput.value = workingCard.role || '';
    linkInput.value = workingCard.link || '';
    deadlineInput.value = workingCard.deadline || '';
    notesInput.value = workingCard.notes || '';
    jobDescEl.value = workingCard.jobDescription || '';
    renderFitResults();
    renderQuestionsList();
    renderStageDetails();
    markAppliedBtn.style.display = editingCardId && modalStage === 'research' ? 'inline-flex' : 'none';
  }

  function openModalForNew() {
    editingCardId = null;
    workingCard = { ...createBlankCard(), id: generateId('c') };
    workingCol = 'research';
    workingIndex = -1;
    modalStage = 'research';
    questionExpansion = {};
    chatHistory = [];
    modalTitle.textContent = 'New Application';
    saveBtn.textContent = 'Add';
    deleteBtn.style.display = 'none';
    markAppliedBtn.style.display = 'none';
    populateModal();
    setModalVisibility(true);
    companyInput.focus();
  }

  function openModalForEdit(id) {
    const located = locateCard(id);
    if (!located) return;
    editingCardId = id;
    workingCol = located.col;
    workingIndex = located.idx;
    modalStage = located.col;
    workingCard = upgradeCard(JSON.parse(JSON.stringify(located.card)));
    workingCard.id = id;
    questionExpansion = {};
    workingCard.questions.forEach(q => { questionExpansion[q.id] = true; });
    chatHistory = [];
    modalTitle.textContent = 'Edit Application';
    saveBtn.textContent = 'Save changes';
    deleteBtn.style.display = 'inline-flex';
    populateModal();
    setModalVisibility(true);
    companyInput.focus();
  }

  function closeModal() {
    setModalVisibility(false);
    editingCardId = null;
    workingCard = null;
    chatHistory = [];
    questionExpansion = {};
    closeChat();
  }

  function renderFitResults() {
    if (!workingCard) return;
    const fit = workingCard.fit || { score: null, matches: [], missing: [] };
    if (fit.score == null) {
      fitResultsEl.style.display = 'none';
      fitResultsEl.innerHTML = '';
      return;
    }
    fitResultsEl.style.display = 'block';
    const band = fit.band || getFitBand(fit.score);
    const matchesList = (fit.matches || []).length
      ? `<ul class="fit-list">${fit.matches.map(m => `<li>${escapeHtml(m)}</li>`).join('')}</ul>`
      : '<div class="stage-note">No matches yet ‚Äî add strengths to your profile.</div>';
    const missingList = (fit.missing || []).length
      ? `<ul class="fit-list">${fit.missing.map(m => `<li>${escapeHtml(m)}</li>`).join('')}</ul>`
      : '<div class="stage-note">Looks great ‚Äî no major gaps identified.</div>';
    fitResultsEl.innerHTML = `
      <div><strong>Fit Score:</strong> ${fit.score}% <span class="fit-band">${band}</span></div>
      <div style="margin-top:8px;font-weight:600">Matches</div>
      ${matchesList}
      <div style="margin-top:8px;font-weight:600">Missing skills</div>
      ${missingList}
    `;
  }

  function extractKeywords(text, limit = 15) {
    const counts = {};
    (text || '').toLowerCase().match(/\b[a-z]{3,}\b/g)?.forEach(word => {
      if (STOP_WORDS.has(word)) return;
      counts[word] = (counts[word] || 0) + 1;
    });
    return Object.entries(counts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, limit)
      .map(([word]) => word);
  }

  function toTitle(word) {
    return word ? word.charAt(0).toUpperCase() + word.slice(1) : '';
  }

  function analyzeFit() {
    if (!workingCard) return;
    const jd = jobDescEl.value.trim();
    if (!jd) {
      notify('Paste the job description first.', { variant: 'danger' });
      return;
    }
    const keywords = extractKeywords(jd, 20);
    const profileText = [
      profile?.career_story?.strengths,
      profile?.career_story?.journey,
      profile?.career_story?.flow_state_work,
      profile?.career_story?.current_vs_next,
      profile?.career_story?.ideal_environment,
      profile?.career_story?.long_term_vision,
      profile?.career_story?.beyond_resume,
      profile?.role,
      notesInput.value
    ].filter(Boolean).join(' ').toLowerCase();
    const userTokens = new Set((profileText.match(/\b[a-z]{3,}\b/g) || []).filter(word => !STOP_WORDS.has(word)));
    const matches = [];
    const missing = [];
    keywords.forEach(word => {
      if (userTokens.has(word)) matches.push(toTitle(word));
      else missing.push(toTitle(word));
    });
    const total = keywords.length || 1;
    let score = Math.round((matches.length / total) * 100);
    if (!Number.isFinite(score)) score = 0;
    score = Math.max(0, Math.min(100, score));
    workingCard.fit = {
      score,
      band: getFitBand(score),
      matches,
      missing
    };
    renderFitResults();
  }

  function generateAnswer(prompt) {
    const jd = jobDescEl.value.trim();
    const matches = (workingCard?.fit?.matches || []).slice(0, 3);
    const focus = matches.length ? matches.join(', ') : 'my relevant experience and quick learning';
    const headline = extractKeywords(jd, 1)[0];
    const intro = headline ? `The role emphasizes ${headline}, which aligns with` : 'The role aligns with';
    return `For ‚Äú${prompt}‚Äù, I would highlight how ${intro} ${focus}. I can share a recent example that shows measurable impact and outline the next steps I‚Äôm taking for this opportunity.`;
  }

  function renderQuestionsList() {
    questionsListEl.innerHTML = '';
    if (!workingCard || !workingCard.questions.length) {
      const note = document.createElement('div');
      note.className = 'stage-note';
      note.textContent = 'Add prompts to draft answers before forms or screenings.';
      questionsListEl.appendChild(note);
      return;
    }
    workingCard.questions.forEach(q => {
      if (!(q.id in questionExpansion)) questionExpansion[q.id] = false;
      const item = document.createElement('div');
      item.className = 'question-item';
      item.dataset.id = q.id;
      const head = document.createElement('div');
      head.className = 'question-head';
      const qInputEl = document.createElement('input');
      qInputEl.type = 'text';
      qInputEl.value = q.prompt;
      qInputEl.placeholder = 'Question';
      qInputEl.addEventListener('input', e => { q.prompt = e.target.value; });
      const toggleBtn = document.createElement('button');
      toggleBtn.type = 'button';
      toggleBtn.textContent = questionExpansion[q.id] ? '‚ñ¥' : '‚ñæ';
      toggleBtn.addEventListener('click', () => {
        questionExpansion[q.id] = !questionExpansion[q.id];
        renderQuestionsList();
      });
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.textContent = '‚úï';
      removeBtn.style.color = '#275291';
      removeBtn.addEventListener('click', () => {
        workingCard.questions = workingCard.questions.filter(itemQ => itemQ.id !== q.id);
        delete questionExpansion[q.id];
        renderQuestionsList();
      });
      head.append(qInputEl, toggleBtn, removeBtn);
      const body = document.createElement('div');
      body.className = 'question-body';
      body.style.display = questionExpansion[q.id] ? 'flex' : 'none';
      const answerArea = document.createElement('textarea');
      answerArea.value = q.answer || '';
      answerArea.addEventListener('input', e => { q.answer = e.target.value; });
      const regenBtn = document.createElement('button');
      regenBtn.type = 'button';
      regenBtn.className = 'btn ghost';
      regenBtn.textContent = 'Regenerate suggestion';
      regenBtn.addEventListener('click', () => {
        q.answer = generateAnswer(q.prompt || 'this question');
        renderQuestionsList();
      });
      body.append(answerArea, regenBtn);
      item.append(head, body);
      questionsListEl.appendChild(item);
    });
  }

  function addQuestionFromInput() {
    if (!workingCard) return;
    const text = questionInput.value.trim();
    if (!text) return;
    const question = { id: generateId('q'), prompt: text, answer: generateAnswer(text) };
    workingCard.questions.push(question);
    questionExpansion[question.id] = true;
    questionInput.value = '';
    renderQuestionsList();
  }

  function renderStageDetails() {
    stageDetailsContent.innerHTML = '';
    if (!workingCard) return;
    const note = document.createElement('div');
    note.className = 'stage-meta-note';
    note.textContent = `Details shown on cards in the ‚Äú${LANE_TITLES[modalStage]}‚Äù lane.`;
    stageDetailsContent.appendChild(note);
    const builder = {
      research: buildResearchDetails,
      applied: buildAppliedDetails,
      screening: buildScreeningDetails,
      interviewing: buildInterviewingDetails,
      offer: buildOfferDetails,
      rejected: buildRejectedDetails
    }[modalStage];
    if (!builder) return;
    const content = builder();
    if (content) stageDetailsContent.appendChild(content);
    else {
      const empty = document.createElement('div');
      empty.className = 'stage-meta-empty';
      empty.textContent = 'No extra details for this stage yet.';
      stageDetailsContent.appendChild(empty);
    }
  }

  function createStageGrid() {
    const grid = document.createElement('div');
    grid.className = 'stage-meta-grid';
    return grid;
  }

  function createStageStack() {
    const stack = document.createElement('div');
    stack.className = 'stage-meta-stack';
    return stack;
  }

  function createStageItem(label, value, options = {}) {
    const item = document.createElement('div');
    item.className = 'stage-meta-item';
    if (options.full) item.classList.add('full');
    if (options.muted) item.classList.add('muted');
    const labelEl = document.createElement('span');
    labelEl.className = 'stage-meta-label';
    labelEl.textContent = label;
    const valueEl = document.createElement('span');
    valueEl.className = 'stage-meta-value';
    valueEl.textContent = value || '‚Äî';
    item.append(labelEl, valueEl);
    return item;
  }

  function formatDateDisplay(value) {
    if (!value) return '‚Äî';
    const date = typeof value === 'number' ? new Date(value) : new Date(value);
    if (Number.isNaN(date.getTime())) return '‚Äî';
    return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
  }

  function formatDateTimeDisplay(value) {
    if (!value) return '‚Äî';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return '‚Äî';
    return date.toLocaleString(undefined, {
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit'
    });
  }

  function buildResearchDetails() {
    const grid = createStageGrid();
    grid.append(
      createStageItem('Resume version', workingCard.resumeVersion || 'Resume v1'),
      createStageItem('Saved on', formatDateDisplay(workingCard.savedAt))
    );
    return grid;
  }

  function buildAppliedDetails() {
    const applied = workingCard.appliedInfo || {};
    const grid = createStageGrid();
    grid.append(
      createStageItem('Applied on', formatDateDisplay(applied.date)),
      createStageItem('Source', applied.source || '‚Äî')
    );
    return grid;
  }

  function buildScreeningDetails() {
    const info = workingCard.screeningInfo || {};
    const grid = createStageGrid();
    grid.append(
      createStageItem('Status', info.replied ? 'Replied' : 'Awaiting reply'),
      createStageItem('Assessment due', formatDateDisplay(info.assessmentDue))
    );
    const details = info.infoShared?.trim();
    grid.append(createStageItem('Info shared', details || 'Nothing noted yet.', { full: true, muted: !details }));
    return grid;
  }

  function buildInterviewingDetails() {
    const rounds = workingCard.interviewingRounds || [];
    if (!rounds.length) {
      return createStageItem('Interview rounds', 'No interview rounds added yet.', { full: true, muted: true });
    }
    const stack = createStageStack();
    rounds.forEach((round, idx) => {
      const name = round?.name?.trim();
      const when = formatDateTimeDisplay(round?.datetime);
      const item = createStageItem(`Round ${idx + 1}`, [name || 'Interview', when !== '‚Äî' ? when : 'Timing TBD'].join('\n'), { full: true });
      stack.appendChild(item);
    });
    return stack;
  }

  function buildOfferDetails() {
    const offer = workingCard.offerInfo || {};
    const grid = createStageGrid();
    grid.append(
      createStageItem('CTC', offer.ctc || '‚Äî'),
      createStageItem('Joining date', formatDateDisplay(offer.joiningDate)),
      createStageItem('Status', offer.status || '‚Äî', { full: true })
    );
    return grid;
  }

  function buildRejectedDetails() {
    const reject = workingCard.rejectedInfo || {};
    const grid = createStageGrid();
    grid.append(
      createStageItem('Reason', reject.reason || 'No reason added yet.', { full: true, muted: !reject.reason }),
      createStageItem('Date', formatDateDisplay(reject.date))
    );
    return grid;
  }

  function readStageDetailsIntoState() {
    if (!workingCard) return;
    if (modalStage === 'research') {
      const resumeInput = document.getElementById('stage_resume');
      const savedInput = document.getElementById('stage_saved');
      if (resumeInput) workingCard.resumeVersion = resumeInput.value || 'Resume v1';
      if (savedInput && savedInput.value) {
        const d = new Date(savedInput.value);
        if (!Number.isNaN(d.getTime())) workingCard.savedAt = d.getTime();
      }
    } else if (modalStage === 'applied') {
      const dateInput = document.getElementById('stage_applied_date');
      const sourceInput = document.getElementById('stage_applied_source');
      if (dateInput) workingCard.appliedInfo.date = dateInput.value;
      if (sourceInput) workingCard.appliedInfo.source = sourceInput.value;
    } else if (modalStage === 'screening') {
      const repliedInput = document.getElementById('stage_screening_replied');
      const dueInput = document.getElementById('stage_assessment_due');
      const infoInput = document.getElementById('stage_info_shared');
      if (repliedInput) workingCard.screeningInfo.replied = repliedInput.checked;
      if (dueInput) workingCard.screeningInfo.assessmentDue = dueInput.value;
      if (infoInput) workingCard.screeningInfo.infoShared = infoInput.value;
    } else if (modalStage === 'interviewing') {
      const rounds = [];
      document.querySelectorAll('.stage-round').forEach(block => {
        const id = block.dataset.round || generateId('r');
        const [nameInput, dateInput] = block.querySelectorAll('input');
        const name = nameInput?.value.trim() || '';
        const datetime = dateInput?.value || '';
        if (name || datetime) rounds.push({ id, name, datetime });
      });
      workingCard.interviewingRounds = rounds;
    } else if (modalStage === 'offer') {
      const ctcInput = document.getElementById('stage_offer_ctc');
      const joinInput = document.getElementById('stage_offer_joining');
      const statusSelect = document.getElementById('stage_offer_status');
      if (ctcInput) workingCard.offerInfo.ctc = ctcInput.value;
      if (joinInput) workingCard.offerInfo.joiningDate = joinInput.value;
      if (statusSelect) workingCard.offerInfo.status = statusSelect.value;
    } else if (modalStage === 'rejected') {
      const reasonArea = document.getElementById('stage_reject_reason');
      const dateInput = document.getElementById('stage_reject_date');
      if (reasonArea) workingCard.rejectedInfo.reason = reasonArea.value;
      if (dateInput) workingCard.rejectedInfo.date = dateInput.value;
    }
  }

  function syncModalToState() {
    if (!workingCard) return null;
    workingCard.company = companyInput.value.trim();
    workingCard.role = roleInput.value.trim();
    workingCard.link = linkInput.value.trim();
    workingCard.deadline = deadlineInput.value;
    workingCard.notes = notesInput.value.trim();
    workingCard.jobDescription = jobDescEl.value.trim();
    readStageDetailsIntoState();
    return workingCard;
  }

  function sanitizeCard(raw, existing = {}) {
    const base = upgradeCard({ ...existing, ...raw });
    base.id = raw.id || existing.id || generateId('c');
    base.created_at = existing.created_at || raw.created_at || Date.now();
    base.questions = (raw.questions || []).map(q => ({ id: q.id || generateId('q'), prompt: q.prompt || '', answer: q.answer || '' }));
    return base;
  }

  function upsertCard() {
    const updated = syncModalToState();
    if (!updated) return;
    if (!updated.company || !updated.role) {
      notify('Please enter Company and Role', { variant: 'danger' });
      return;
    }
    if (editingCardId) {
      const located = locateCard(editingCardId);
      if (!located) {
        closeModal();
        return;
      }
      const merged = sanitizeCard({ ...updated, id: editingCardId }, located.card);
      board[located.col][located.idx] = merged;
    } else {
      const newCard = sanitizeCard({ ...updated, id: workingCard.id || generateId('c'), savedAt: updated.savedAt || Date.now() }, {});
      newCard.created_at = Date.now();
      board.research.unshift(newCard);
    }
    saveBoard();
    renderBoard();
    closeModal();
  }

  function markAsApplied() {
    if (!editingCardId) return;
    const located = locateCard(editingCardId);
    if (!located) return;
    syncModalToState();
    const merged = sanitizeCard({ ...workingCard, id: editingCardId }, located.card);
    board[located.col][located.idx] = merged;
    moveCard(editingCardId, 'applied');
    closeModal();
    notify('Application marked as Applied.', { variant: 'success' });
  }

  function deleteCard() {
    if (!editingCardId) {
      closeModal();
      return;
    }
    const located = locateCard(editingCardId);
    if (!located) {
      closeModal();
      return;
    }
    if (!confirm('Delete this application?')) return;
    board[located.col].splice(located.idx, 1);
    saveBoard();
    renderBoard();
    closeModal();
    notify('Application deleted.', { variant: 'success' });
  }

  function openChat() {
    chatDrawer.style.display = 'flex';
    chatDrawer.setAttribute('aria-hidden', 'false');
    renderChatHistory();
    setTimeout(() => chatInput.focus(), 100);
  }

  function closeChat() {
    chatDrawer.style.display = 'none';
    chatDrawer.setAttribute('aria-hidden', 'true');
  }

  function renderChatHistory() {
    chatBody.innerHTML = '';
    if (!chatHistory.length) {
      const note = document.createElement('div');
      note.className = 'stage-note';
      note.textContent = 'Ask the assistant to refine answers or prep for interviews.';
      chatBody.appendChild(note);
      return;
    }
    chatHistory.forEach(msg => {
      const bubble = document.createElement('div');
      bubble.className = `msg ${msg.role}`;
      bubble.textContent = msg.text;
      chatBody.appendChild(bubble);
    });
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function generateChatResponse(message) {
    const band = workingCard?.fit?.band;
    const score = workingCard?.fit?.score;
    const missing = workingCard?.fit?.missing || [];
    const focus = missing.length ? `Focus on strengthening ${missing.slice(0, 3).join(', ')}.` : 'Your fit looks solid ‚Äî emphasize your top achievements.';
    const keywords = extractKeywords(jobDescEl.value, 3).map(toTitle).join(', ');
    const jdTip = keywords ? `Highlight ${keywords} from the JD.` : '';
    return `Thanks for sharing! ${band ? `Current fit: ${band}${score != null ? ` (${score}%)` : ''}. ` : ''}${focus} ${jdTip}`.trim();
  }

  function sendChat() {
    const text = chatInput.value.trim();
    if (!text) return;
    chatHistory.push({ role: 'user', text });
    const reply = generateChatResponse(text);
    chatHistory.push({ role: 'ai', text: reply });
    chatInput.value = '';
    renderChatHistory();
  }

  async function deleteAccount() {
    menu.style.display = 'none';
    if (!confirm('This will permanently delete your JobSprint account and all saved data. Continue?')) {
      return;
    }
    if (!confirm('Are you absolutely sure? This action cannot be undone.')) {
      return;
    }

    let response;
    const deletingToast = notifyLoading('Deleting your account‚Ä¶');
    try {
      response = await fetch('/api/delete-user', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ token })
      });
    } catch (err) {
      console.error('delete account request failed', err);
      deletingToast?.dismiss?.();
      notify('Could not delete account. Please check your connection and try again.', { variant: 'danger' });
      return;
    }

    let payload = {};
    try {
      payload = await response.json();
    } catch (_) {
      payload = {};
    }

    if (!response.ok || !payload?.success) {
      const message = payload?.error
        ? `Could not delete account (${payload.error}).`
        : 'Could not delete account. Please try again.';
      deletingToast?.dismiss?.();
      notify(message, { variant: 'danger' });
      return;
    }

    deletingToast?.dismiss?.();
    clearLocalUserData();
    board = emptyBoard();
    renderBoard();
    reflectToday();
    notify('Your JobSprint account has been deleted. You can sign up again anytime to start fresh.', { variant: 'success' });
    redirectWithToast('/signup.html?mode=signup', 'Taking you to sign-up‚Ä¶');
  }

  document.getElementById('hamBtn').onclick = () => menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
  document.getElementById('deleteAccountBtn').onclick = e => {
    e.preventDefault();
    deleteAccount();
  };
  document.getElementById('signoutBtn').onclick = e => {
    e.preventDefault();
    localStorage.removeItem('jobsprint_profile');
    notify('Signed out ‚Äî see you soon!', { variant: 'info', duration: 5200 });
    redirectWithToast('/signup.html?mode=login', 'Taking you to sign-in‚Ä¶');
  };

  document.getElementById('addBtn').onclick = openModalForNew;
  modalCloseBtn.onclick = closeModal;
  saveBtn.onclick = upsertCard;
  deleteBtn.onclick = deleteCard;
  markAppliedBtn.onclick = markAsApplied;
  analyzeFitBtn.onclick = analyzeFit;
  addQuestionBtn.onclick = addQuestionFromInput;
  questionInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addQuestionFromInput();
    }
  });
  openChatBtn.onclick = openChat;
  closeChatBtn.onclick = closeChat;
  chatSendBtn.onclick = sendChat;
  chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendChat();
    }
  });
  chatDrawer.addEventListener('click', e => {
    if (e.target === chatDrawer) closeChat();
  });

  document.getElementById('resetBtn').onclick = () => {
    if (!confirm('Reset board for this user?')) return;
    board = emptyBoard();
    saveBoard();
    renderBoard();
  };

  renderBoard();
  reflectToday();
</script>
</body>
</html>
