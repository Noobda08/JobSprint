<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>JobSprint ‚Ä¢ Workspace</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="styles/theme.css"/>
<style>
  :root{
    --bg1:#f0f6ff; --bg2:#e1edff; --ink:#0b1a33; --muted:#4b6078;
    --card:#fff; --line:#d5e3f7; --brand:#0a66c2; --brand-d:#084a91;
    --lane:#eef5ff; --shadow:0 12px 34px rgba(10,102,194,.12);
    --coach-summary-width:260px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(120deg,var(--bg1),var(--bg2));color:var(--ink)}
  .app{min-height:100vh;display:flex;flex-direction:column;padding-left:var(--coach-summary-width);transition:margin-left .32s ease,padding-left .32s ease}

  /* Topbar */
  .top{
    position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(6px);
    background:rgba(255,255,255,.72);border-bottom:1px solid #d2e4ff;
  }
  .topin{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:12px 16px}
  .brand{display:flex;align-items:center;gap:10px}
  .badge{width:36px;height:36px;border-radius:12px;overflow:hidden;display:grid;place-items:center;background:#fff;padding:4px}
  .badge img{width:100%;height:100%;object-fit:contain;display:block}
  .navspacer{flex:1}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid #c8d9f4;border-radius:999px;padding:6px 10px;color:#0f3e7c}
  .ham{width:36px;height:36px;border-radius:10px;border:1px solid #c8d9f4;background:#fff;cursor:pointer}

  .coach-nav-btn{background:#fff;border:1px solid #c8d9f4;border-radius:999px;padding:8px 14px;font-weight:600;color:#0f3e7c;cursor:pointer;transition:background .2s ease,box-shadow .2s ease}
  .coach-nav-btn:hover{background:#edf4ff;box-shadow:0 4px 12px rgba(10,102,194,.18)}

  .dropdown{position:absolute;right:16px;top:60px;background:#fff;border:1px solid #c8d9f4;border-radius:14px;box-shadow:var(--shadow);padding:8px;display:none;min-width:230px}
  .dropdown a{display:block;padding:10px 12px;border-radius:10px;color:#1e3f73;text-decoration:none}
  .dropdown a:hover{background:#edf4ff}

  /* Header stats */
  .head{max-width:1200px;margin:18px auto 0;padding:0 16px 14px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .stat{background:rgba(255,255,255,.85);border:1px solid #c8d9f4;border-radius:12px;padding:10px 14px;display:flex;gap:10px;align-items:center}
  .stat strong{font-weight:600}
  .btn{background:var(--brand);border:0;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn:hover{background:var(--brand-d)}
  .btn.ghost{background:#fff;border:1px solid #c8d9f4;color:#0f3e7c}

  /* Board */
  .board{max-width:1200px;margin:14px auto;padding:0 16px 40px;display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:14px}
  .lane{background:rgba(255,255,255,.88);border:1px solid #c8d9f4;border-radius:16px;min-height:320px;display:flex;flex-direction:column}
  .lanehead{padding:12px 12px 10px;border-bottom:1px solid #d7e6ff;display:flex;flex-direction:column;gap:6px;min-height:148px}
  .lanehead-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .lanehead h3{margin:0;font-size:16px}
  .lane-desc{margin:6px 0 0;font-size:12px;color:#9f9f9f;line-height:1.4}
  .count{font-size:12px;color:#2f4f86;background:#edf4ff;border:1px solid #c8d9f4;border-radius:999px;padding:2px 8px}
  .cards{flex:1;padding:10px;display:grid;gap:10px}
  .card{
    position:relative;background:#fff7c2;border:1px solid rgba(225,190,0,.4);border-radius:8px;padding:14px;
    box-shadow:0 18px 22px -18px rgba(137,111,0,.8),0 10px 20px rgba(247,223,124,.45);
    cursor:grab;display:flex;flex-direction:column;gap:8px;
    transform:rotate(-0.8deg) skew(-0.4deg);transition:transform .2s ease;
  }
  .card:nth-child(2n){transform:rotate(.9deg) skew(.3deg)}
  .card:nth-child(3n){transform:rotate(-1.2deg) skew(.2deg)}
  .card:hover{transform:rotate(0deg) skew(0deg) translateY(-2px)}
  .card::before{
    content:"";position:absolute;top:-10px;left:12px;width:48px;height:22px;background:linear-gradient(135deg,#f3e289,#fdf5c4);
    box-shadow:0 4px 6px rgba(0,0,0,.1);border-radius:4px 4px 2px 2px;
    transform:rotate(-2deg);opacity:.8;pointer-events:none;
  }
  .card strong{font-weight:600;color:#3a2d00}
  .card small{color:#6a5a1f}
  .card-header{font-size:14px;line-height:1.4;color:#2d2100}
  .card-role{color:#4a3600;font-size:13px;font-weight:600}
  .card-badges{display:flex;flex-wrap:wrap;gap:6px}
  .card-badge{background:#ffeaa0;border:1px solid rgba(180,145,0,.3);border-radius:999px;padding:2px 8px;font-size:11px;color:#2c1f00;white-space:nowrap}
  .card-badge.more{background:#ffd866;color:#2d2100;font-weight:700}
  .empty{flex:1;display:grid;place-items:center;color:#385b8a;font-size:13px;padding:18px}

  /* Modal */
  .modalBG{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:30;padding:20px;overflow:auto}
  .modal{background:#fff;border:1px solid #c8d9f4;border-radius:14px;box-shadow:var(--shadow);width:min(560px,92%);max-height:calc(100vh - 40px);padding:16px;overflow:auto}
  .modal-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:12px}
  .modal-title-block{display:flex;flex-direction:column;gap:6px;flex:1}
  .modal-title-block h3{margin:4px 0 0}
  .modal-close{background:transparent;border:0;color:#275291;font-size:20px;line-height:1;font-weight:600;border-radius:8px;padding:6px 8px;cursor:pointer}
  .modal-close:hover{background:#edf4ff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:13px;font-weight:600}
  input,textarea{width:100%;padding:10px;border:1px solid #c9dfff;border-radius:10px;font-family:inherit}
  textarea{min-height:80px;resize:vertical}

  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .section{margin-top:16px;padding:14px;border:1px solid #d7e6ff;border-radius:12px;background:#eef5ff}
  .section h4{margin:0 0 8px;font-size:15px}
  .job-fit{display:flex;flex-direction:column;gap:10px}
  .job-fit-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .job-fit-copy{margin:4px 0 0;font-size:12px;color:#2c4f80}
  .fit-results{margin-top:10px;border-top:1px solid #d6e5ff;padding-top:10px;font-size:13px;color:#2c4f80}
  .fit-band{display:inline-flex;align-items:center;gap:6px;margin-left:6px;font-size:12px;padding:2px 8px;border-radius:999px;background:#dceaff;color:#0f3e7c}
  .fit-list{margin:6px 0 0;padding-left:18px}
  .badge-pill{display:inline-flex;align-items:center;gap:6px;background:#fff;border:1px solid #c8d9f4;border-radius:999px;padding:4px 10px;font-size:12px;color:#0f3e7c}
  .questions-add{display:flex;gap:8px;margin-bottom:10px}
  .questions-add input{flex:1}
  .question-item{border:1px solid #cddffa;border-radius:12px;margin-bottom:10px;background:#fff}
  .question-head{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid #dbe7ff}
  .question-head input{flex:1;border:none;padding:0;font-weight:600;color:#2c4f80}
  .question-head button{background:none;border:0;font-size:16px;cursor:pointer;color:#275291}
  .question-body{padding:12px;display:none;flex-direction:column;gap:10px}
  .question-body textarea{min-height:90px}
  .stage-meta{display:flex;flex-direction:column;gap:8px}
  .stage-meta-note{font-size:12px;color:#4b6b94}
  .stage-meta-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
  .stage-meta-item{background:#f4f7ff;border:1px solid #dbe7ff;border-radius:10px;padding:8px 10px;display:flex;flex-direction:column;gap:4px;font-size:12px;color:#2c4f80}
  .stage-meta-item.full{grid-column:1 / -1}
  .stage-meta-item.muted .stage-meta-value{color:#4b6b94;font-weight:500}
  .stage-meta-label{text-transform:uppercase;letter-spacing:.4px;font-weight:600;font-size:11px;color:#5271a6}
  .stage-meta-value{font-weight:600;font-size:13px;color:#153971;white-space:pre-line;word-break:break-word}
  .stage-meta-empty{font-size:12px;color:#4b6b94}
  .stage-meta-stack{display:flex;flex-direction:column;gap:8px}
  .stage-note{font-size:12px;color:#4b6b94;margin-top:4px}
  .drawerBG{position:fixed;inset:0;display:none;align-items:stretch;justify-content:flex-end;background:rgba(0,0,0,.25);z-index:40}
  .drawer{width:min(360px,90vw);background:#fff;height:100%;border-left:1px solid #c9dfff;box-shadow:var(--shadow);display:flex;flex-direction:column}
  .drawer-head{padding:14px 16px;border-bottom:1px solid #dbe7ff;display:flex;align-items:center;justify-content:space-between}
  .drawer-head h4{margin:0;font-size:16px}
  .drawer-body{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
  .drawer-body .msg{padding:10px 12px;border-radius:10px;max-width:90%;font-size:13px;line-height:1.4}
  .drawer-body .msg.user{background:#dceaff;align-self:flex-end}
  .drawer-body .msg.ai{background:#f6f6f6;border:1px solid #ececec;align-self:flex-start}
  .drawer-input{padding:12px 16px;border-top:1px solid #dbe7ff;display:flex;flex-direction:column;gap:8px}
  .drawer-input textarea{min-height:70px}
  .toggle-switch{display:flex;align-items:center;gap:8px;font-size:13px;color:#2c4f80}
  .sprint-coach{position:fixed;left:0;top:0;bottom:0;width:300px;background:rgba(255,255,255,.95);border-right:1px solid #c8d9f4;box-shadow:var(--shadow);transform:translateX(-110%);transition:transform .32s ease;z-index:35;display:flex;flex-direction:column}
  .sprint-coach.open{transform:translateX(0)}
  .coach-inner{flex:1;display:flex;flex-direction:column;gap:18px;padding:24px 20px;overflow-y:auto;background:linear-gradient(160deg,#eef5ff,#e4f0ff)}
  .coach-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .coach-header h2{margin:0;font-size:22px}
  .coach-subtitle{margin:4px 0 0;font-size:12px;color:#2f568f}
  .coach-profile{margin:8px 0 0;font-size:12px;color:#0f3e7c;font-weight:600}
  .coach-close{background:#fff;border:1px solid #c8d9f4;border-radius:10px;width:32px;height:32px;cursor:pointer;color:#0f3e7c}
  .coach-close:hover{background:#edf4ff}
  .coach-section{background:rgba(255,255,255,.86);border:1px solid #cfe0fb;border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:10px;box-shadow:0 10px 20px rgba(10,102,194,.1)}
  .coach-section-title{font-weight:600;text-transform:uppercase;font-size:12px;letter-spacing:.6px;color:#1f4f94}
  .coach-quote{font-size:14px;color:#2c4f80;line-height:1.5}
  .coach-mini-btn{align-self:flex-start;background:var(--brand);color:#fff;border:0;border-radius:999px;padding:8px 14px;font-weight:600;cursor:pointer;font-size:12px}
  .coach-mini-btn:hover{background:var(--brand-d)}
  .coach-mini-btn.outline{background:#fff;color:#0f3e7c;border:1px solid #c8d9f4}
  .coach-mini-btn.outline:hover{background:#edf4ff}
  .coach-progress{display:flex;flex-direction:column;gap:8px}
  .coach-progress-bar{background:#e6f0ff;border-radius:999px;overflow:hidden;height:10px}
  .coach-progress-fill{height:100%;background:linear-gradient(90deg,#4ba0ff,#1da1f2);width:0;transition:width .4s ease;border-radius:999px}
  .coach-progress-text{font-size:13px;font-weight:600;color:#2c4f80}
  .coach-note{font-size:12px;color:#3260a3}
  .coach-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .coach-stat{background:#eef5ff;border:1px solid #cfe0fb;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:4px;font-size:12px;color:#2c4f80}
  .coach-stat strong{font-size:16px;color:#0f3e7c}
  .coach-metric{display:flex;justify-content:space-between;font-size:13px;color:#2c4f80}
  .coach-metric strong{color:#0f3e7c}
  .coach-suggestion{font-size:12px;color:#3260a3;line-height:1.4}
  .coach-section-headline{display:flex;align-items:center;justify-content:space-between;font-size:13px;color:#1f4f94;font-weight:600;gap:8px}
  .coach-icon-btn{background:#fff;border:1px solid #c8d9f4;border-radius:50%;width:32px;height:32px;display:grid;place-items:center;cursor:pointer;color:#1f4f94}
  .coach-icon-btn:hover{background:#edf4ff}
  .coach-tips{margin:0;padding-left:18px;display:flex;flex-direction:column;gap:6px;color:#2c4f80;font-size:13px}
  .coach-footer{text-align:center;font-size:11px;color:#4a6ba3;padding-bottom:10px;display:flex;flex-direction:column;gap:4px}
  .coach-summary{position:fixed;left:0;top:0;bottom:0;width:var(--coach-summary-width);height:100vh;z-index:34;display:flex;align-items:stretch;gap:12px;padding:16px 18px 16px 20px;background:rgba(255,255,255,.95);border:1px solid #c8d9f4;border-left:0;border-radius:0 16px 16px 0;box-shadow:var(--shadow);overflow-y:auto;transition:box-shadow .2s ease}
  .coach-summary:focus-within{box-shadow:0 12px 28px rgba(10,102,194,.2)}
  .coach-summary-body{display:flex;flex-direction:column;gap:10px;color:#1f4f94;font-size:12px;line-height:1.4}
  .coach-summary-body[role="status"]{max-width:200px}
  .coach-summary-title{margin:0;font-size:13px;font-weight:700;color:#0f3e7c}
  .coach-summary-item{display:flex;flex-direction:column;gap:4px}
  .coach-summary-label{text-transform:uppercase;letter-spacing:.4px;font-weight:600;color:#5271a6;font-size:11px}
  .coach-summary-value{font-weight:700;font-size:16px;color:#0f3e7c}
  .coach-summary-subtext{color:#2c4f80;font-size:12px}
  .coach-summary-metrics{display:flex;gap:12px}
  .coach-summary-metric{display:flex;flex-direction:column;gap:4px;min-width:70px}
  .coach-summary-toggle{margin-left:auto;background:var(--brand);color:#fff;border:0;border-radius:999px;width:34px;height:34px;display:grid;place-items:center;cursor:pointer;box-shadow:0 6px 16px rgba(10,102,194,.25);transition:background .2s ease,transform .2s ease}
  .coach-summary-toggle:hover{background:var(--brand-d)}
  .coach-summary.coach-open .coach-summary-toggle{background:#1b4f8f}
  .coach-summary-chevron{font-size:18px;transition:transform .2s ease}
  .coach-summary.coach-open .coach-summary-chevron{transform:rotate(180deg)}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  @media (max-width: 960px){:root{--coach-summary-width:220px}.coach-summary{padding:14px 16px}.coach-summary-body[role="status"]{max-width:170px}}
  .app.coach-open{margin-left:300px;padding-left:0}
  .coach-inner::-webkit-scrollbar{width:6px}
  .coach-inner::-webkit-scrollbar-thumb{background:rgba(10,102,194,.35);border-radius:999px}
  @media (max-width: 960px){.app.coach-open{margin-left:0}.sprint-coach{width:min(320px,85vw)}.coach-grid{grid-template-columns:1fr}}
  @media (max-width: 980px){ .board{grid-template-columns:1fr 1fr} }
  @media (max-width: 640px){ .board{grid-template-columns:1fr} .row{grid-template-columns:1fr} .pill{display:none} }
</style>
</head>
<body>
<div class="app">
  <aside class="coach-summary" id="coachSummary" role="complementary" aria-label="Sprint coach summary">
    <div class="coach-summary-body" id="coachSummaryBody" role="status" aria-live="polite" aria-atomic="true">
      <p class="coach-summary-title">Sprint Snapshot</p>
      <div class="coach-summary-item">
        <span class="coach-summary-label">Today&rsquo;s Progress</span>
        <span class="coach-summary-value" id="coachSummaryProgressValue">0 / 0</span>
        <span class="coach-summary-subtext" id="coachSummaryProgressNote">Let&rsquo;s get your first win of the day.</span>
      </div>
      <div class="coach-summary-item">
        <span class="coach-summary-label">Quick Insight</span>
        <span class="coach-summary-subtext" id="coachSummaryInsight">Insights will appear here soon.</span>
      </div>
      <div class="coach-summary-metrics" aria-label="Resume and job description metrics">
        <div class="coach-summary-metric">
          <span class="coach-summary-label">Resume</span>
          <span class="coach-summary-value" id="coachSummaryResume">--</span>
        </div>
        <div class="coach-summary-metric">
          <span class="coach-summary-label">JD Fit</span>
          <span class="coach-summary-value" id="coachSummaryJDFit">--</span>
        </div>
      </div>
      <div class="coach-summary-item">
        <span class="coach-summary-label">Coach Tip</span>
        <span class="coach-summary-subtext" id="coachSummaryTip">Fresh tips are loading.</span>
      </div>
    </div>
    <button class="coach-summary-toggle" id="coachSummaryToggle" type="button" aria-controls="sprintCoachPanel" aria-expanded="false" aria-label="Open Sprint Coach">
      <span class="sr-only">Open Sprint Coach</span>
      <span class="coach-summary-chevron" aria-hidden="true">‚Ä∫</span>
    </button>
  </aside>
  <aside class="sprint-coach" id="sprintCoachPanel" aria-hidden="true">
    <div class="coach-inner">
      <div class="coach-header">
        <div>
          <h2>üèÅ Sprint Coach</h2>
          <p class="coach-subtitle">Your daily guide to consistency and progress.</p>
          <p class="coach-profile" id="coachProfileLine">Hey there! You&rsquo;re 80% ready to sprint.</p>
        </div>
        <button class="coach-close" id="coachCloseBtn" type="button" aria-label="Close Sprint Coach">‚úï</button>
      </div>

      <section class="coach-section" aria-labelledby="coachMotivationTitle">
        <div class="coach-section-title" id="coachMotivationTitle">Daily Motivation</div>
        <p class="coach-quote" id="coachQuoteText">Consistency beats intensity. One application today can change everything.</p>
        <button class="coach-mini-btn" id="newQuoteBtn" type="button">New quote</button>
      </section>

      <section class="coach-section" aria-labelledby="coachGoalsTitle">
        <div class="coach-section-title" id="coachGoalsTitle">Your Sprint Goals</div>
        <div class="coach-progress">
          <div class="coach-progress-bar"><div class="coach-progress-fill" id="goalProgressFill"></div></div>
          <div class="coach-progress-text" id="goalProgressText">0 of 0 applications today</div>
        </div>
        <div class="coach-note" id="goalStreakText">Keep it going!</div>
      </section>

      <section class="coach-section" aria-labelledby="coachInsightsTitle">
        <div class="coach-section-title" id="coachInsightsTitle">Quick Insights</div>
        <div class="coach-grid" id="coachInsightsGrid"></div>
      </section>

      <section class="coach-section" aria-labelledby="coachHealthTitle">
        <div class="coach-section-title" id="coachHealthTitle">Career Health</div>
        <div class="coach-metric"><span>Resume Score</span><strong id="coachResumeScore">85</strong></div>
        <div class="coach-metric"><span>JD Fit Avg</span><strong id="coachJDFit">72</strong></div>
        <div class="coach-suggestion" id="coachSuggestion">Top suggestion: Add measurable outcomes in your Experience section.</div>
        <button class="coach-mini-btn outline" id="recheckResumeBtn" type="button">Recheck Resume</button>
      </section>

      <section class="coach-section" aria-labelledby="coachTipsTitle">
        <div class="coach-section-headline" id="coachTipsTitle"><span>Coach Tips</span>
          <button class="coach-icon-btn" id="refreshTipsBtn" type="button" aria-label="Refresh tips">‚ü≥</button>
        </div>
        <ul class="coach-tips" id="coachTipsList"></ul>
      </section>

      <footer class="coach-footer">
        <div>Powered by JobSprint</div>
        <div>AI insights coming soon ‚ú®</div>
      </footer>
    </div>
  </aside>
  <!-- top bar -->
  <div class="top">
    <div class="topin">
      <div class="brand">
        <div class="badge"><img src="logo_illustration.png" alt="JobSprint logo" loading="lazy"></div>
        <div>
          <div style="font-weight:700;">JobSprint</div>
          <div id="userLine" style="font-size:12px;color:#2c4f80;">Welcome back</div>
        </div>
      </div>
      <div class="navspacer"></div>
      <div class="pill" id="goalPill">Goal: <strong id="goalNum">4</strong> / day</div>
      <button class="ham" id="hamBtn">‚ò∞</button>
      <div class="dropdown" id="menu">
        <a href="onboarding.html">Edit onboarding info</a>
        <a href="#" id="exportBtn">Export board (JSON)</a>
        <a href="#" id="deleteAccountBtn">Delete account</a>
        <a href="#" id="signoutBtn">Sign out</a>
      </div>
    </div>
  </div>

  <!-- header stats -->
  <div class="head">
    <div class="stat">Today‚Äôs applications: <strong id="todayCount">0</strong></div>
    <div class="stat">This week: <strong id="weekCount">0</strong></div>
    <button class="btn" id="addBtn">+ Add Application</button>
    <button class="btn ghost" id="resetBtn">Reset board</button>
  </div>

  <!-- board -->
  <div class="board" id="board">
    <div class="lane" data-col="research">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Research / To Apply</h3><span class="count" data-count="research">0</span></div>
        <p class="lane-desc">Track roles you&rsquo;re exploring, prepping, or yet to apply for.</p>
      </div>
      <div class="cards" data-drop="research"></div>
      <div class="empty">Drag Applications here</div>
    </div>
    <div class="lane" data-col="applied">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Applied</h3><span class="count" data-count="applied">0</span></div>
        <p class="lane-desc">Applications you&rsquo;ve submitted and are waiting to hear back on.</p>
      </div>
      <div class="cards" data-drop="applied"></div>
      <div class="empty">Drag Applications here</div>
    </div>
    <div class="lane" data-col="screening">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Screening</h3><span class="count" data-count="screening">0</span></div>
        <p class="lane-desc">Move your application to this stage when a recruiter has replied or requested more information.</p>
      </div>
      <div class="cards" data-drop="screening"></div>
      <div class="empty">Drag Applications here</div>
    </div>
    <div class="lane" data-col="interviewing">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Interviewing</h3><span class="count" data-count="interviewing">0</span></div>
        <p class="lane-desc">Move your application to this stage when interviews have been scheduled or are in progress.</p>
      </div>
      <div class="cards" data-drop="interviewing"></div>
      <div class="empty">Drag Applications here</div>
    </div>
    <div class="lane" data-col="offer">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Offer Received</h3><span class="count" data-count="offer">0</span></div>
        <p class="lane-desc">Move your application to this stage when you&rsquo;ve received a verbal or written offer.</p>
      </div>
      <div class="cards" data-drop="offer"></div>
      <div class="empty">Drag Applications here</div>
    </div>
    <div class="lane" data-col="rejected">
      <div class="lanehead">
        <div class="lanehead-top"><h3>Rejected</h3><span class="count" data-count="rejected">0</span></div>
        <p class="lane-desc">Move your application to this stage when the process didn&rsquo;t move forward or the company declined your application.</p>
      </div>
      <div class="cards" data-drop="rejected"></div>
      <div class="empty">Drag Applications here</div>
    </div>
  </div>
</div>

<!-- modal -->
<div class="modalBG" id="modalBG" aria-hidden="true">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title-block">
        <h3 id="modalTitle">New Application</h3>
        <div class="stage-meta" id="stageDetailsContent"></div>
      </div>
        <button class="modal-close" id="modalCloseBtn" type="button" aria-label="Close">‚úï</button>
    </div>
    <div class="row">
      <div>
        <label>Company</label>
        <input id="m_company" placeholder="Acme Inc."/>
      </div>
      <div>
        <label>Role</label>
        <input id="m_role" placeholder="Product Manager"/>
      </div>
      <div>
        <label>JD link</label>
        <input id="m_link" placeholder="https://..."/>
      </div>
      <div>
        <label>Deadline (optional)</label>
        <input type="date" id="m_deadline"/>
      </div>
    </div>
    <label style="margin-top:10px">Notes</label>
    <textarea id="m_notes" placeholder="Anything important about this application..."></textarea>

    <div class="section job-fit" id="jobFitSection">
      <div class="job-fit-head">
        <div>
          <h4>Job Description &amp; Fit</h4>
          <p class="job-fit-copy">Paste the JD and analyze how well you match before saving.</p>
        </div>
        <button class="btn ghost" id="analyzeFitBtn" type="button" style="align-self:flex-start">Analyze Fit</button>
      </div>
      <textarea id="m_jobdesc" placeholder="Paste JD here"></textarea>
      <div class="fit-results" id="fitResults" style="display:none"></div>
    </div>

    <div class="section" id="questionsSection">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px">
        <h4 style="margin:0">Application Questions</h4>
        <button class="btn ghost" type="button" id="openChatBtn" style="white-space:nowrap">Open AI Chat</button>
      </div>
      <div class="questions-add">
        <input id="questionInput" placeholder="Add question"/>
        <button class="btn" type="button" id="addQuestionBtn">Add</button>
      </div>
      <div id="questionsList"></div>
    </div>

    <div class="actions">
      <button class="btn ghost" id="deleteBtn" style="margin-right:auto;display:none">Delete</button>
      <button class="btn ghost" id="markAppliedBtn" style="display:none">Mark as Applied</button>
      <button class="btn" id="saveBtn">Add</button>
    </div>
  </div>
</div>

<div class="drawerBG" id="chatDrawer" aria-hidden="true">
  <div class="drawer">
    <div class="drawer-head">
      <h4>AI Chat Assistant</h4>
      <button class="btn ghost" id="closeChatBtn" style="padding:6px 10px;font-size:12px">Close</button>
    </div>
    <div class="drawer-body" id="chatBody"></div>
    <div class="drawer-input">
      <textarea id="chatInput" placeholder="Ask the assistant anything about this application..."></textarea>
      <button class="btn" id="chatSendBtn">Send</button>
    </div>
  </div>
</div>


<script src="scripts/theme.js"></script>
<script>
  const qs = new URLSearchParams(location.search);
  const token = qs.get('u') || (JSON.parse(localStorage.getItem('jobsprint_profile')||'{}').token) || 'guest';

  if (!token || token === 'guest') {
    location.href = '/signup.html?mode=login';
  }

  const KEY_BOARD = `jobsprint_board_${token}`;
  const KEY_TODAY = `jobsprint_today_${token}`;
  const profile = JSON.parse(localStorage.getItem('jobsprint_profile') || '{}');

  const motivationalQuotes = [
    'Consistency beats intensity. One application today can change everything.',
    'Small sprints build big wins üí™',
    'Stack tiny moments of focus and the offers will follow.',
    'Your future self is thanking you for showing up right now.',
    'Keep the momentum‚Äîprogress loves persistence.'
  ];

  const coachTipsPool = [
    'Follow up on applications you sent 3 days ago.',
    'Try customizing your resume for top-fit JDs.',
    'Review your job sprint board once before bed.',
    'Reach out to a new connection in your target industry today.',
    'Share a quick win with an accountability buddy.',
    'Block 20 minutes tonight to prep for tomorrow‚Äôs sprint.'
  ];

  function getMotivationalQuote(prevIndex = -1) {
    if (!motivationalQuotes.length) {
      return { text: 'You have everything you need to take the next step.', index: -1 };
    }
    let idx = Math.floor(Math.random() * motivationalQuotes.length);
    if (motivationalQuotes.length > 1) {
      while (idx === prevIndex) {
        idx = Math.floor(Math.random() * motivationalQuotes.length);
      }
    }
    return { text: motivationalQuotes[idx], index: idx };
  }

  function getCoachTips() {
    if (!coachTipsPool.length) return ['Celebrate a recent win to stay energized.'];
    const tips = [];
    const used = new Set();
    while (tips.length < 3 && used.size < coachTipsPool.length) {
      const choice = Math.floor(Math.random() * coachTipsPool.length);
      if (used.has(choice)) continue;
      used.add(choice);
      tips.push(coachTipsPool[choice]);
    }
    return tips;
  }

  function getGoalProgress() {
    return {
      dailyTarget: 3,
      completed: 1,
      streakDays: 5
    };
  }

  function getUserSprintStats() {
    return {
      applicationsAdded: 12,
      responsesReceived: 3,
      interviewsScheduled: 1,
      averageFitScore: 76
    };
  }

  function getATSScore() {
    let storedProfile = {};
    try {
      storedProfile = JSON.parse(localStorage.getItem('jobsprint_profile') || '{}');
    } catch (_) {
      storedProfile = {};
    }
    const userName = storedProfile?.name || 'Sprinter';
    const atsScore = typeof storedProfile?.ats_readiness === 'number' ? Math.round(storedProfile.ats_readiness) : 82;
    const resumeScore = typeof storedProfile?.resume_score === 'number' ? Math.round(storedProfile.resume_score) : 85;
    const jdFitAvg = typeof storedProfile?.jd_fit_avg === 'number' ? Math.round(storedProfile.jd_fit_avg) : 72;
    const topSuggestion = storedProfile?.top_suggestion || 'Add measurable outcomes in your Experience section.';
    return { userName, atsScore, resumeScore, jdFitAvg, topSuggestion };
  }

  const COLUMNS = ['research','applied','screening','interviewing','offer','rejected'];
  const LANE_TITLES = {
    research: 'Research / To Apply',
    applied: 'Applied',
    screening: 'Screening',
    interviewing: 'Interviewing',
    offer: 'Offer Received',
    rejected: 'Rejected'
  };
  const STOP_WORDS = new Set(['about','above','after','again','against','all','also','am','an','and','any','are','as','at','be','because','been','before','being','below','between','both','but','by','can','could','did','do','does','doing','down','during','each','few','for','from','further','had','has','have','having','he','her','here','hers','herself','him','himself','his','how','if','in','into','is','it','its','itself','just','more','most','my','myself','no','nor','not','now','of','off','on','once','only','or','other','our','ours','ourselves','out','over','own','same','she','should','so','some','such','than','that','the','their','theirs','them','themselves','then','there','these','they','this','those','through','to','too','under','until','up','very','was','we','were','what','when','where','which','while','who','whom','why','will','with','you','your','yours','yourself','yourselves']);

  const notify = (message, options) => {
    if (window.JobSprintUI && typeof window.JobSprintUI.showToast === 'function') {
      return window.JobSprintUI.showToast(message, options || {});
    }
    return null;
  };

  const notifyLoading = (message, options) => {
    if (window.JobSprintUI && typeof window.JobSprintUI.showLoadingToast === 'function') {
      return window.JobSprintUI.showLoadingToast(message, options || {});
    }
    return null;
  };

  const redirectWithToast = (url, message) => {
    const toast = notifyLoading(message || 'Redirecting‚Ä¶');
    setTimeout(() => {
      toast?.update?.('Almost there‚Ä¶');
      window.location.href = url;
    }, 180);
  };

  function generateId(prefix='c') {
    return `${prefix}_${Math.random().toString(16).slice(2)}${Date.now().toString(16)}`;
  }

  function getFitBand(score) {
    if (score >= 80) return 'High';
    if (score >= 60) return 'Medium';
    return 'Low';
  }

  function createBlankCard() {
    return {
      company: '',
      role: '',
      link: '',
      deadline: '',
      notes: '',
      jobDescription: '',
      resumeVersion: 'Resume v1',
      savedAt: Date.now(),
      fit: { score: null, band: '', matches: [], missing: [] },
      appliedInfo: { date: '', source: '' },
      screeningInfo: { replied: false, assessmentDue: '', infoShared: '' },
      interviewingRounds: [],
      offerInfo: { ctc: '', joiningDate: '', status: '' },
      rejectedInfo: { reason: '', date: '' },
      questions: [],
      created_at: Date.now()
    };
  }

  function upgradeCard(card) {
    if (!card) return { ...createBlankCard(), id: generateId('c') };
    const upgraded = { ...createBlankCard() };
    upgraded.id = card.id || generateId('c');
    upgraded.company = card.company || '';
    upgraded.role = card.role || '';
    upgraded.link = card.link || '';
    upgraded.deadline = card.deadline || '';
    upgraded.notes = card.notes || '';
    upgraded.jobDescription = card.jobDescription || card.job_description || '';
    upgraded.resumeVersion = card.resumeVersion || card.resume_version || upgraded.resumeVersion;
    upgraded.savedAt = card.savedAt || card.saved_at || card.created_at || upgraded.savedAt;
    upgraded.created_at = card.created_at || upgraded.created_at;
    if (card.fit || typeof card.fit_score === 'number') {
      const fitScore = card.fit?.score ?? card.fit_score;
      upgraded.fit.score = typeof fitScore === 'number' ? Math.max(0, Math.min(100, Math.round(fitScore))) : null;
      upgraded.fit.matches = Array.isArray(card.fit?.matches) ? card.fit.matches : (Array.isArray(card.fit_matches) ? card.fit_matches : []);
      upgraded.fit.missing = Array.isArray(card.fit?.missing) ? card.fit.missing : (Array.isArray(card.fit_missing) ? card.fit_missing : []);
      upgraded.fit.band = card.fit?.band || (upgraded.fit.score != null ? getFitBand(upgraded.fit.score) : '');
    }
    upgraded.appliedInfo = {
      date: card.appliedInfo?.date || card.applied_date || '',
      source: card.appliedInfo?.source || card.source || ''
    };
    upgraded.screeningInfo = {
      replied: card.screeningInfo?.replied ?? false,
      assessmentDue: card.screeningInfo?.assessmentDue || card.assessment_due || '',
      infoShared: card.screeningInfo?.infoShared || card.info_shared || ''
    };
    upgraded.interviewingRounds = Array.isArray(card.interviewingRounds)
      ? card.interviewingRounds.map(r => ({ id: r.id || generateId('r'), name: r.name || '', datetime: r.datetime || '' }))
      : [];
    upgraded.offerInfo = {
      ctc: card.offerInfo?.ctc || card.ctc || '',
      joiningDate: card.offerInfo?.joiningDate || card.joiningDate || '',
      status: card.offerInfo?.status || card.offer_status || ''
    };
    upgraded.rejectedInfo = {
      reason: card.rejectedInfo?.reason || card.rejectionReason || '',
      date: card.rejectedInfo?.date || card.rejectionDate || ''
    };
    upgraded.questions = Array.isArray(card.questions)
      ? card.questions.map(q => ({ id: q.id || generateId('q'), prompt: q.prompt || '', answer: q.answer || '' }))
      : [];
    return upgraded;
  }

  function emptyBoard() {
    return COLUMNS.reduce((acc, col) => { acc[col] = []; return acc; }, {});
  }

  function normalizeBoard(raw) {
    const shaped = emptyBoard();
    if (!raw || typeof raw !== 'object') return shaped;
    if ('to_apply' in raw) {
      shaped.research = (raw.to_apply || []).map(upgradeCard);
      shaped.applied = (raw.applied || []).map(upgradeCard);
      shaped.screening = (raw.screening || []).map(upgradeCard);
      shaped.interviewing = (raw.interviewing || []).map(upgradeCard);
      shaped.offer = (raw.offer || []).map(upgradeCard);
      shaped.rejected = (raw.rejected || []).map(upgradeCard);
      return shaped;
    }
    COLUMNS.forEach(col => {
      if (Array.isArray(raw[col])) {
        shaped[col] = raw[col].map(upgradeCard);
      }
    });
    return shaped;
  }

  let board = normalizeBoard(JSON.parse(localStorage.getItem(KEY_BOARD) || 'null'));

  const userLine = document.getElementById('userLine');
  const goalNum = document.getElementById('goalNum');
  const todayCountEl = document.getElementById('todayCount');
  const weekCountEl = document.getElementById('weekCount');
  const sprintCoachPanel = document.getElementById('sprintCoachPanel');
  const coachCloseBtn = document.getElementById('coachCloseBtn');
  const coachSummary = document.getElementById('coachSummary');
  const coachSummaryToggle = document.getElementById('coachSummaryToggle');
  const coachSummaryProgressValue = document.getElementById('coachSummaryProgressValue');
  const coachSummaryProgressNote = document.getElementById('coachSummaryProgressNote');
  const coachSummaryInsight = document.getElementById('coachSummaryInsight');
  const coachSummaryResume = document.getElementById('coachSummaryResume');
  const coachSummaryJDFit = document.getElementById('coachSummaryJDFit');
  const coachSummaryTip = document.getElementById('coachSummaryTip');
  const coachProfileLine = document.getElementById('coachProfileLine');
  const coachQuoteText = document.getElementById('coachQuoteText');
  const newQuoteBtn = document.getElementById('newQuoteBtn');
  const goalProgressFill = document.getElementById('goalProgressFill');
  const goalProgressText = document.getElementById('goalProgressText');
  const goalStreakText = document.getElementById('goalStreakText');
  const coachInsightsGrid = document.getElementById('coachInsightsGrid');
  const coachResumeScore = document.getElementById('coachResumeScore');
  const coachJDFit = document.getElementById('coachJDFit');
  const coachSuggestion = document.getElementById('coachSuggestion');
  const recheckResumeBtn = document.getElementById('recheckResumeBtn');
  const coachTipsList = document.getElementById('coachTipsList');
  const refreshTipsBtn = document.getElementById('refreshTipsBtn');
  const appShell = document.querySelector('.app');

  let currentQuoteIndex = -1;
  let lastCoachTips = [];

  function setCoachOpen(open) {
    if (!sprintCoachPanel) return;
    sprintCoachPanel.classList.toggle('open', open);
    sprintCoachPanel.setAttribute('aria-hidden', open ? 'false' : 'true');
    if (appShell) appShell.classList.toggle('coach-open', open);
    if (coachSummaryToggle) {
      coachSummaryToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
      coachSummaryToggle.setAttribute('aria-label', open ? 'Sprint Coach is open' : 'Open Sprint Coach');
      coachSummaryToggle.disabled = open;
    }
    if (coachSummary) {
      coachSummary.classList.toggle('coach-open', open);
    }
  }

  function showNewQuote() {
    const { text, index } = getMotivationalQuote(currentQuoteIndex);
    currentQuoteIndex = index;
    if (coachQuoteText) coachQuoteText.textContent = text;
  }

  function renderGoalProgress() {
    const goal = getGoalProgress();
    const target = Math.max(goal.dailyTarget || 0, 0);
    const completed = Math.max(goal.completed || 0, 0);
    const percent = target > 0 ? Math.min(100, Math.round((completed / target) * 100)) : 0;
    const summaryProgress = `${completed} / ${target}`;
    const streak = Math.max(goal.streakDays || 0, 0);
    const streakMessage = streak
      ? `You‚Äôre on a ${streak}-day streak üî• Keep it going!`
      : 'Start a new streak today‚Äîyou got this!';
    if (goalProgressFill) goalProgressFill.style.width = `${percent}%`;
    if (goalProgressText) goalProgressText.textContent = `${completed} of ${target} applications today`;
    if (goalStreakText) goalStreakText.textContent = streakMessage;
    if (coachSummaryProgressValue) coachSummaryProgressValue.textContent = summaryProgress;
    if (coachSummaryProgressNote) coachSummaryProgressNote.textContent = streakMessage;
  }

  function renderInsights() {
    if (!coachInsightsGrid) return;
    coachInsightsGrid.innerHTML = '';
    const stats = getUserSprintStats();
    const items = [
      { label: 'Applications Added', value: stats.applicationsAdded },
      { label: 'Responses Received', value: stats.responsesReceived },
      { label: 'Interviews Scheduled', value: stats.interviewsScheduled },
      { label: 'Average Fit Score', value: `${stats.averageFitScore}%` }
    ];
    items.forEach(({ label, value }) => {
      const card = document.createElement('div');
      card.className = 'coach-stat';
      const title = document.createElement('span');
      title.textContent = label;
      const strong = document.createElement('strong');
      strong.textContent = value;
      card.append(strong, title);
      coachInsightsGrid.appendChild(card);
    });
    if (coachSummaryInsight) {
      const primary = items[0];
      coachSummaryInsight.textContent = primary
        ? `${primary.label}: ${primary.value}`
        : 'Insights will appear here soon.';
    }
  }

  function renderCareerHealth() {
    const { userName, atsScore, resumeScore, jdFitAvg, topSuggestion } = getATSScore();
    if (coachProfileLine) coachProfileLine.textContent = `Hey, ${userName}! You‚Äôre ${atsScore}% ready to sprint.`;
    if (coachResumeScore) coachResumeScore.textContent = resumeScore;
    if (coachJDFit) coachJDFit.textContent = jdFitAvg;
    if (coachSuggestion) coachSuggestion.textContent = `Top suggestion: ${topSuggestion}`;
    if (coachSummaryResume) coachSummaryResume.textContent = String(resumeScore);
    if (coachSummaryJDFit) coachSummaryJDFit.textContent = String(jdFitAvg);
  }

  function renderCoachTips(forceNew = false) {
    if (!coachTipsList) return;
    if (!lastCoachTips.length || forceNew) {
      lastCoachTips = getCoachTips();
    }
    coachTipsList.innerHTML = '';
    lastCoachTips.forEach(tip => {
      const item = document.createElement('li');
      item.textContent = tip;
      coachTipsList.appendChild(item);
    });
    if (coachSummaryTip) {
      const primaryTip = lastCoachTips[0];
      coachSummaryTip.textContent = primaryTip || 'Fresh tips are loading.';
    }
  }

  function hydrateSprintCoach() {
    if (!sprintCoachPanel) return;
    if (currentQuoteIndex === -1) showNewQuote();
    else if (coachQuoteText && motivationalQuotes[currentQuoteIndex]) {
      coachQuoteText.textContent = motivationalQuotes[currentQuoteIndex];
    }
    renderGoalProgress();
    renderInsights();
    renderCareerHealth();
    renderCoachTips();
  }

  function initSprintCoach() {
    if (!sprintCoachPanel) return;
    setCoachOpen(false);
    hydrateSprintCoach();
    coachCloseBtn?.addEventListener('click', () => setCoachOpen(false));
    coachSummaryToggle?.addEventListener('click', () => setCoachOpen(true));
    newQuoteBtn?.addEventListener('click', () => {
      showNewQuote();
    });
    refreshTipsBtn?.addEventListener('click', () => {
      renderCoachTips(true);
    });
    recheckResumeBtn?.addEventListener('click', () => {
      location.href = `/sprint-readiness.html?u=${encodeURIComponent(token)}`;
    });
  }

  initSprintCoach();

  (async () => {
    try {
      const r = await fetch('/api/get-user-by-token?token=' + encodeURIComponent(token), { headers: { 'cache-control': 'no-cache' } });
      if (r.ok) {
        const data = await r.json();
        if (data.found) {
          const merged = { ...(profile || {}), name: data.name, email: data.email, applications_goal_per_day: data.goal_per_day, google_id: data.google_id, token };
          localStorage.setItem('jobsprint_profile', JSON.stringify(merged));
          userLine.textContent = data.name ? `Hello, ${data.name}` : 'Welcome back';
          goalNum.textContent = data.goal_per_day || 4;
          hydrateSprintCoach();
          return;
        }
      }
      userLine.textContent = profile?.name ? `Hello, ${profile.name}` : 'Welcome back';
      goalNum.textContent = profile?.applications_goal_per_day || 4;
      hydrateSprintCoach();
    } catch {
      userLine.textContent = profile?.name ? `Hello, ${profile.name}` : 'Welcome back';
      goalNum.textContent = profile?.applications_goal_per_day || 4;
      hydrateSprintCoach();
    }
  })();

  function saveBoard() {
    localStorage.setItem(KEY_BOARD, JSON.stringify(board));
  }

  function clearLocalUserData() {
    try { localStorage.removeItem(KEY_BOARD); } catch (_) {}
    try { localStorage.removeItem(KEY_TODAY); } catch (_) {}
    try { localStorage.removeItem('jobsprint_profile'); } catch (_) {}
  }

  function formatShortDate(input) {
    if (!input) return '';
    const date = typeof input === 'number' ? new Date(input) : new Date(input);
    if (Number.isNaN(date.getTime())) return '';
    return date.toLocaleDateString(undefined, { day: '2-digit', month: 'short' });
  }

  function formatDateTimeDisplay(value) {
    if (!value) return '';
    const dt = new Date(value);
    if (Number.isNaN(dt.getTime())) return value;
    const day = dt.toLocaleDateString(undefined, { weekday: 'short' });
    const time = dt.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
    return `${day} ${time}`;
  }

  function escapeHtml(str) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' };
    return (str || '').replace(/[&<>"']/g, ch => map[ch] || ch);
  }

  function getCardBadges(card, stage) {
    const badges = [];
    if (stage === 'research') {
      if (card.fit?.score != null) badges.push(`Fit Score ${card.fit.score}%`);
      if (card.resumeVersion) badges.push(card.resumeVersion);
      const saved = formatShortDate(card.savedAt);
      if (saved) badges.push(`Saved ${saved}`);
    } else if (stage === 'applied') {
      const appliedDate = card.appliedInfo?.date || '';
      const formatted = formatShortDate(appliedDate);
      if (formatted) badges.push(`Applied ${formatted}`);
      if (card.appliedInfo?.source) badges.push(`Source: ${card.appliedInfo.source}`);
    } else if (stage === 'screening') {
      if (card.screeningInfo?.replied) badges.push('Replied');
      const due = formatShortDate(card.screeningInfo?.assessmentDue);
      if (due) badges.push(`Assessment due ${due}`);
      if (card.screeningInfo?.infoShared) badges.push('Info shared');
    } else if (stage === 'interviewing') {
      (card.interviewingRounds || []).forEach(round => {
        if (!round) return;
        const name = round.name || 'Round';
        const schedule = formatDateTimeDisplay(round.datetime);
        badges.push(`${name}${schedule ? ` ${schedule}` : ''}`.trim());
      });
    } else if (stage === 'offer') {
      if (card.offerInfo?.ctc) badges.push(`CTC: ${card.offerInfo.ctc}`);
      const joining = formatShortDate(card.offerInfo?.joiningDate);
      if (joining) badges.push(`Joining ${joining}`);
      if (card.offerInfo?.status) badges.push(`Status: ${card.offerInfo.status}`);
    } else if (stage === 'rejected') {
      if (card.rejectedInfo?.reason) badges.push(`Reason: ${card.rejectedInfo.reason}`);
      const rejectDate = formatShortDate(card.rejectedInfo?.date);
      if (rejectDate) badges.push(`Date ${rejectDate}`);
    }
    return badges.filter(Boolean);
  }

  function cardHTML(card, stage) {
    const header = `<div class="card-header"><strong>${escapeHtml(card.company || 'Company')}</strong> ‚Äî <span class="card-role">${escapeHtml(card.role || 'Role TBD')}</span></div>`;
    const badges = getCardBadges(card, stage);
    const visible = badges.slice(0, 5).map(text => `<span class="card-badge">${escapeHtml(text)}</span>`).join('');
    const overflow = badges.length > 5 ? `<span class="card-badge more">+${badges.length - 5}</span>` : '';
    const linkUrl = card.link ? escapeHtml(card.link) : '';
    const link = card.link ? `<div><small><a href="${linkUrl}" target="_blank" rel="noopener">Job link</a></small></div>` : '';
    const notes = card.notes ? `<div style="color:#3b5a85;font-size:13px">${escapeHtml(card.notes).replace(/\n/g,'<br/>')}</div>` : '';
    return `
      <div class="card" draggable="true" data-id="${card.id}">
        ${header}
        ${badges.length ? `<div class="card-badges">${visible}${overflow}</div>` : ''}
        ${link}
        ${notes}
      </div>
    `;
  }

  function updateCounts() {
    COLUMNS.forEach(col => {
      const count = board[col].length;
      const badge = document.querySelector(`[data-count="${col}"]`);
      if (badge) badge.textContent = count;
      const lane = document.querySelector(`.lane[data-col="${col}"]`);
      if (lane) lane.querySelector('.empty').style.display = count ? 'none' : 'grid';
    });
  }

  function renderBoard() {
    COLUMNS.forEach(col => {
      const wrap = document.querySelector(`[data-drop="${col}"]`);
      if (!wrap) return;
      wrap.innerHTML = board[col].map(card => cardHTML(card, col)).join('');
    });
    updateCounts();
    enableDnD();
    attachCardActions();
  }

  function enableDnD() {
    document.querySelectorAll('.card').forEach(el => {
      el.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', el.getAttribute('data-id'));
        setTimeout(() => el.style.opacity = 0.5, 0);
      });
      el.addEventListener('dragend', () => el.style.opacity = 1);
    });
    document.querySelectorAll('.cards').forEach(drop => {
      drop.addEventListener('dragover', e => e.preventDefault());
      drop.addEventListener('drop', e => {
        e.preventDefault();
        const id = e.dataTransfer.getData('text/plain');
        const targetCol = drop.getAttribute('data-drop');
        moveCard(id, targetCol);
      });
    });
  }

  function handleStageChange(card, from, dest) {
    if (dest === 'research' && !card.savedAt) {
      card.savedAt = Date.now();
    }
    if (dest === 'applied' && from !== 'applied') {
      if (!card.appliedInfo) card.appliedInfo = { date: '', source: '' };
      if (!card.appliedInfo.date) card.appliedInfo.date = todayKeyDate();
      if (!card.appliedInfo.source) card.appliedInfo.source = 'Manual';
      bumpToday();
    }
    if (dest === 'screening') {
      if (!card.screeningInfo) card.screeningInfo = { replied: false, assessmentDue: '', infoShared: '' };
      card.screeningInfo.replied = true;
      if (!card.screeningInfo.infoShared) card.screeningInfo.infoShared = 'Pending';
    }
    if (dest === 'rejected' && !card.rejectedInfo?.date) {
      if (!card.rejectedInfo) card.rejectedInfo = { reason: '', date: '' };
      card.rejectedInfo.date = todayKeyDate();
    }
  }

  function moveCard(id, dest) {
    if (!COLUMNS.includes(dest)) return;
    let card = null;
    let fromCol = null;
    let index = -1;
    for (const col of COLUMNS) {
      index = board[col].findIndex(x => x.id === id);
      if (index > -1) {
        card = board[col][index];
        fromCol = col;
        board[col].splice(index, 1);
        break;
      }
    }
    if (!card) return;
    card = upgradeCard(card);
    handleStageChange(card, fromCol, dest);
    board[dest].unshift(card);
    saveBoard();
    renderBoard();
  }

  function locateCard(id) {
    for (const col of COLUMNS) {
      const idx = board[col].findIndex(x => x.id === id);
      if (idx > -1) {
        return { col, idx, card: board[col][idx] };
      }
    }
    return null;
  }

  function todayKeyDate() {
    return new Date().toISOString().slice(0, 10);
  }

  function getWeekNum(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  }

  function loadToday() {
    const raw = JSON.parse(localStorage.getItem(KEY_TODAY) || 'null') || { date: todayKeyDate(), count: 0, week: {} };
    if (raw.date !== todayKeyDate()) {
      raw.date = todayKeyDate();
      raw.count = 0;
    }
    return raw;
  }

  function saveToday(t) {
    localStorage.setItem(KEY_TODAY, JSON.stringify(t));
  }

  function bumpToday() {
    const t = loadToday();
    t.count += 1;
    const d = new Date();
    const wk = d.getFullYear() + '-W' + getWeekNum(d);
    t.week[wk] = (t.week[wk] || 0) + 1;
    saveToday(t);
    reflectToday();
  }

  function reflectToday() {
    const t = loadToday();
    todayCountEl.textContent = t.count;
    const d = new Date();
    const wk = d.getFullYear() + '-W' + getWeekNum(d);
    weekCountEl.textContent = t.week[wk] || 0;
  }

  const modalBG = document.getElementById('modalBG');
  const modalTitle = document.getElementById('modalTitle');
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  const saveBtn = document.getElementById('saveBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const markAppliedBtn = document.getElementById('markAppliedBtn');
  const companyInput = document.getElementById('m_company');
  const roleInput = document.getElementById('m_role');
  const linkInput = document.getElementById('m_link');
  const deadlineInput = document.getElementById('m_deadline');
  const notesInput = document.getElementById('m_notes');
  const jobDescEl = document.getElementById('m_jobdesc');
  const fitResultsEl = document.getElementById('fitResults');
  const analyzeFitBtn = document.getElementById('analyzeFitBtn');
  const questionInput = document.getElementById('questionInput');
  const questionsListEl = document.getElementById('questionsList');
  const addQuestionBtn = document.getElementById('addQuestionBtn');
  const openChatBtn = document.getElementById('openChatBtn');
  const stageDetailsContent = document.getElementById('stageDetailsContent');
  const chatDrawer = document.getElementById('chatDrawer');
  const chatBody = document.getElementById('chatBody');
  const chatInput = document.getElementById('chatInput');
  const chatSendBtn = document.getElementById('chatSendBtn');
  const closeChatBtn = document.getElementById('closeChatBtn');
  const menu = document.getElementById('menu');

  let editingCardId = null;
  let workingCol = 'research';
  let workingIndex = -1;
  let modalStage = 'research';
  let workingCard = null;
  let questionExpansion = {};
  let chatHistory = [];

  function setModalVisibility(show) {
    modalBG.style.display = show ? 'flex' : 'none';
    modalBG.setAttribute('aria-hidden', show ? 'false' : 'true');
  }

  function attachCardActions() {
    document.querySelectorAll('.card').forEach(el => {
      el.addEventListener('click', evt => {
        if (evt.target.closest('a')) return;
        const id = el.getAttribute('data-id');
        openModalForEdit(id);
      });
    });
  }

  function populateModal() {
    if (!workingCard) return;
    companyInput.value = workingCard.company || '';
    roleInput.value = workingCard.role || '';
    linkInput.value = workingCard.link || '';
    deadlineInput.value = workingCard.deadline || '';
    notesInput.value = workingCard.notes || '';
    jobDescEl.value = workingCard.jobDescription || '';
    renderFitResults();
    renderQuestionsList();
    renderStageDetails();
    markAppliedBtn.style.display = editingCardId && modalStage === 'research' ? 'inline-flex' : 'none';
  }

  function openModalForNew() {
    editingCardId = null;
    workingCard = { ...createBlankCard(), id: generateId('c') };
    workingCol = 'research';
    workingIndex = -1;
    modalStage = 'research';
    questionExpansion = {};
    chatHistory = [];
    modalTitle.textContent = 'New Application';
    saveBtn.textContent = 'Add';
    deleteBtn.style.display = 'none';
    markAppliedBtn.style.display = 'none';
    populateModal();
    setModalVisibility(true);
    companyInput.focus();
  }

  function openModalForEdit(id) {
    const located = locateCard(id);
    if (!located) return;
    editingCardId = id;
    workingCol = located.col;
    workingIndex = located.idx;
    modalStage = located.col;
    workingCard = upgradeCard(JSON.parse(JSON.stringify(located.card)));
    workingCard.id = id;
    questionExpansion = {};
    workingCard.questions.forEach(q => { questionExpansion[q.id] = true; });
    chatHistory = [];
    modalTitle.textContent = 'Edit Application';
    saveBtn.textContent = 'Save changes';
    deleteBtn.style.display = 'inline-flex';
    populateModal();
    setModalVisibility(true);
    companyInput.focus();
  }

  function closeModal() {
    setModalVisibility(false);
    editingCardId = null;
    workingCard = null;
    chatHistory = [];
    questionExpansion = {};
    closeChat();
  }

  function renderFitResults() {
    if (!workingCard) return;
    const fit = workingCard.fit || { score: null, matches: [], missing: [] };
    if (fit.score == null) {
      fitResultsEl.style.display = 'none';
      fitResultsEl.innerHTML = '';
      return;
    }
    fitResultsEl.style.display = 'block';
    const band = fit.band || getFitBand(fit.score);
    const matchesList = (fit.matches || []).length
      ? `<ul class="fit-list">${fit.matches.map(m => `<li>${escapeHtml(m)}</li>`).join('')}</ul>`
      : '<div class="stage-note">No matches yet ‚Äî add strengths to your profile.</div>';
    const missingList = (fit.missing || []).length
      ? `<ul class="fit-list">${fit.missing.map(m => `<li>${escapeHtml(m)}</li>`).join('')}</ul>`
      : '<div class="stage-note">Looks great ‚Äî no major gaps identified.</div>';
    fitResultsEl.innerHTML = `
      <div><strong>Fit Score:</strong> ${fit.score}% <span class="fit-band">${band}</span></div>
      <div style="margin-top:8px;font-weight:600">Matches</div>
      ${matchesList}
      <div style="margin-top:8px;font-weight:600">Missing skills</div>
      ${missingList}
    `;
  }

  function extractKeywords(text, limit = 15) {
    const counts = {};
    (text || '').toLowerCase().match(/\b[a-z]{3,}\b/g)?.forEach(word => {
      if (STOP_WORDS.has(word)) return;
      counts[word] = (counts[word] || 0) + 1;
    });
    return Object.entries(counts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, limit)
      .map(([word]) => word);
  }

  function toTitle(word) {
    return word ? word.charAt(0).toUpperCase() + word.slice(1) : '';
  }

  function analyzeFit() {
    if (!workingCard) return;
    const jd = jobDescEl.value.trim();
    if (!jd) {
      notify('Paste the job description first.', { variant: 'danger' });
      return;
    }
    const keywords = extractKeywords(jd, 20);
    const profileText = [
      profile?.career_story?.strengths,
      profile?.career_story?.journey,
      profile?.career_story?.flow_state_work,
      profile?.career_story?.current_vs_next,
      profile?.career_story?.long_term_vision,
      profile?.role,
      notesInput.value
    ].filter(Boolean).join(' ').toLowerCase();
    const userTokens = new Set((profileText.match(/\b[a-z]{3,}\b/g) || []).filter(word => !STOP_WORDS.has(word)));
    const matches = [];
    const missing = [];
    keywords.forEach(word => {
      if (userTokens.has(word)) matches.push(toTitle(word));
      else missing.push(toTitle(word));
    });
    const total = keywords.length || 1;
    let score = Math.round((matches.length / total) * 100);
    if (!Number.isFinite(score)) score = 0;
    score = Math.max(0, Math.min(100, score));
    workingCard.fit = {
      score,
      band: getFitBand(score),
      matches,
      missing
    };
    renderFitResults();
  }

  function generateAnswer(prompt) {
    const jd = jobDescEl.value.trim();
    const matches = (workingCard?.fit?.matches || []).slice(0, 3);
    const focus = matches.length ? matches.join(', ') : 'my relevant experience and quick learning';
    const headline = extractKeywords(jd, 1)[0];
    const intro = headline ? `The role emphasizes ${headline}, which aligns with` : 'The role aligns with';
    return `For ‚Äú${prompt}‚Äù, I would highlight how ${intro} ${focus}. I can share a recent example that shows measurable impact and outline the next steps I‚Äôm taking for this opportunity.`;
  }

  function renderQuestionsList() {
    questionsListEl.innerHTML = '';
    if (!workingCard || !workingCard.questions.length) {
      const note = document.createElement('div');
      note.className = 'stage-note';
      note.textContent = 'Add prompts to draft answers before forms or screenings.';
      questionsListEl.appendChild(note);
      return;
    }
    workingCard.questions.forEach(q => {
      if (!(q.id in questionExpansion)) questionExpansion[q.id] = false;
      const item = document.createElement('div');
      item.className = 'question-item';
      item.dataset.id = q.id;
      const head = document.createElement('div');
      head.className = 'question-head';
      const qInputEl = document.createElement('input');
      qInputEl.type = 'text';
      qInputEl.value = q.prompt;
      qInputEl.placeholder = 'Question';
      qInputEl.addEventListener('input', e => { q.prompt = e.target.value; });
      const toggleBtn = document.createElement('button');
      toggleBtn.type = 'button';
      toggleBtn.textContent = questionExpansion[q.id] ? '‚ñ¥' : '‚ñæ';
      toggleBtn.addEventListener('click', () => {
        questionExpansion[q.id] = !questionExpansion[q.id];
        renderQuestionsList();
      });
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.textContent = '‚úï';
      removeBtn.style.color = '#275291';
      removeBtn.addEventListener('click', () => {
        workingCard.questions = workingCard.questions.filter(itemQ => itemQ.id !== q.id);
        delete questionExpansion[q.id];
        renderQuestionsList();
      });
      head.append(qInputEl, toggleBtn, removeBtn);
      const body = document.createElement('div');
      body.className = 'question-body';
      body.style.display = questionExpansion[q.id] ? 'flex' : 'none';
      const answerArea = document.createElement('textarea');
      answerArea.value = q.answer || '';
      answerArea.addEventListener('input', e => { q.answer = e.target.value; });
      const regenBtn = document.createElement('button');
      regenBtn.type = 'button';
      regenBtn.className = 'btn ghost';
      regenBtn.textContent = 'Regenerate suggestion';
      regenBtn.addEventListener('click', () => {
        q.answer = generateAnswer(q.prompt || 'this question');
        renderQuestionsList();
      });
      body.append(answerArea, regenBtn);
      item.append(head, body);
      questionsListEl.appendChild(item);
    });
  }

  function addQuestionFromInput() {
    if (!workingCard) return;
    const text = questionInput.value.trim();
    if (!text) return;
    const question = { id: generateId('q'), prompt: text, answer: generateAnswer(text) };
    workingCard.questions.push(question);
    questionExpansion[question.id] = true;
    questionInput.value = '';
    renderQuestionsList();
  }

  function renderStageDetails() {
    stageDetailsContent.innerHTML = '';
    if (!workingCard) return;
    const note = document.createElement('div');
    note.className = 'stage-meta-note';
    note.textContent = `Details shown on cards in the ‚Äú${LANE_TITLES[modalStage]}‚Äù lane.`;
    stageDetailsContent.appendChild(note);
    const builder = {
      research: buildResearchDetails,
      applied: buildAppliedDetails,
      screening: buildScreeningDetails,
      interviewing: buildInterviewingDetails,
      offer: buildOfferDetails,
      rejected: buildRejectedDetails
    }[modalStage];
    if (!builder) return;
    const content = builder();
    if (content) stageDetailsContent.appendChild(content);
    else {
      const empty = document.createElement('div');
      empty.className = 'stage-meta-empty';
      empty.textContent = 'No extra details for this stage yet.';
      stageDetailsContent.appendChild(empty);
    }
  }

  function createStageGrid() {
    const grid = document.createElement('div');
    grid.className = 'stage-meta-grid';
    return grid;
  }

  function createStageStack() {
    const stack = document.createElement('div');
    stack.className = 'stage-meta-stack';
    return stack;
  }

  function createStageItem(label, value, options = {}) {
    const item = document.createElement('div');
    item.className = 'stage-meta-item';
    if (options.full) item.classList.add('full');
    if (options.muted) item.classList.add('muted');
    const labelEl = document.createElement('span');
    labelEl.className = 'stage-meta-label';
    labelEl.textContent = label;
    const valueEl = document.createElement('span');
    valueEl.className = 'stage-meta-value';
    valueEl.textContent = value || '‚Äî';
    item.append(labelEl, valueEl);
    return item;
  }

  function formatDateDisplay(value) {
    if (!value) return '‚Äî';
    const date = typeof value === 'number' ? new Date(value) : new Date(value);
    if (Number.isNaN(date.getTime())) return '‚Äî';
    return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
  }

  function formatDateTimeDisplay(value) {
    if (!value) return '‚Äî';
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return '‚Äî';
    return date.toLocaleString(undefined, {
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit'
    });
  }

  function buildResearchDetails() {
    const grid = createStageGrid();
    grid.append(
      createStageItem('Resume version', workingCard.resumeVersion || 'Resume v1'),
      createStageItem('Saved on', formatDateDisplay(workingCard.savedAt))
    );
    return grid;
  }

  function buildAppliedDetails() {
    const applied = workingCard.appliedInfo || {};
    const grid = createStageGrid();
    grid.append(
      createStageItem('Applied on', formatDateDisplay(applied.date)),
      createStageItem('Source', applied.source || '‚Äî')
    );
    return grid;
  }

  function buildScreeningDetails() {
    const info = workingCard.screeningInfo || {};
    const grid = createStageGrid();
    grid.append(
      createStageItem('Status', info.replied ? 'Replied' : 'Awaiting reply'),
      createStageItem('Assessment due', formatDateDisplay(info.assessmentDue))
    );
    const details = info.infoShared?.trim();
    grid.append(createStageItem('Info shared', details || 'Nothing noted yet.', { full: true, muted: !details }));
    return grid;
  }

  function buildInterviewingDetails() {
    const rounds = workingCard.interviewingRounds || [];
    if (!rounds.length) {
      return createStageItem('Interview rounds', 'No interview rounds added yet.', { full: true, muted: true });
    }
    const stack = createStageStack();
    rounds.forEach((round, idx) => {
      const name = round?.name?.trim();
      const when = formatDateTimeDisplay(round?.datetime);
      const item = createStageItem(`Round ${idx + 1}`, [name || 'Interview', when !== '‚Äî' ? when : 'Timing TBD'].join('\n'), { full: true });
      stack.appendChild(item);
    });
    return stack;
  }

  function buildOfferDetails() {
    const offer = workingCard.offerInfo || {};
    const grid = createStageGrid();
    grid.append(
      createStageItem('CTC', offer.ctc || '‚Äî'),
      createStageItem('Joining date', formatDateDisplay(offer.joiningDate)),
      createStageItem('Status', offer.status || '‚Äî', { full: true })
    );
    return grid;
  }

  function buildRejectedDetails() {
    const reject = workingCard.rejectedInfo || {};
    const grid = createStageGrid();
    grid.append(
      createStageItem('Reason', reject.reason || 'No reason added yet.', { full: true, muted: !reject.reason }),
      createStageItem('Date', formatDateDisplay(reject.date))
    );
    return grid;
  }

  function readStageDetailsIntoState() {
    if (!workingCard) return;
    if (modalStage === 'research') {
      const resumeInput = document.getElementById('stage_resume');
      const savedInput = document.getElementById('stage_saved');
      if (resumeInput) workingCard.resumeVersion = resumeInput.value || 'Resume v1';
      if (savedInput && savedInput.value) {
        const d = new Date(savedInput.value);
        if (!Number.isNaN(d.getTime())) workingCard.savedAt = d.getTime();
      }
    } else if (modalStage === 'applied') {
      const dateInput = document.getElementById('stage_applied_date');
      const sourceInput = document.getElementById('stage_applied_source');
      if (dateInput) workingCard.appliedInfo.date = dateInput.value;
      if (sourceInput) workingCard.appliedInfo.source = sourceInput.value;
    } else if (modalStage === 'screening') {
      const repliedInput = document.getElementById('stage_screening_replied');
      const dueInput = document.getElementById('stage_assessment_due');
      const infoInput = document.getElementById('stage_info_shared');
      if (repliedInput) workingCard.screeningInfo.replied = repliedInput.checked;
      if (dueInput) workingCard.screeningInfo.assessmentDue = dueInput.value;
      if (infoInput) workingCard.screeningInfo.infoShared = infoInput.value;
    } else if (modalStage === 'interviewing') {
      const rounds = [];
      document.querySelectorAll('.stage-round').forEach(block => {
        const id = block.dataset.round || generateId('r');
        const [nameInput, dateInput] = block.querySelectorAll('input');
        const name = nameInput?.value.trim() || '';
        const datetime = dateInput?.value || '';
        if (name || datetime) rounds.push({ id, name, datetime });
      });
      workingCard.interviewingRounds = rounds;
    } else if (modalStage === 'offer') {
      const ctcInput = document.getElementById('stage_offer_ctc');
      const joinInput = document.getElementById('stage_offer_joining');
      const statusSelect = document.getElementById('stage_offer_status');
      if (ctcInput) workingCard.offerInfo.ctc = ctcInput.value;
      if (joinInput) workingCard.offerInfo.joiningDate = joinInput.value;
      if (statusSelect) workingCard.offerInfo.status = statusSelect.value;
    } else if (modalStage === 'rejected') {
      const reasonArea = document.getElementById('stage_reject_reason');
      const dateInput = document.getElementById('stage_reject_date');
      if (reasonArea) workingCard.rejectedInfo.reason = reasonArea.value;
      if (dateInput) workingCard.rejectedInfo.date = dateInput.value;
    }
  }

  function syncModalToState() {
    if (!workingCard) return null;
    workingCard.company = companyInput.value.trim();
    workingCard.role = roleInput.value.trim();
    workingCard.link = linkInput.value.trim();
    workingCard.deadline = deadlineInput.value;
    workingCard.notes = notesInput.value.trim();
    workingCard.jobDescription = jobDescEl.value.trim();
    readStageDetailsIntoState();
    return workingCard;
  }

  function sanitizeCard(raw, existing = {}) {
    const base = upgradeCard({ ...existing, ...raw });
    base.id = raw.id || existing.id || generateId('c');
    base.created_at = existing.created_at || raw.created_at || Date.now();
    base.questions = (raw.questions || []).map(q => ({ id: q.id || generateId('q'), prompt: q.prompt || '', answer: q.answer || '' }));
    return base;
  }

  function upsertCard() {
    const updated = syncModalToState();
    if (!updated) return;
    if (!updated.company || !updated.role) {
      notify('Please enter Company and Role', { variant: 'danger' });
      return;
    }
    if (editingCardId) {
      const located = locateCard(editingCardId);
      if (!located) {
        closeModal();
        return;
      }
      const merged = sanitizeCard({ ...updated, id: editingCardId }, located.card);
      board[located.col][located.idx] = merged;
    } else {
      const newCard = sanitizeCard({ ...updated, id: workingCard.id || generateId('c'), savedAt: updated.savedAt || Date.now() }, {});
      newCard.created_at = Date.now();
      board.research.unshift(newCard);
    }
    saveBoard();
    renderBoard();
    closeModal();
  }

  function markAsApplied() {
    if (!editingCardId) return;
    const located = locateCard(editingCardId);
    if (!located) return;
    syncModalToState();
    const merged = sanitizeCard({ ...workingCard, id: editingCardId }, located.card);
    board[located.col][located.idx] = merged;
    moveCard(editingCardId, 'applied');
    closeModal();
    notify('Application marked as Applied.', { variant: 'success' });
  }

  function deleteCard() {
    if (!editingCardId) {
      closeModal();
      return;
    }
    const located = locateCard(editingCardId);
    if (!located) {
      closeModal();
      return;
    }
    if (!confirm('Delete this application?')) return;
    board[located.col].splice(located.idx, 1);
    saveBoard();
    renderBoard();
    closeModal();
    notify('Application deleted.', { variant: 'success' });
  }

  function openChat() {
    chatDrawer.style.display = 'flex';
    chatDrawer.setAttribute('aria-hidden', 'false');
    renderChatHistory();
    setTimeout(() => chatInput.focus(), 100);
  }

  function closeChat() {
    chatDrawer.style.display = 'none';
    chatDrawer.setAttribute('aria-hidden', 'true');
  }

  function renderChatHistory() {
    chatBody.innerHTML = '';
    if (!chatHistory.length) {
      const note = document.createElement('div');
      note.className = 'stage-note';
      note.textContent = 'Ask the assistant to refine answers or prep for interviews.';
      chatBody.appendChild(note);
      return;
    }
    chatHistory.forEach(msg => {
      const bubble = document.createElement('div');
      bubble.className = `msg ${msg.role}`;
      bubble.textContent = msg.text;
      chatBody.appendChild(bubble);
    });
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function generateChatResponse(message) {
    const band = workingCard?.fit?.band;
    const score = workingCard?.fit?.score;
    const missing = workingCard?.fit?.missing || [];
    const focus = missing.length ? `Focus on strengthening ${missing.slice(0, 3).join(', ')}.` : 'Your fit looks solid ‚Äî emphasize your top achievements.';
    const keywords = extractKeywords(jobDescEl.value, 3).map(toTitle).join(', ');
    const jdTip = keywords ? `Highlight ${keywords} from the JD.` : '';
    return `Thanks for sharing! ${band ? `Current fit: ${band}${score != null ? ` (${score}%)` : ''}. ` : ''}${focus} ${jdTip}`.trim();
  }

  function sendChat() {
    const text = chatInput.value.trim();
    if (!text) return;
    chatHistory.push({ role: 'user', text });
    const reply = generateChatResponse(text);
    chatHistory.push({ role: 'ai', text: reply });
    chatInput.value = '';
    renderChatHistory();
  }

  async function deleteAccount() {
    menu.style.display = 'none';
    if (!confirm('This will permanently delete your JobSprint account and all saved data. Continue?')) {
      return;
    }
    if (!confirm('Are you absolutely sure? This action cannot be undone.')) {
      return;
    }

    let response;
    const deletingToast = notifyLoading('Deleting your account‚Ä¶');
    try {
      response = await fetch('/api/delete-user', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ token })
      });
    } catch (err) {
      console.error('delete account request failed', err);
      deletingToast?.dismiss?.();
      notify('Could not delete account. Please check your connection and try again.', { variant: 'danger' });
      return;
    }

    let payload = {};
    try {
      payload = await response.json();
    } catch (_) {
      payload = {};
    }

    if (!response.ok || !payload?.success) {
      const message = payload?.error
        ? `Could not delete account (${payload.error}).`
        : 'Could not delete account. Please try again.';
      deletingToast?.dismiss?.();
      notify(message, { variant: 'danger' });
      return;
    }

    deletingToast?.dismiss?.();
    clearLocalUserData();
    board = emptyBoard();
    renderBoard();
    reflectToday();
    notify('Your JobSprint account has been deleted. You can sign up again anytime to start fresh.', { variant: 'success' });
    redirectWithToast('/signup.html?mode=signup', 'Taking you to sign-up‚Ä¶');
  }

  document.getElementById('hamBtn').onclick = () => menu.style.display = (menu.style.display === 'block' ? 'none' : 'block');
  document.getElementById('exportBtn').onclick = e => {
    e.preventDefault();
    const blob = new Blob([JSON.stringify(board, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'jobsprint_board.json';
    a.click();
    URL.revokeObjectURL(url);
    menu.style.display = 'none';
    notify('Workspace exported ‚Äî check your downloads.', { variant: 'success', duration: 6000 });
  };
  document.getElementById('deleteAccountBtn').onclick = e => {
    e.preventDefault();
    deleteAccount();
  };
  document.getElementById('signoutBtn').onclick = e => {
    e.preventDefault();
    localStorage.removeItem('jobsprint_profile');
    notify('Signed out ‚Äî see you soon!', { variant: 'info', duration: 5200 });
    redirectWithToast('/signup.html?mode=login', 'Taking you to sign-in‚Ä¶');
  };

  document.getElementById('addBtn').onclick = openModalForNew;
  modalCloseBtn.onclick = closeModal;
  saveBtn.onclick = upsertCard;
  deleteBtn.onclick = deleteCard;
  markAppliedBtn.onclick = markAsApplied;
  analyzeFitBtn.onclick = analyzeFit;
  addQuestionBtn.onclick = addQuestionFromInput;
  questionInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addQuestionFromInput();
    }
  });
  openChatBtn.onclick = openChat;
  closeChatBtn.onclick = closeChat;
  chatSendBtn.onclick = sendChat;
  chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendChat();
    }
  });
  chatDrawer.addEventListener('click', e => {
    if (e.target === chatDrawer) closeChat();
  });

  document.getElementById('resetBtn').onclick = () => {
    if (!confirm('Reset board for this user?')) return;
    board = emptyBoard();
    saveBoard();
    renderBoard();
  };

  renderBoard();
  reflectToday();
</script>
</body>
</html>
