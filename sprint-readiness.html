<!-- After onboarding -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JobSprint • Sprint Readiness</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles/theme.css" />
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:'Inter',system-ui,-apple-system,'Segoe UI',sans-serif;color:var(--ink);background:transparent;min-height:100vh}
    .page{max-width:var(--shell-max-width,880px);margin:0 auto;padding:64px 24px 120px;position:relative}
    .floating-blob{position:fixed;border-radius:50%;background:rgba(13,110,253,0.14);filter:blur(0);animation:float 16s ease-in-out infinite;z-index:0;pointer-events:none}
    .floating-blob:nth-of-type(1){width:180px;height:180px;top:12vh;left:8vw;animation-delay:0s}
    .floating-blob:nth-of-type(2){width:130px;height:130px;bottom:12vh;right:12vw;animation-delay:-5s}
    .floating-blob:nth-of-type(3){width:100px;height:100px;top:52vh;right:24vw;animation-delay:-9s}
    @keyframes float{0%,100%{transform:translate3d(0,0,0)}50%{transform:translate3d(16px,-18px,0)}}
    .story-shell{position:relative;z-index:1;background:rgba(255,255,255,0.92);border-radius:28px;padding:44px;border:1px solid rgba(10,102,194,0.16);box-shadow:var(--shadow-sm);backdrop-filter:blur(12px)}
    @media(max-width:680px){.story-shell{padding:32px 22px;border-radius:24px}}
    .loading{display:flex;flex-direction:column;align-items:center;gap:18px;text-align:center}
    .loading h1{margin:0;font-size:26px;font-weight:700;color:var(--ink)}
    .loading p{margin:0;color:var(--muted);font-size:15px}
    .spinner{width:70px;height:70px;border-radius:50%;border:6px solid rgba(10,102,194,0.15);border-top-color:var(--brand);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .story{display:none;opacity:0;transition:opacity .6s ease}
    .story.visible{display:block;opacity:1}
    .stage{display:grid;gap:28px;position:relative;transition:opacity .4s ease,transform .4s ease}
    #ctcStage{gap:2px}
    .stage.hidden{display:none}
    h2.story-heading{margin:0;font-size:30px;font-weight:700;color:var(--ink)}
    p.story-paragraph{margin:18px 0 26px;color:var(--muted);font-size:16px;line-height:1.65}
    .ats-card{background:rgba(255,255,255,0.96);border-radius:22px;padding:28px;border:1px solid rgba(10,102,194,0.16);box-shadow:0 14px 36px rgba(10,102,194,0.16);display:grid;gap:18px}
    #act3{margin-top:48px}
    .ats-score{display:flex;align-items:baseline;gap:12px}
    .ats-score strong{font-size:42px;font-weight:700;color:var(--brand-strong)}
    .ats-score span{font-size:15px;color:var(--muted)}
    .ats-note{font-size:16px;font-weight:600;color:var(--brand-strong)}
    .ats-insights{border-radius:18px;background:rgba(13,110,253,0.06);padding:20px 22px;display:grid;gap:12px;border:1px solid rgba(13,110,253,0.1)}
    .ats-insights.hidden{display:none}
    .ats-insights__label{font-size:14px;font-weight:700;color:var(--brand-strong);text-transform:uppercase;letter-spacing:0.04em}
    .ats-insights__list{margin:0;padding:0 0 0 20px;color:var(--ink);font-size:14px;line-height:1.6}
    ul.ats-fixes{margin:0;padding:0 0 0 20px;color:var(--muted);font-size:14px;line-height:1.6}
    .actions-row{display:flex;flex-wrap:wrap;gap:14px;align-items:center}
    .btn-primary{background:linear-gradient(135deg,var(--brand),var(--brand-accent));color:#fff;border:none;border-radius:14px;padding:12px 22px;font-weight:600;font-size:15px;cursor:pointer;box-shadow:var(--shadow-sm);transition:transform .2s ease,box-shadow .2s ease}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 18px 34px rgba(10,102,194,0.22)}
    .btn-secondary{background:rgba(255,255,255,0.92);color:var(--brand-strong);border:1px solid rgba(13,110,253,0.32);border-radius:14px;padding:12px 22px;font-weight:600;font-size:15px;cursor:pointer;box-shadow:var(--shadow-xs,0 12px 28px rgba(10,102,194,0.08));transition:background .2s ease,border-color .2s ease,transform .2s ease}
    .btn-secondary:hover{background:rgba(13,110,253,0.06);border-color:rgba(13,110,253,0.48);transform:translateY(-1px)}
    .btn-text{background:none;border:none;color:var(--brand-strong);font-weight:600;font-size:15px;cursor:pointer;padding:10px 12px 10px 4px}
    .btn-text:hover{text-decoration:underline}
    .whisper{margin-top:6px;font-size:13px;color:var(--muted)}
    .visual-placeholder{margin:32px 0 18px;background:linear-gradient(135deg,rgba(228,239,255,0.9),rgba(204,227,255,0.68));border-radius:20px;padding:26px;border:1px dashed rgba(13,110,253,0.28);color:var(--brand-strong);font-size:15px;line-height:1.6;box-shadow:inset 0 0 0 1px rgba(13,110,253,0.12)}
    .soft-divider{height:56px;display:grid;place-items:center}
    .soft-divider::before{content:"";width:180px;height:1px;background:linear-gradient(90deg,rgba(13,110,253,0),rgba(13,110,253,0.45),rgba(13,110,253,0));opacity:0.8}
    .salary-callout{background:rgba(255,255,255,0.95);border-radius:22px;padding:26px;border:1px solid rgba(10,102,194,0.16);box-shadow:0 16px 40px rgba(10,102,194,0.14);display:grid;gap:14px}
    .salary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px}
    .salary-item{background:rgba(228,239,255,0.6);border-radius:16px;padding:18px;border:1px solid rgba(13,110,253,0.18)}
    .salary-item strong{display:block;font-size:16px;margin-bottom:6px;color:var(--brand-strong)}
    .closing-line{margin:32px 0 38px;font-size:18px;font-weight:600;color:var(--ink)}
    .final-cta{display:flex;justify-content:center}
    .hidden-input{position:absolute;opacity:0;pointer-events:none;width:0;height:0}
    .stage-actions{display:flex;justify-content:flex-end}
    .stage-nav{display:flex;justify-content:flex-start;align-items:center}
    .stage-nav .btn-text{padding:4px 12px 4px 0;width:auto}
    @media(max-width:520px){.actions-row{flex-direction:column;align-items:stretch}.btn-primary,.btn-secondary,.btn-text{text-align:center;width:100%}.stage-actions{justify-content:flex-start}.stage-nav{justify-content:flex-start}.stage-nav .btn-text{text-align:left;width:auto}}
    @media(prefers-reduced-motion:no-preference){.stage{opacity:0;transform:translateY(16px)}.stage:not(.hidden){opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <header class="app-navbar" role="banner">
    <a class="app-navbar__logo" href="index.html">
      <img src="logo.png" alt="JobSprint logo" loading="lazy" />
    </a>
    <nav class="app-navbar__nav" aria-label="Primary navigation"></nav>
  </header>
  <div class="floating-blob"></div>
  <div class="floating-blob"></div>
  <div class="floating-blob"></div>
  <main class="page">
    <article class="story-shell">
      <section class="loading" id="loadingState" aria-live="polite">
        <div class="spinner" role="presentation"></div>
        <h1>Analyzing your resume…</h1>
        <p>Hang tight, we’re preparing your sprint summary.</p>
      </section>

      <section class="story" id="storyState" aria-hidden="true">
        <section id="resumeStage" class="stage" aria-hidden="false">
          <header>
            <h2 class="story-heading">Let’s see how ready your resume is to sprint.</h2>
            <p class="story-paragraph">We’ve gone through your resume line by line to see how easily a recruiter or an ATS can understand your story.</p>
          </header>

          <div class="ats-card" id="atsCard">
            <div class="ats-score">
              <strong id="atsScore">—</strong>
              <span id="atsLevel">Loading insights…</span>
            </div>
            <div class="ats-note" id="atsNote">Good structure, but could use a little polish.</div>
            <ul class="ats-fixes" id="atsFixes"></ul>
            <div class="ats-insights hidden" id="atsInsightsContainer" aria-live="polite">
              <div class="ats-insights__label">Resume recommendations</div>
              <ul class="ats-insights__list" id="atsInsights"></ul>
            </div>
            <div class="actions-row">
              <button class="btn-secondary" id="uploadResumeBtn" type="button">Upload Updated Resume</button>
            </div>
            <div class="whisper" id="uploadStatus"></div>
          </div>

          <input type="file" class="hidden-input" id="resumeInput" accept=".pdf,.doc,.docx" />

          <div class="stage-actions">
            <button class="btn-primary" id="resumeNext" type="button">Next</button>
          </div>
        </section>

        <section id="ctcStage" class="stage hidden" aria-hidden="true">
          <div class="stage-nav">
            <button class="btn-text" id="resumeBack" type="button">← Back</button>
          </div>
          <section id="act3">
            <p class="story-paragraph" style="margin-top:0;">Before we continue, one last thing… let’s talk about your next milestone.</p>
            <p class="story-paragraph">Based on what you’ve shared — your role, experience, and current package — here’s what people like you typically achieve when they switch.</p>
            <div class="salary-callout">
              <div class="salary-grid">
                <div class="salary-item">
                  <strong>Your current CTC</strong>
                  <span id="currentCTC">₹9 LPA</span>
                </div>
                <div class="salary-item">
                  <strong>Next realistic CTC</strong>
                  <span id="nextCTC">₹11 – ₹13 LPA</span>
                </div>
                <div class="salary-item">
                  <strong>Typical hike</strong>
                  <span id="hikeRange">30–45%</span>
                </div>
              </div>
              <p class="whisper" id="salaryNote">Based on your experience and role, this is a realistic target for your next switch.</p>
            </div>
            <div class="closing-line">You’re ready to start your sprint. Let’s build momentum from day one.</div>
          </section>

          <div class="final-cta">
            <button class="btn-primary" id="continueBtn">Continue to Workspace</button>
          </div>
        </section>
      </section>
    </article>
  </main>

  <script src="scripts/theme.js"></script>
  <script src="scripts/ats-scorer.js"></script>
  <script>
    const LOADING_DELAY_MS = 1400;
    const DEFAULT_LOADING_HEADLINE = "Analyzing your resume…";
    const DEFAULT_LOADING_SUBTEXT = "Hang tight, we’re preparing your sprint summary.";

    const notify = (message, options) => {
      if (window.JobSprintUI && typeof window.JobSprintUI.showToast === 'function') {
        return window.JobSprintUI.showToast(message, options || {});
      }
      return null;
    };

    const notifyLoading = (message, options) => {
      if (window.JobSprintUI && typeof window.JobSprintUI.showLoadingToast === 'function') {
        return window.JobSprintUI.showLoadingToast(message, options || {});
      }
      return null;
    };

    const redirectWithToast = (url, message) => {
      const toast = notifyLoading(message || 'Redirecting…');
      setTimeout(() => {
        toast?.update?.('Almost there…');
        window.location.href = url;
      }, 180);
    };

    const readStoredProfile = () => {
      try {
        const raw = localStorage.getItem("jobsprint_profile");
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === "object" ? parsed : {};
      } catch (err) {
        console.warn("Could not parse stored profile", err);
        return {};
      }
    };

    const writeStoredProfile = (profile) => {
      try {
        const nextProfile = profile && typeof profile === "object" ? { ...profile } : {};
        const existing = readStoredProfile();
        const hasResumeText =
          Object.prototype.hasOwnProperty.call(nextProfile, "resume_text") && nextProfile.resume_text !== undefined;
        if (!hasResumeText && existing && typeof existing.resume_text === "string") {
          nextProfile.resume_text = existing.resume_text;
        }
        localStorage.setItem("jobsprint_profile", JSON.stringify(nextProfile));
      } catch (err) {
        console.warn("Could not persist profile", err);
      }
    };

    const sanitizeResumeTextForStorage = (text, maxLength = 60000) => {
      if (!text) return "";
      const cleaned = String(text)
        .replace(/\r\n?/g, "\n")
        .replace(/\u00A0/g, " ")
        .split("\n")
        .map((line) => line.replace(/\s+/g, " ").trim())
        .filter(Boolean)
        .join("\n")
        .trim();
      if (cleaned.length <= maxLength) return cleaned;
      return `${cleaned.slice(0, maxLength - 1).trimEnd()}…`;
    };

    const getStoredToken = () => {
      const stored = readStoredProfile();
      const token = stored?.token;
      if (typeof token === "string" && token.trim()) {
        return token.trim();
      }
      return null;
    };

    const params = new URLSearchParams(window.location.search);
    const tokenParam = params.get("u");
    if (tokenParam) {
      const existingProfile = readStoredProfile();
      if (existingProfile.token !== tokenParam) {
        writeStoredProfile({ ...existingProfile, token: tokenParam });
      }
    }

    const FALLBACK_ATS_DIAGNOSTIC = {
      score: 78,
      level: "good",
      fixes: [
        "Add clear 'Work Experience' and 'Education' headers.",
        "Reduce resume length to 1–2 pages.",
        "Avoid using tables or columns that confuse ATS scanners."
      ],
      topSuggestion: "Add clear 'Work Experience' and 'Education' headers.",
      coachNote: "Good structure — a quick tune-up will make it shine.",
      fingerprint: null,
      breakdown: null
    };

    const computeFingerprint = (text) => {
      if (!text) return null;
      const clean = String(text).replace(/\s+/g, " ").trim();
      return clean ? `${clean.length}:${clean.slice(0, 120).toLowerCase()}` : null;
    };

    const cloneDiagnostic = (diagnostic) => {
      if (!diagnostic || typeof diagnostic !== "object") return null;
      try {
        return JSON.parse(JSON.stringify(diagnostic));
      } catch (err) {
        console.warn("Could not clone diagnostic", err);
        return { ...diagnostic };
      }
    };

    const analyzeResumeWithFallback = (profile, fingerprint) => {
      const resumeText = typeof profile?.resume_text === "string" ? profile.resume_text : "";
      const role = profile?.role || profile?.target_role;
      if (window.JobSprintATS && typeof window.JobSprintATS.analyzeResume === "function") {
        try {
          return window.JobSprintATS.analyzeResume({
            text: resumeText,
            role,
            experience: profile?.experience,
            location: profile?.city
          });
        } catch (err) {
          console.warn("ATS analysis failed", err);
        }
      }
      const fallback = cloneDiagnostic(FALLBACK_ATS_DIAGNOSTIC) || { ...FALLBACK_ATS_DIAGNOSTIC };
      fallback.fingerprint = fingerprint ?? fallback.fingerprint ?? null;
      return fallback;
    };

    const persistDiagnostic = (profile, diagnostic) => {
      const safeProfile = profile && typeof profile === "object" ? { ...profile } : {};
      if (!diagnostic || typeof diagnostic !== "object") {
        return safeProfile;
      }
      const storedDiagnostic = cloneDiagnostic(diagnostic);
      const nextProfile = {
        ...safeProfile,
        ats_readiness: storedDiagnostic.score,
        top_suggestion: storedDiagnostic.topSuggestion || storedDiagnostic.fixes?.[0] || safeProfile.top_suggestion,
        ats_diagnostic: storedDiagnostic
      };
      writeStoredProfile(nextProfile);
      return nextProfile;
    };

    const ensureDiagnostic = (profile, options = {}) => {
      const { forceRecompute = false } = options || {};
      const baseProfile = profile && typeof profile === "object" ? { ...profile } : {};
      const resumeText = typeof baseProfile.resume_text === "string" ? baseProfile.resume_text : "";
      const fingerprint = computeFingerprint(resumeText);
      let diagnostic = baseProfile.ats_diagnostic;
      const needsRecompute =
        forceRecompute ||
        !diagnostic ||
        typeof diagnostic.score !== "number" ||
        (fingerprint && diagnostic.fingerprint !== fingerprint);
      if (needsRecompute) {
        diagnostic = analyzeResumeWithFallback(baseProfile, fingerprint);
      }
      if (diagnostic && fingerprint && !diagnostic.fingerprint) {
        diagnostic.fingerprint = fingerprint;
      }
      if (!diagnostic) {
        diagnostic = analyzeResumeWithFallback(baseProfile, fingerprint);
      }
      const updatedProfile = persistDiagnostic(baseProfile, diagnostic);
      return { profile: updatedProfile, diagnostic };
    };

    const formatList = (items) => {
      if (!Array.isArray(items) || !items.length) return "";
      const filtered = items.filter(Boolean);
      if (!filtered.length) return "";
      if (filtered.length === 1) return filtered[0];
      if (filtered.length === 2) return `${filtered[0]} and ${filtered[1]}`;
      return `${filtered.slice(0, -1).join(", ")}, and ${filtered[filtered.length - 1]}`;
    };

    const humanizeLabel = (label) => {
      if (!label) return "";
      return String(label)
        .replace(/[_-]+/g, " ")
        .replace(/\b\w/g, (char) => char.toUpperCase());
    };

    const buildResumeInsights = (diagnostic) => {
      const insights = [];
      if (!diagnostic || typeof diagnostic !== "object") {
        return insights;
      }
      const breakdown = diagnostic.breakdown || {};

      const missingSections = breakdown.sections?.missingRequired || [];
      if (Array.isArray(missingSections) && missingSections.length) {
        const readable = missingSections.map((section) => humanizeLabel(section));
        insights.push(`Add a dedicated ${formatList(readable)} section so recruiters can verify your foundation instantly.`);
      }

      const keywordData = breakdown.keywords || {};
      const missingRequiredKeywords = keywordData.missingRequired || [];
      if (Array.isArray(missingRequiredKeywords) && missingRequiredKeywords.length) {
        const keywords = missingRequiredKeywords.slice(0, 3).map((word) => `“${word}”`);
        insights.push(`We couldn't spot ${formatList(keywords)} — weave them into impact bullets to mirror the JD.`);
      } else if (Array.isArray(keywordData.missingNice) && keywordData.missingNice.length) {
        const niceToHave = keywordData.missingNice.slice(0, 3).map((word) => `“${word}”`);
        insights.push(`Add flavour keywords like ${formatList(niceToHave)} to edge ahead of similar profiles.`);
      }

      const bulletsData = breakdown.bullets || {};
      if (typeof bulletsData.bulletCount === "number" && bulletsData.bulletCount < 10) {
        insights.push(`Only ${bulletsData.bulletCount} bullet points detected — add crisp bullets under each role to spotlight achievements.`);
      }

      if (typeof bulletsData.actionVerbCoverage === "number" && bulletsData.actionVerbCoverage < 55) {
        const coverage = Math.round(bulletsData.actionVerbCoverage);
        insights.push(`Action verbs kick off about ${coverage}% of bullets — start lines with verbs like “Delivered” or “Built”.`);
      }

      const contactData = breakdown.contact || {};
      const missingContactBits = [];
      if (!contactData.hasEmail) missingContactBits.push("email address");
      if (!contactData.hasPhone) missingContactBits.push("phone number");
      if (!contactData.hasLinkedIn) missingContactBits.push("LinkedIn");
      if (!contactData.hasPortfolio) missingContactBits.push("portfolio link");
      if (missingContactBits.length) {
        insights.push(`Add your ${formatList(missingContactBits)} up top so hiring managers can reach you instantly.`);
      }

      const readabilityData = breakdown.readability || {};
      if (typeof readabilityData.avgSentenceLength === "number" && readabilityData.avgSentenceLength > 22) {
        const average = Number(readabilityData.avgSentenceLength.toFixed(1));
        insights.push(`Sentences average ${average} words — tighten them to keep scans breezy.`);
      }

      return insights.slice(0, 4);
    };

    const toggleLoadingState = ({ show, headline, subtext } = {}) => {
      const loading = document.getElementById("loadingState");
      const story = document.getElementById("storyState");
      if (loading) {
        const headingEl = loading.querySelector("h1");
        const subtextEl = loading.querySelector("p");
        if (show) {
          loading.style.display = "flex";
          if (headingEl) headingEl.textContent = headline || DEFAULT_LOADING_HEADLINE;
          if (subtextEl) subtextEl.textContent = subtext ?? DEFAULT_LOADING_SUBTEXT;
        } else {
          loading.style.display = "none";
          if (headingEl) headingEl.textContent = DEFAULT_LOADING_HEADLINE;
          if (subtextEl) subtextEl.textContent = DEFAULT_LOADING_SUBTEXT;
        }
      }
      if (story) {
        if (show) {
          story.classList.remove("visible");
          story.setAttribute("aria-hidden", "true");
        } else {
          story.classList.add("visible");
          story.setAttribute("aria-hidden", "false");
        }
      }
    };

    function getSalaryInsight({ currentCTC, yearsExp, roleId, location }) {
      return {
        suggestedRange: "₹11L – ₹13.5L",
        hikePercent: "30–45%",
        note: "Based on your experience and role, this is a realistic target for your next switch."
      };
    }

    function formatCTC(ctc) {
      if (ctc === null || ctc === undefined || ctc === "") return "₹9 LPA";
      if (typeof ctc === "number" && Number.isFinite(ctc)) {
        return `₹${ctc.toLocaleString("en-IN")} LPA`;
      }
      const trimmed = String(ctc).trim();
      if (!trimmed) return "₹9 LPA";
      const digitsOnly = trimmed.replace(/\D+/g, "");
      if (digitsOnly) {
        const numeric = Number.parseInt(digitsOnly, 10);
        if (Number.isFinite(numeric)) {
          return `₹${numeric.toLocaleString("en-IN")} LPA`;
        }
      }
      if (!trimmed.includes("₹")) {
        return `₹${trimmed}`;
      }
      return trimmed;
    }

    function normalizeCurrentCTCValue(value) {
      if (value === null || value === undefined || value === '') return undefined;
      if (typeof value === 'number' && Number.isFinite(value)) return Math.trunc(value);
      const digits = String(value).trim().replace(/\D+/g, '');
      if (!digits) return undefined;
      const numeric = Number.parseInt(digits, 10);
      return Number.isFinite(numeric) ? numeric : undefined;
    }

    function resolveCurrentCTC(profile) {
      if (!profile || typeof profile !== "object") return undefined;

      const direct = normalizeCurrentCTCValue(profile.current_ctc ?? profile.currentCTC);
      if (direct !== undefined) {
        return direct;
      }

      const story = profile.career_story;
      const normalizeStory = (value) => {
        if (!value) return null;
        if (typeof value === "object") return value;
        if (typeof value === "string") {
          const trimmed = value.trim();
          if (!trimmed) return null;
          try {
            const parsed = JSON.parse(trimmed);
            if (parsed && typeof parsed === "object") return parsed;
          } catch (_) {
            return { narrative: trimmed };
          }
          return null;
        }
        return null;
      };

      const storyObject = normalizeStory(story);
      if (!storyObject || typeof storyObject !== "object") return undefined;

      const storyDirect = normalizeCurrentCTCValue(storyObject.current_ctc ?? storyObject.currentCTC);
      if (storyDirect !== undefined) {
        return storyDirect;
      }

      const comp = storyObject.compensation;
      if (comp && typeof comp === "object") {
        const options = [comp.current, comp.current_ctc, comp.currentCTC, comp.current_salary, comp.currentSalary];
        for (const value of options) {
          const normalized = normalizeCurrentCTCValue(value);
          if (normalized !== undefined) {
            return normalized;
          }
        }
      }

      return undefined;
    }

    function revealStory() {
      toggleLoadingState({ show: false });
    }

    function hydrateStory(options = {}) {
      const { forceRecompute = false } = options || {};
      const storedProfile = readStoredProfile();
      const { profile: enrichedProfile, diagnostic } = ensureDiagnostic(storedProfile, { forceRecompute });
      const profile = enrichedProfile || storedProfile || {};
      const effectiveDiagnostic = diagnostic || analyzeResumeWithFallback(profile, computeFingerprint(profile?.resume_text || ""));
      const atsScoreEl = document.getElementById("atsScore");
      const atsLevelEl = document.getElementById("atsLevel");
      const atsFixesEl = document.getElementById("atsFixes");
      const atsNoteEl = document.getElementById("atsNote");
      const insightsContainer = document.getElementById("atsInsightsContainer");
      const insightsList = document.getElementById("atsInsights");
      if (atsScoreEl) {
        const scoreValue = typeof effectiveDiagnostic?.score === "number" ? Math.round(effectiveDiagnostic.score) : FALLBACK_ATS_DIAGNOSTIC.score;
        atsScoreEl.textContent = `${scoreValue} / 100`;
      }
      if (atsLevelEl) {
        const levelMessages = {
          great: "ATS-friendliness: Crystal clear and recruiter-ready.",
          good: "ATS-friendliness: Good structure, just needs a little polish.",
          average: "ATS-friendliness: Promising — we can sharpen it more.",
          poor: "ATS-friendliness: Let’s rebuild it together, one win at a time."
        };
        atsLevelEl.textContent = levelMessages[effectiveDiagnostic?.level] || "ATS-friendliness: Here’s how it scored.";
      }
      if (atsFixesEl) {
        atsFixesEl.innerHTML = "";
        (effectiveDiagnostic?.fixes || FALLBACK_ATS_DIAGNOSTIC.fixes).forEach((tip) => {
          const li = document.createElement("li");
          li.textContent = tip;
          atsFixesEl.appendChild(li);
        });
      }
      if (atsNoteEl) {
        atsNoteEl.textContent = effectiveDiagnostic?.coachNote || FALLBACK_ATS_DIAGNOSTIC.coachNote || "Good structure, but could use a little polish.";
      }

      if (insightsContainer && insightsList) {
        insightsList.innerHTML = "";
        const insights = buildResumeInsights(effectiveDiagnostic);
        if (insights.length) {
          insightsContainer.classList.remove("hidden");
          insights.forEach((insight) => {
            const item = document.createElement("li");
            item.textContent = insight;
            insightsList.appendChild(item);
          });
        } else {
          insightsContainer.classList.add("hidden");
        }
      }

      const preferredCitiesRaw = Array.isArray(profile?.preferred_cities)
        ? profile.preferred_cities.filter((city) => typeof city === 'string' && city.trim())
        : typeof profile?.city === 'string' && profile.city.trim()
        ? [profile.city.trim()]
        : [];
      const preferredCities = preferredCitiesRaw.map((city) => city.trim());
      const primaryLocationPreference = preferredCities[0] || null;

      const currentCTC = resolveCurrentCTC(profile);
      const salaryData = getSalaryInsight({
        currentCTC,
        yearsExp: profile.experience,
        roleId: profile.role,
        location: primaryLocationPreference
      });

      const currentCTCEl = document.getElementById("currentCTC");
      const nextCTCEl = document.getElementById("nextCTC");
      const hikeRangeEl = document.getElementById("hikeRange");
      const salaryNoteEl = document.getElementById("salaryNote");

      if (currentCTCEl) currentCTCEl.textContent = formatCTC(currentCTC);
      if (nextCTCEl) nextCTCEl.textContent = salaryData.suggestedRange || "₹11 – ₹13 LPA";
      if (hikeRangeEl) hikeRangeEl.textContent = salaryData.hikePercent || "30–45%";
      if (salaryNoteEl) salaryNoteEl.textContent = salaryData.note || "Based on your experience and role, this is a realistic target for your next switch.";

      return { profile, diagnostic: effectiveDiagnostic };
    }

    window.addEventListener("DOMContentLoaded", () => {
      hydrateStory();
      setTimeout(revealStory, LOADING_DELAY_MS);

      const uploadBtn = document.getElementById("uploadResumeBtn");
      const resumeInput = document.getElementById("resumeInput");
      const uploadStatus = document.getElementById("uploadStatus");
      const readFileAsText = (file) => {
        if (!file) return Promise.resolve("");
        if (typeof file.text === "function") {
          return file.text();
        }
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            resolve(typeof reader.result === "string" ? reader.result : "");
          };
          reader.onerror = () => reject(reader.error || new Error("Could not read file"));
          reader.readAsText(file);
        });
      };

      const handleResumeUpload = async (file) => {
        if (!file) return;
        toggleLoadingState({
          show: true,
          headline: "Analyzing your updated resume…",
          subtext: "We’re refreshing your ATS score with the latest file."
        });
        try {
          if (uploadStatus) {
            uploadStatus.textContent = `Uploading ${file.name}…`;
          }

          const text = await readFileAsText(file);
          if (!text || !text.trim()) {
            throw new Error("Empty resume content");
          }
          const fallbackSanitized = sanitizeResumeTextForStorage(text);

          const existingProfile = readStoredProfile();
          const previousResumeUrl = existingProfile?.resume_url || existingProfile?.resumeUrl || null;
          const googleId = existingProfile?.google_id || existingProfile?.googleId || null;
          const storedEmail = existingProfile?.email || existingProfile?.user_email || existingProfile?.primary_email || null;
          const paramEmail = params.get("email");
          const identityEmail = storedEmail || (paramEmail ? paramEmail.trim() : "");

          const formData = new FormData();
          formData.append("file", file);
          if (googleId) {
            formData.append("google_id", googleId);
          }
          if (identityEmail) {
            formData.append("email", identityEmail);
          }

          let parseData = null;
          let parseErrorMessage = "";
          try {
            const response = await fetch("/api/parse-resume", {
              method: "POST",
              body: formData
            });
            const payload = await response.json().catch(() => ({}));
            if (!response.ok || !payload?.success) {
              parseErrorMessage = payload?.detail || payload?.error || "Unable to parse resume.";
            } else {
              parseData = payload;
            }
          } catch (parseErr) {
            parseErrorMessage = parseErr?.message || "Unable to parse resume.";
          }

          const sanitizedText = parseData?.raw_text && String(parseData.raw_text).trim()
            ? String(parseData.raw_text)
            : fallbackSanitized;
          if (!sanitizedText) {
            throw new Error(parseErrorMessage || "We couldn't read resume text from this file.");
          }

          const resumeMeta = parseData?.resume && typeof parseData.resume === "object" ? { ...parseData.resume } : null;
          const resumeUrlCandidate = resumeMeta?.public_url || resumeMeta?.path || null;

          const updatedProfile = {
            ...(existingProfile && typeof existingProfile === "object" ? existingProfile : {}),
            resume_text: sanitizedText,
            resume_file_name: file.name,
            resume_last_uploaded_at: new Date().toISOString()
          };
          if (resumeMeta) {
            updatedProfile.resume_metadata = resumeMeta;
          }
          if (resumeUrlCandidate) {
            updatedProfile.resume_url = resumeUrlCandidate;
          }
          writeStoredProfile(updatedProfile);

          if (parseErrorMessage) {
            notify(`Couldn't sync resume to onboarding. ${parseErrorMessage}`.trim(), { variant: 'warning' });
          }

          const { diagnostic } = hydrateStory({ forceRecompute: true });
          const refreshedScore = typeof diagnostic?.score === "number" ? `${Math.round(diagnostic.score)} / 100` : null;
          let statusMessage = refreshedScore
            ? `ATS score refreshed to ${refreshedScore}.`
            : `Your ATS insights are up to date.`;

          let syncAttempted = false;
          let syncSucceeded = false;
          let syncErrorMessage = "";

          if (!parseErrorMessage && resumeUrlCandidate && resumeUrlCandidate !== previousResumeUrl) {
            if (googleId && identityEmail) {
              syncAttempted = true;
              try {
                const syncResponse = await fetch("/api/create-user", {
                  method: "POST",
                  headers: { "content-type": "application/json" },
                  body: JSON.stringify({
                    google_id: googleId,
                    email: identityEmail,
                    resume_url: resumeUrlCandidate,
                    allow_payment_pending: true
                  })
                });
                if (!syncResponse.ok) {
                  const errorPayload = await syncResponse.json().catch(() => ({}));
                  const reason = errorPayload?.message || errorPayload?.error || "Please try again.";
                  throw new Error(reason);
                }
                syncSucceeded = true;
                notify("Resume synced to onboarding workspace.", { variant: 'success' });
              } catch (syncErr) {
                syncErrorMessage = syncErr?.message || "Unable to sync resume.";
                notify(`Couldn't sync resume to onboarding. ${syncErrorMessage}`.trim(), { variant: 'warning' });
              }
            } else {
              syncErrorMessage = "Sign in to sync resume to onboarding.";
            }
          }

          if (resumeUrlCandidate) {
            if (syncSucceeded) {
              statusMessage = `${statusMessage} Resume synced to onboarding workspace.`;
            } else if (syncAttempted || syncErrorMessage) {
              statusMessage = `${statusMessage} Couldn't sync resume to onboarding${
                syncErrorMessage ? ` — ${syncErrorMessage}` : ''
              }.`;
            } else if (!parseErrorMessage) {
              statusMessage = `${statusMessage} Resume already synced to onboarding.`;
            } else {
              statusMessage = `${statusMessage} Resume stored locally.`;
            }
          } else if (parseData?.success) {
            statusMessage = `${statusMessage} Resume stored locally.`;
          } else if (parseErrorMessage) {
            statusMessage = `${statusMessage} Couldn't sync resume to onboarding.`;
          }

          if (uploadStatus) {
            uploadStatus.textContent = statusMessage;
          }

          notify(
            refreshedScore ? `ATS score refreshed (${refreshedScore}).` : 'ATS score refreshed.',
            { variant: 'success' }
          );
        } catch (err) {
          console.warn("Could not process uploaded resume", err);
          const errorMessage = `We couldn't read ${file.name}. Try uploading a text-based or PDF resume.`;
          if (uploadStatus) {
            uploadStatus.textContent = errorMessage;
          }
          notify(errorMessage, { variant: 'error' });
        } finally {
          if (resumeInput) {
            resumeInput.value = "";
          }
          setTimeout(() => {
            toggleLoadingState({ show: false });
          }, Math.min(LOADING_DELAY_MS, 800));
        }
      };

      uploadBtn?.addEventListener("click", () => {
        resumeInput?.click();
      });
      resumeInput?.addEventListener("change", (event) => {
        const file = event.target?.files?.[0];
        if (!file) return;
        handleResumeUpload(file);
      });

      const resumeStage = document.getElementById("resumeStage");
      const ctcStage = document.getElementById("ctcStage");
      const resumeNext = document.getElementById("resumeNext");
      const resumeBack = document.getElementById("resumeBack");

      const showStage = (stageToShow) => {
        if (!stageToShow) return;
        const stages = [resumeStage, ctcStage];
        stages.forEach((stage) => {
          if (!stage) return;
          const isActive = stage === stageToShow;
          stage.classList.toggle("hidden", !isActive);
          stage.setAttribute("aria-hidden", isActive ? "false" : "true");
        });
        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      resumeNext?.addEventListener("click", () => {
        showStage(ctcStage);
      });

      resumeBack?.addEventListener("click", () => {
        showStage(resumeStage);
      });

      const continueBtn = document.getElementById("continueBtn");
      continueBtn?.addEventListener("click", () => {
        try {
          localStorage.setItem("jobsprint_readiness_seen", new Date().toISOString());
        } catch (err) {
          console.warn("Could not mark readiness screen as seen", err);
        }
        const token = tokenParam || getStoredToken();
        const destination = token ? `/workspace.html?u=${encodeURIComponent(token)}` : "/workspace.html";
        redirectWithToast(destination, 'Opening your workspace…');
      });
    });
  </script>
</body>
</html>
